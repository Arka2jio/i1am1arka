(function(aH,br){function e(df,dj){e.__superclass__.call(this,df,dj);e.m_chtFont=new BitmapFont("/chtFont");if(GLLibConfiguration.tnb_enable){Billing.setListenner(a7);if(Billing.isUseSpecificRule(3)){for(var di=0;di<C.length;di++){if(C[di][f.STATE]==STATE.MENU_TNB_MAIN||C[di][f.STATE]==STATE.POPUP_TNB_DEMO){var dh=C[di];var dg=dh[f.CHILD_INDEXES];dh[f.CHILD_INDEXES]=dh[f.CHILD_INDEXES+1];dh[f.CHILD_INDEXES+1]=dg}}}}}LowAPI.extendClass(e,GLLib);function a7(df){if(!e.bIsTnBPopup){e.bIsTnBPopup=true}switch(df){case Billing.ERR_CODE__GAME_UNLOCK_SUCCESS:e.goToMenuById(STATE.POPUP_TNB_UNLOCK_SUCCESS,bF.REMOVE_PARENT);a3="";i="";e.RMS_Save();break;case Billing.ERR_CODE__GAME_UNLOCK_FAILED:e.bIsBillingFailed=true;e.RMS_Save();if(e.currentTrials==0){e.goToMenuById(STATE.POPUP_TNB_LIMIT,bF.RESET_ALL_MENU)}else{e.goToMenuById(STATE.POPUP_TNB_UNLOCK_FAILED,bF.REMOVE_PARENT)}break;case Billing.ERR_CODE__BILLING_NOT_AVAILABLE:e.goToMenuById(STATE.POPUP_TNB_PROBLEM,bF.REMOVE_PARENT|bF.OVERRIDE_PREV_MENU);break;case Billing.ERR_CODE__UNLOCK_CODE_FAILED:e.goToMenuById(STATE.POPUP_TNB_UNLOCK_CODE_FAILED,bF.REMOVE_PARENT);break;case Billing.ERR_CODE__BILLING_INIT_DONE:e.goToMenuById(STATE.POPUP_TNB_CONFIRM,bF.REMOVE_PARENT);a3=Billing.getBuyString().trim().replace(/<br>/g,"\n");break}}var cj={};cj.LANGUAGE=0;cj.SOUND_ENABLED=cj.LANGUAGE+1;cj.SOUND_LEVEL=cj.SOUND_ENABLED+1;cj.GAME_PROGRESS=cj.SOUND_LEVEL+1;cj.LEVEL_INDEX=cj.GAME_PROGRESS+1;cj.LEVEL_INFO_STRAT=cj.LEVEL_INDEX+1;cj.LEVEL_INFO_NUM=28;cj.LEVEL_FINAL_INFO1=cj.LEVEL_INFO_STRAT+cj.LEVEL_INFO_NUM;cj.LEVEL_FINAL_INFO2=cj.LEVEL_FINAL_INFO1+1;cj.PLAYER_INFO_STRAT=cj.LEVEL_FINAL_INFO2+1;cj.PLAYER_INFO_NUM=5;cj.TNB_TRIALS=cj.PLAYER_INFO_STRAT+cj.PLAYER_INFO_NUM;cj.TNB_BILLING_FAILED=cj.TNB_TRIALS+1;cj.LEVEL_STAR_INFO_START=cj.TNB_BILLING_FAILED+1;cj.LEVEL_STAR_INFO_NUM=DAI.LEVELS_NUM_MAX*DAI.STAR_INFO_SIZE;cj.LEVEL_TOTAL_SCORE_START=cj.LEVEL_STAR_INFO_START+cj.LEVEL_STAR_INFO_NUM*2;cj.LEVEL_TOTAL_SCORE_NUM=DAI.LEVELS_NUM_MAX;cj.SIZE=cj.LEVEL_TOTAL_SCORE_START+cj.LEVEL_TOTAL_SCORE_NUM*4;window.STATE={};STATE.QUIT=-1;STATE.INIT=STATE.QUIT+1;STATE.SELECT_LANGUAGE_INIT=STATE.INIT+1;STATE.SELECT_LANGUAGE=STATE.SELECT_LANGUAGE_INIT+1;STATE.GAMELOFT_LOGO=STATE.SELECT_LANGUAGE+1;STATE.COPYRIGHT=STATE.GAMELOFT_LOGO+1;STATE.ASK_SOUND=STATE.COPYRIGHT+1;STATE.SPLASH=STATE.ASK_SOUND+1;STATE.MENU_MAIN=STATE.SPLASH+1;STATE.MENU_NEW_GAME=STATE.MENU_MAIN+1;STATE.CONTINUE_GAME=STATE.MENU_NEW_GAME+1;STATE.MENU_MAP=STATE.CONTINUE_GAME+1;STATE.MENU_SELECT_WORLD=STATE.MENU_MAP+1;STATE.MENU_SELECT_LEVEL=STATE.MENU_SELECT_WORLD+1;STATE.LOAD_UNLOAD=STATE.MENU_SELECT_LEVEL+1;STATE.GAMEPLAY_UPDATE=STATE.LOAD_UNLOAD+1;STATE.GAMEOVER=STATE.GAMEPLAY_UPDATE+1;STATE.GAMEEND=STATE.GAMEOVER+1;STATE.GAME_STATISTIC=STATE.GAMEEND+1;STATE.MENU_OPTIONS=STATE.GAME_STATISTIC+1;STATE.MENU_GET_MORE_GAMES_INIT=STATE.MENU_OPTIONS+1;STATE.MENU_GET_MORE_GAMES=STATE.MENU_GET_MORE_GAMES_INIT+1;STATE.MENU_HELP=STATE.MENU_GET_MORE_GAMES+1;STATE.MENU_ABOUT=STATE.MENU_HELP+1;STATE.MENU_EXIT=STATE.MENU_ABOUT+1;STATE.RESET_GAME=STATE.MENU_EXIT+1;STATE.RESUME_GAME=STATE.RESET_GAME+1;STATE.BACK_TO_MINIMAP=STATE.RESUME_GAME+1;STATE.RESTART_LEVEL=STATE.BACK_TO_MINIMAP+1;STATE.MENU_INIT=STATE.RESTART_LEVEL+1;STATE.NO=STATE.MENU_INIT+1;STATE.YES=STATE.NO+1;STATE.MENU_INGAME=STATE.YES+1;STATE.MENU_INGAME_OPTIONS=STATE.MENU_INGAME+1;STATE.MENU_INGAME_MAIN_MENU=STATE.MENU_INGAME_OPTIONS+1;STATE.ASK_SOUND_LEVEL=STATE.MENU_INGAME_MAIN_MENU+1;STATE.SOUND_OFF=STATE.ASK_SOUND_LEVEL+1;STATE.SOUND_LOW=STATE.SOUND_OFF+1;STATE.SOUND_MEDIUM=STATE.SOUND_LOW+1;STATE.SOUND_HIGH=STATE.SOUND_MEDIUM+1;STATE.IGP=STATE.SOUND_HIGH+1;STATE.K_MRC_INIT=STATE.IGP+1;STATE.K_MRC_VALIDATING=STATE.K_MRC_INIT+1;STATE.K_MRC_EXPIRED=STATE.K_MRC_VALIDATING+1;STATE.K_MRC_NETWORK_FAILED=STATE.K_MRC_EXPIRED+1;STATE.END_GAME_IGP=STATE.K_MRC_NETWORK_FAILED+1;STATE.NEW_STATE2=STATE.END_GAME_IGP+1;STATE.NEW_STATE3=STATE.NEW_STATE2+1;STATE.NEW_STATE4=STATE.NEW_STATE3+1;STATE.NEW_STATE5=STATE.NEW_STATE4+1;STATE.MENU_TNB_MAIN=STATE.NEW_STATE5+1;STATE.MENU_TNB_MAIN_W_PURCHASE=STATE.MENU_TNB_MAIN+1;STATE.POPUP_TNB_DEMO=STATE.MENU_TNB_MAIN_W_PURCHASE+1;STATE.POPUP_TNB_PROBLEM=STATE.POPUP_TNB_DEMO+1;STATE.POPUP_TNB_LOADING=STATE.POPUP_TNB_PROBLEM+1;STATE.POPUP_TNB_CONFIRM=STATE.POPUP_TNB_LOADING+1;STATE.POPUP_TNB_DOUBLE_CONFIRM=STATE.POPUP_TNB_CONFIRM+1;STATE.POPUP_TNB_UNLOCK_SUCCESS=STATE.POPUP_TNB_DOUBLE_CONFIRM+1;STATE.POPUP_TNB_UNLOCK_FAILED=STATE.POPUP_TNB_UNLOCK_SUCCESS+1;STATE.POPUP_TNB_PURCHASECODE=STATE.POPUP_TNB_UNLOCK_FAILED+1;STATE.POPUP_TNB_UNLOCK_CODE_SUCCESS=STATE.POPUP_TNB_PURCHASECODE+1;STATE.POPUP_TNB_UNLOCK_CODE_FAILED=STATE.POPUP_TNB_UNLOCK_CODE_SUCCESS+1;STATE.POPUP_TNB_TC=STATE.POPUP_TNB_UNLOCK_CODE_FAILED+1;STATE.POPUP_TNB_ENDGAME=STATE.POPUP_TNB_TC+1;STATE.POPUP_TNB_LIMIT=STATE.POPUP_TNB_ENDGAME+1;STATE.BTN_TNB_OK=STATE.POPUP_TNB_LIMIT+1;STATE.BTN_TNB_CANCEL=STATE.BTN_TNB_OK+1;STATE.BTN_TNB_BUYGAME=STATE.BTN_TNB_CANCEL+1;STATE.BTN_TNB_PLAY_THE_GAME=STATE.BTN_TNB_BUYGAME+1;STATE.BTN_TNB_DEMO=STATE.BTN_TNB_PLAY_THE_GAME+1;STATE.BTN_TNB_PURCHASECODE=STATE.BTN_TNB_DEMO+1;STATE.BTN_TNB_GETNOW=STATE.BTN_TNB_PURCHASECODE+1;STATE.BTN_TNB_MM=STATE.BTN_TNB_GETNOW+1;STATE.BTN_TNB_TC=STATE.BTN_TNB_MM+1;STATE.BTN_TNB_TRY=STATE.BTN_TNB_TC+1;STATE.BTN_TNB_EXIT=STATE.BTN_TNB_TRY+1;STATE.BTN_TNB_BUYNOW=STATE.BTN_TNB_EXIT+1;var bi=STATE.INIT;var aG;var ap;var aB=480;var aL=640;var cO=240;var cK=320;var bb=LowAPI.Gen_Array([aB],0);var a9=LowAPI.Gen_Array([aL],0);var l=null;e.s_next_game_state_after_unload=-1;e._mapTileCountWidth=0;e._mapTileCountHeight=0;e._entityCount=0;e._phyData;e._topLayerData=null;e._topLayerFlip=null;e._entityMap=new Hashtable(10000);e._entitiesRowTable=new Hashtable(10000);e._entitiesRowData=null;e._entityRowDataCount=0;e._entityMaxId=0;var ao=8192;var X=16384;var w=24576;e._segmentCount=0;e._segments=null;e._segmentParams=null;e._segmentAngles=null;var o=0;var bl=1;e._gameProgress=o;e._levelId=-1;e._worldId=0;e._tempLevelId=0;e._levelFinalInfo1=0;e._levelFinalInfo2=0;e._finalLevelIndex=20;e._levelUnlocked=-1;e._isIntroLevel=false;e._levelInfo=LowAPI.Gen_Array([cj.LEVEL_INFO_NUM],0);e._playerInfo=LowAPI.Gen_Array([cj.PLAYER_INFO_NUM],0);e._levelTotalScore=LowAPI.Gen_Array([DAI.LEVELS_NUM_MAX],0);e._levelStarInfo=LowAPI.Gen_Array([DAI.LEVELS_NUM_MAX*DAI.STAR_INFO_SIZE],0);var cT=0;var da=0;var z=0;var bU=0;var dc=0;var ar=0;var aq=0;e._inCinematicBlackScreen=false;e._class2sprites=null;e._level2tiled=null;var aJ=null;var c6=null;e._interface=null;var bB=null;var a8=null;var N=null;var y=null;var c8=null;var Y=null;e._balanceImageData=null;e._balanceImageSize=null;var bo=null;var a2=null;var bm=0;e._velocityRate=0;e._frameDT=0;e._frameDT_Real=0;var ce=0;var ac=0;var c5=0;var by=false;var cW=false;var bJ=33;var b7=66;var aS=100;var G=false;var cQ=false;var b0=false;e.prototype.Pause=function(){if(DEF.dbgEnable){Dbg("Pause ========================== s_game_state : "+bi)}bq=true;if(DSound_Channel.SFX!=DSound_Channel.BGM){e.StopSound(DSound_Channel.SFX)}if(GLLibConfig.sound_enableThread){GLLibPlayer.Snd_ForceExecOnThreadOnGamePause()}else{GLLibPlayer.Snd_Update()}if(bi==STATE.GAMEPLAY_UPDATE||bi==STATE.MENU_MAP){e.initIngameMenu(STATE.MENU_INGAME)}else{e.PauseSoundBGM()}if(GLLibConfig.sound_enableThread){GLLibPlayer.Snd_ForceExecOnThreadOnGamePause()}else{GLLibPlayer.Snd_Update()}};e.prototype.Resume=function(){if(DEF.dbgEnable){Dbg("Resume ========================== s_game_state : "+bi)}bq=false;if(bi!=STATE.MENU_INGAME&&bi>0){this.ResumeSoundBGM()}};e.prototype.showNotify=function(){e.__superproto__.showNotify.call(this);this.Resume()};e.prototype.hideNotify=function(){e.__superproto__.hideNotify.call(this);this.Pause();F=true};e.PauseSoundBGM=function(){var dg=false;try{dg=GLLibPlayer.Snd_IsPlaying(DSound_Channel.BGM)}catch(df){if(DEF.dbgEnable){Dbg("-------------------- error : "+df.message)}}if(dg){GLLibPlayer.Snd_Pause(DSound_Channel.BGM);b0=true}else{GLLibPlayer.Snd_Stop(DSound_Channel.BGM)}};e.prototype.ResumeSoundBGM=function(){if(!e.bIsPaused){if(b0&&!F){GLLibPlayer.Snd_Resume(DSound_Channel.BGM)}else{e.PlaySoundBGM();F=false}b0=false}};e.isSoundEnabled=false;e.prototype.startSound=function(){if(!e.isSoundEnabled){e.isSoundEnabled=true}if(e.bIsPaused){e.PlaySound(DSound_Channel.SFX,DATA.SOUND_MENU_CONFIRM)}else{e.PlaySound(DSound_Channel.BGM,DATA.SOUND_BGM_MAIN_MENU)}};e.prototype.StopSound=function(){if(e.isSoundEnabled){GLLibPlayer.Snd_StopAllSounds();e.isSoundEnabled=false;b0=false}};e.StopSound=function(df){GLLibPlayer.Snd_Stop(df)};var Q=false;e.PlaySoundBGM=function(){var di=false;try{di=GLLibPlayer.Snd_IsPlaying(DSound_Channel.BGM)}catch(dh){if(DEF.dbgEnable){Dbg("-------------------- error : "+dh.message)}}if(di){e.StopSound(DSound_Channel.BGM)}if(bi==STATE.MENU_MAP){e.PlaySound(DSound_Channel.BGM,DATA.SOUND_BGM_STAGE_CHOOSE)}else{if(bi==STATE.GAMEPLAY_UPDATE){var df=DATA.SOUND_BGM_LABYRINTH_LEVEL;if(e._worldId%2!=0){df=DATA.SOUND_BGM_01}else{df=DATA.SOUND_BGM_02}var dg=e.MiniMapGetLevelByPoint(e._miniMapCursorAtPoint);if(dg%4<=0&&!Q&&e._tempLevelId!=DAI.LEVEL_ID_CASTLE_FINAL_BOSS){Q=true;df=DATA.SOUND_BGM_CUTSCENE_STORY}if(e._tempLevelId%DAI.LEVELS_NUM_PRE_WORLD==DAI.LEVLE_ID_BOSS_FIGHT){if(!Q){Q=true;df=DATA.SOUND_BGM_CUTSCENE_STORY}else{df=DATA.SOUND_BGM_BOSS_FIGHT}}if(e._tempLevelId==DAI.LEVEL_ID_CASTLE_FINAL_BOSS){if(!Q){Q=true;df=DATA.SOUND_BGM_CUTSCENE_STORY}else{df=DATA.SOUND_BGM_BOSS_FIGHT}}if(e._tempLevelId>DAI.LEVEL_ID_CASTLE_FINAL_BOSS){df=DATA.SOUND_BGM_CUTSCENE_STORY}e.PlaySound(DSound_Channel.BGM,df)}else{if(bi!=STATE.LOAD_UNLOAD&&!e.bIsPaused){e.PlaySound(DSound_Channel.BGM,DATA.SOUND_BGM_MAIN_MENU)}}}};e.PlaySound=function(dh,di){if(s_game_isPaused){return}if(e.isSoundEnabled){var dg=DGUI.SOUND_VOLUME;var df=1;if(dh==DSound_Channel.BGM){df=100}if(di==DATA.SOUND_BGM_LOSE||di==DATA.SOUND_BGM_LEVEL_CLEAR){df=1}GLLibPlayer.Snd_Play(dh,di,df,dg,0)}};var bZ=-1;var t=-2;var s=16777215;var m=10;var M;var h;e.prototype.drawSoftKeys=function(){e.txtSetFont(cX);cn.SetCurrentPalette(0);if(M>bZ){if(M!=TEXT.MENU_SK_SELECT){e.txtDraw(cG,Text_GetString(M),0,GLLibConfig.screenHeight,BOTTOM|LEFT)}}if(h>bZ){e.txtDraw(cG,Text_GetString(h),GLLibConfig.screenWidth,GLLibConfig.screenHeight,BOTTOM|RIGHT)}if(M==t){SetColor(s)}if(h==t){SetColor(s)}};e.prototype.setSoftKeys=function(dg,df){if(GLLibConfig.softkeyOKOnLeft){M=dg;h=df}else{M=df;h=dg}};e.prototype.clearSoftKeys=function(){M=h=bZ};var aE=14666147;var bd=0;var b2=2283938338;var aP=DGUI.MENU_MAIN_X;var aO=DGUI.MENU_MAIN_Y;var cv=DGUI.MENU_IGM_X;var cu=DGUI.MENU_IGM_Y;var az=DGUI.MENU_OPTIONS_Y_OFFSET;var cS=DGUI.MENU_OPTIONS_SPACING;var T=80;var bY=50;var bG=DGUI.MENU_IGP_X_OFF;var aD=DGUI.MENU_IGP_Y_OFF;var q=0;var cG=0;var cb=0;var cF=1;var aC=3;var cm=null;var b5=0;var B;var cI;var f={};f.STATE=0;f.TITLE_AS_CHILD=f.STATE+1;f.TITLE_AS_PARENT=f.TITLE_AS_CHILD+1;f.LSK_TEXT=f.TITLE_AS_PARENT+1;f.RSK_TEXT=f.LSK_TEXT+1;f.CHILD_INDEXES=f.RSK_TEXT+1;f.MAX_DEPTH=10;var cB=[STATE.ASK_SOUND_LEVEL,TEXT.MENU_SOUND,TEXT.MENU_SOUND,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12];var aI=[STATE.ASK_SOUND_LEVEL,TEXT.MENU_SOUND,TEXT.MENU_SOUND,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,17,18,19,20];var C=[[STATE.MENU_MAIN,TEXT.MENU_MAIN_MENU,-1,TEXT.MENU_SK_SELECT,bZ,39,35,6,2,4,5],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_OPTIONS,TEXT.MENU_OPTIONS,TEXT.MENU_OPTIONS,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,16,9,10],[],[STATE.MENU_HELP,TEXT.MENU_HELP,TEXT.MENU_HELP,TEXT.MENU_SK_NEXT,TEXT.MENU_SK_BACK,],[STATE.MENU_ABOUT,TEXT.MENU_ABOUT,TEXT.MENU_ABOUT,bZ,TEXT.MENU_SK_BACK,],[STATE.MENU_GET_MORE_GAMES,TEXT.MENU_GET_MORE_GAMES],[STATE.MENU_EXIT,TEXT.MENU_EXIT,TEXT.MENU_ARE_YOU_SURE,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12],[STATE.ASK_SOUND,TEXT.MENU_SOUND,TEXT.MENU_ENABLE_SOUND_QUESTION,TEXT.MENU_SK_SELECT,bZ,11,12],[STATE.SELECT_LANGUAGE,TEXT.MENU_LANGUAGE,TEXT.MENU_LANGUAGE,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,],[STATE.RESET_GAME,TEXT.MENU_RESET_GAME,TEXT.MENU_THE_GAME_DATA,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12],[STATE.NO,TEXT.MENU_SK_NO],[STATE.YES,TEXT.MENU_SK_YES],[STATE.MENU_INGAME,TEXT.MENU_INGAME,TEXT.MENU_INGAME,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,36,37,41,14,4,15,6],[STATE.MENU_INGAME_OPTIONS,TEXT.MENU_OPTIONS,TEXT.MENU_OPTIONS,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,16,],[STATE.MENU_INGAME_MAIN_MENU,TEXT.MENU_MAIN_MENU,TEXT.MENU_ARE_YOU_SURE,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12],cB,[STATE.SOUND_OFF,TEXT.MENU_OFF],[STATE.SOUND_LOW,TEXT.MENU_SND_LOW],[STATE.SOUND_MEDIUM,TEXT.MENU_SND_MEDIUM],[STATE.SOUND_HIGH,TEXT.MENU_SND_LOUD],[STATE.GAMEPLAY_UPDATE,TEXT.MENU_SELECT_LEVEL,],[STATE.GAMEOVER,TEXT.MENU_GAME_OVER,],[STATE.LOAD_UNLOAD,TEXT.MENU_LEVEL1,],[STATE.LOAD_UNLOAD,TEXT.MENU_LEVEL2,],[STATE.LOAD_UNLOAD,TEXT.MENU_LEVEL3,],[STATE.LOAD_UNLOAD,TEXT.MENU_LEVEL4,],[STATE.LOAD_UNLOAD,TEXT.MENU_LEVEL5,],[STATE.MENU_SELECT_WORLD,TEXT.MENU_SELECT_WORLD,TEXT.MENU_SELECT_WORLD,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,54,29,30,31,32,33,34],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_LABYRINTH_WORLD,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_PIRATE_SHIP,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_CAKE_WORLD,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_ICE_WORLD,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_SPACE_WORLD,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_SELECT_LEVEL,TEXT.MENU_GHOST_TOWN,TEXT.MENU_SELECT_LEVEL,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,23,24,25,26,27],[STATE.MENU_NEW_GAME,TEXT.MENU_NEW_GAME,TEXT.MENU_THE_GAME_DATA,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12],[STATE.RESUME_GAME,TEXT.MENU_RESUME,],[STATE.RESTART_LEVEL,TEXT.MENU_RESTART_LEVEL,TEXT.MENU_ARE_YOU_SURE,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12],[STATE.GAME_STATISTIC,TEXT.MENU_GAME_OVER,],[STATE.CONTINUE_GAME,TEXT.MENU_CONTINUE,-1,bZ,bZ,40,-1],[STATE.MENU_MAP,TEXT.MENU_CONTINUE,-1,bZ,bZ,-1,-1],[STATE.BACK_TO_MINIMAP,TEXT.MENU_BACK_TO_CASTLE,TEXT.MENU_ARE_YOU_SURE,TEXT.MENU_SK_SELECT,TEXT.MENU_SK_BACK,11,12],[STATE.GAMEEND,TEXT.MENU_THE_END,],[STATE.BTN_TNB_OK,TEXT.INIT_SK_OK,],[STATE.BTN_TNB_MM,TEXT.MENU_TNB_EXIT,-1,bZ,bZ,],[STATE.BTN_TNB_EXIT,TEXT.MENU_TNB_EXIT,-1,bZ,bZ,],[STATE.BTN_TNB_GETNOW,TEXT.MENU_TNB_GETNOW,-1,bZ,bZ,],[STATE.BTN_TNB_TRY,TEXT.MENU_TNB_TRY,],[STATE.BTN_TNB_DEMO,TEXT.MENU_TNB_DEMO,],[STATE.POPUP_TNB_CONFIRM,TEXT.MENU_TNB_BUYGAME,-1,bZ,TEXT.MENU_SK_BACK,46,51],[STATE.POPUP_TNB_PURCHASECODE,TEXT.MENU_TNB_PURCHASECODE,-1,bZ,TEXT.MENU_SK_BACK,43],[STATE.POPUP_TNB_TC,TEXT.MENU_TNB_TC,-1,bZ,TEXT.MENU_SK_BACK,43],[STATE.POPUP_TNB_DEMO,TEXT.MENU_TNB_DEMO,-1,bZ,TEXT.MENU_SK_BACK,60,48],[STATE.POPUP_TNB_PROBLEM,-1,-1,bZ,bZ,43],[STATE.MENU_TNB_MAIN,TEXT.MENU_MAIN_MENU,-1,bZ,bZ,60,52,50,2],[STATE.POPUP_TNB_LOADING,-1,-1,bZ,bZ,],[STATE.POPUP_TNB_UNLOCK_SUCCESS,-1,-1,bZ,bZ,43,],[STATE.POPUP_TNB_UNLOCK_FAILED,-1,-1,bZ,bZ,47,45,],[STATE.POPUP_TNB_DOUBLE_CONFIRM,-1,-1,bZ,TEXT.MENU_SK_BACK,63,],[STATE.POPUP_TNB_UNLOCK_CODE_FAILED,-1,-1,bZ,bZ,43,],[STATE.BTN_TNB_BUYGAME,TEXT.MENU_TNB_BUYGAME,-1,bZ,bZ,],[STATE.POPUP_TNB_ENDGAME,-1,-1,bZ,bZ,60,44,],[STATE.POPUP_TNB_LIMIT,-1,-1,bZ,bZ,60,50],[STATE.BTN_TNB_BUYNOW,TEXT.MENU_TNB_BUYNOW_ALL,-1,bZ,bZ,],];var bs=13;var bQ=5;var av=8;var bx=28;var v=42;e.bIsForceChangeMenu=false;e.bIsForceRemoveParent=false;e.bIsFocusInputText=false;e.elemInput=null;var bO="";var cP=false;var J=180000;var a=5;var ak=-1;e.currentTrials=a;e.bIsBillingFailed=false;e.version="1.0.8";window.isBlockKey5=false;e.overSkipIntro=false;e.isOPTGLLogo=true;var F=false;var V=null;var aW="";var c7=0;var bg=true;var a3="";var i="";e.isFullGame=function(){return(GLLibConfiguration.tnb_enable&&(Billing.isFullVersion()||Billing.isSIMNSupport()))};e.hasBillingProblem=function(){return Billing.isBillingPending()||e.bIsBillingFailed};var bF={};bF.REMOVE_PARENT=1;bF.OVERRIDE_PREV_MENU=2;bF.RESET_ALL_MENU=4;e.exitApp=function(){e.StopSound(DSound_Channel.BGM);window.opener?window.opener.close():window.close()};e.goToMenuById=function(dl,df){var dk=-1;for(var dh=0;dh<C.length;dh++){if(C[dh][f.STATE]==dl){dk=dh;break}}if(dk!=-1){if((df&bF.RESET_ALL_MENU)!=0){bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;e.s_next_game_state_after_unload=STATE.MENU_INIT;e.s_next_force_change_menu=dl;e.s_next_force_change_menu_idx=dk;e.is_reset_to_menu=true}else{var di=C[B[b5]];var dj=false;var dg=0;for(dg=f.CHILD_INDEXES;dg<di.length;dg++){if(di[dg]==dl){dj=true;break}}if(!dj){if((df&bF.OVERRIDE_PREV_MENU)!=0){di.pop()}di.push(dk);dg=C[B[b5]].length-f.CHILD_INDEXES-1}cI[b5]=dg;this.bIsForceChangeMenu=true;this.bIsForceRemoveParent=((df&bF.REMOVE_PARENT)!=0);e.prototype.updateMenu()}}};function cd(){if(e.elemInput!=null){Dbg("***[AW][Game] Input element is existing.");return}Dbg("***[AW][Game] Create input element.");var df=document.createElement("input");df.type="text";df.value="";df.style.width="0px";df.style.height="0px";df.style.position="absolute";df.style.top="0px";df.style.left="0px";df.autocomplete="off";df.autocurrent="off";bO="";document.body.appendChild(df);df.focus();e.elemInput=df;return df}function bW(dg){if(dg==null){Dbg("***[AW][Game] Input element doesn't exist, so can't handle.");return}if(dg.value.length<=8){bO=dg.value}var dh=WasAnyKeyReleased();if(dh==GLKey.k_menuBack){var df=bO.length;if(df==0){n();e.removeOverlayElement()}else{bO=bO.substr(0,df-1);dg.value=bO;ResetKey()}}return bO}function n(){if(e.elemInput==null){Dbg("***[AW][Game] Input element doesn't exist, so can't remove it.");return}Dbg("***[AW][Game] Remove input element.");e.elemInput.blur();document.body.removeChild(e.elemInput);e.elemInput=null}function A(dg,df,dh){e.updateOverlayElement(dg,"center","")}e.createOverlayElement=function(dn,dm,dg,dq,dj,dr,dl){if(V!=null){Dbg("***[AW][Game] Render element is existing, so no need create.");return}Dbg("***[AW][Game] Create render element.");var dh=g._getCanvasElement();aW=dh.style.position;c7=dh.style.zIndex;dh.style.position="absolute";dh.style.zIndex=-1;var dk=1*dh.style.width.split("p")[0]/DEF.VIEW_W;var dp=1*dh.style.width.split("p")[0]/DEF.VIEW_H;Dbg("canvasRatio: "+dk);var df=document.createElement("p");df.font="bold "+11+"px arial";df.style.position="absolute";df.style.top=dr===br?"12%":dr;df.style.width=((dg+15)*dk)+"px";df.style.color=dj===br?"white":dj;df.style.fontSize=dl===br?"3.7vh":dl;df.style.lineHeight=(25*dp)+"px";var di=dh.parentNode;di.appendChild(df);V=df;return V};e.updateOverlayElement=function(dg,dh,df){if(V==null){Dbg("***[AW][Game] Render element is null.");return}if(V.innerHTML!=dg){V.innerHTML=dg}if(V.align!=dh){V.align=dh;if(dh==="center"){V.style.left="50%";V.style.transform="translate(-50%, 0%)"}else{V.style.left="50%";V.style.transform="translate(-55%, 0%)"}}if(V.dir!=df){V.dir=df}};e.removeOverlayElement=function(){if(V==null||!bg){Dbg("***[AW][Game] Render element doesn't exist, so can't remove it.");return}Dbg("***[AW][Game] Remove render element.");var dg=V.parentNode;dg.removeChild(V);V=null;var df=g._getCanvasElement();df.style.position=aW;df.style.zIndex=c7};e.getAlignLineWidth=function(dh,df){switch(dh){case STATE.POPUP_TNB_CONFIRM:var dg=Billing.deviceMCC();if(Billing.getCurrentStringLang()==="AR"){return df+105}else{return df+65}break;case STATE.POPUP_TNB_TC:var dg=Billing.deviceMCC();if(Billing.getCurrentStringLang()==="AR"){return df+115}else{return df+65}break}};e.initMenus=function(){cI=LowAPI.Gen_Array([f.MAX_DEPTH],0);var df=0;if(!this.isFullGame()){df=54}B=LowAPI.Gen_Array([f.MAX_DEPTH],df);b5=0;if(aJ==null){Pack_Open(DATA.PACK_SPLASH);if(DEF.dbgEnable){Dbg("---------------------- splash.. load")}aJ=e.LoadSprite(DATA.SPLASH_SPLASH,-1,true,false);Pack_Close()}if(e._interface==null){Pack_Open(DATA.PACK_SPRITE);e._interface=e.LoadSprite(DATA.SPRITE_INTERFACE,-1,true,false);Pack_Close()}if(bB==null){Pack_Open(DATA.PACK_SPRITE);bB=e.LoadSprite(DATA.SPRITE_TOUCHINTERFACE,-1,true,false);Pack_Close()}if(N==null){Pack_Open(DATA.PACK_SPRITE);N=e.LoadSprite(DATA.SPRITE_MENUINGAME,-1,true,false);Pack_Close()}if(y==null){Pack_Open(DATA.PACK_SPRITE);y=e.LoadSprite(DATA.SPRITE_FIREWORK,-1,true,false);Pack_Close()}if(!this.isFullGame()&&c8==null){Dbg("*** [AW] Load tnb popup sprite");Pack_Open(DATA.PACK_SPRITE);c8=e.LoadSprite(DATA.SPRITE_MENUINGAME,-1,true,false);Pack_Close()}};var b9;var bE=null;var bz;var bh;var U=[1,2,3,4,5,6,5];var cl=0;var ca=U[cl];var b1=U[cl+4];e._menuShiftPos=0;var cY=false;var cA=false;var b6=0;var bC=0;var aw=false;e.prototype.updateMenu=function(){while((Language.count==1&&C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.SELECT_LANGUAGE)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.CONTINUE_GAME&&e._gameProgress==o)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.RESTART_LEVEL&&e.bIsMiniMap)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.BACK_TO_MINIMAP&&e.bIsMiniMap)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.RESTART_LEVEL&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.BACK_TO_MINIMAP&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(!(Build.useIGP&&G)&&C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.MENU_GET_MORE_GAMES)||(!e.hasBillingProblem()&&C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.POPUP_TNB_PURCHASECODE)){cI[b5]++;if(cI[b5]>C[B[b5]].length-f.CHILD_INDEXES-1){cI[b5]=0}e.redrawAll=true}e.redrawAll=true;var d0=0;var dn=0;var dk=0;var d5=0;var eh=false;aw=false;if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){for(var d9=0;d9<U.length;d9++){if(cI[b5]==U[d9]){d5=d9;break}}dn=U[d5]}if(e.redrawAll||bq){var dR=GLLibConfig.screenWidth/2;var dq=GLLibConfig.screenHeight/2;if(e.bIsPaused){if(e.bIsMiniMap){this.DrawMiniMap()}else{this.gameDraw()}}var dw=0;var dP=0;var dG=0;if(e.bIsPaused){var dz=LowAPI.Gen_Array([4],0);var dt,dD;N.GetAFrameRect(dz,DAnimID.MENU_INGAME_INGAMEMENU,0,0,0,0);dt=dz[DEF.BOX_RIGHT]-dz[DEF.BOX_LEFT];dD=dz[DEF.BOX_BOTTOM]-dz[DEF.BOX_TOP];var dl=dR-(dt>>1);var dj=dq-(dD>>1);dw=dD-DGUI.INGAMEMENU_BACKGROUND_WH;dP=dj+DGUI.INGAMEMENU_BACKGROUND_XY;e.FillArgbRect(dl,dj+DGUI.INGAMEMENU_BACKGROUND_XY-13,DEF.VIEW_W,dD-DGUI.BACKGROUND_OFFSET_H,3355443200|aE);N.PaintAFrame(g,DAnimID.MENU_INGAME_INGAMEMENU,0,dl-dz[DEF.BOX_LEFT],dj-dz[DEF.BOX_TOP],0)}else{if(e.bIsTnBPopup){aJ.PaintAFrame(g,am,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);var dz=LowAPI.Gen_Array([4],0);var dt,dD;c8.GetAFrameRect(dz,DAnimID.MENU_INGAME_INGAMEMENU,0,0,0,0);dt=dz[DEF.BOX_RIGHT]-dz[DEF.BOX_LEFT];dD=dz[DEF.BOX_BOTTOM]-dz[DEF.BOX_TOP];var dl=dR-(dt>>1);var dj=dq-(dD>>1);dw=dD-DGUI.INGAMEMENU_BACKGROUND_WH;dP=dj+DGUI.INGAMEMENU_BACKGROUND_XY;e.FillArgbRect(dl,dj+DGUI.INGAMEMENU_BACKGROUND_XY-13,DEF.VIEW_W,dD-DGUI.BACKGROUND_OFFSET_H,3355443200|aE);c8.PaintAFrame(g,DAnimID.MENU_INGAME_INGAMEMENU,0,dl-dz[DEF.BOX_LEFT],dj-dz[DEF.BOX_TOP],0)}else{aJ.PaintAFrame(g,am,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0)}}var di=C[B[b5]][f.TITLE_AS_PARENT];var dO=0;var dL=DEF.VIEW_W-0;var dN=0;var du=10;var d7=1;var dJ=5;if(di>0&&!e.bIsPaused){e.DrawMultiLineText(g,Text_GetString(di),dR,(e.bIsPaused?cu:aO-T),d7,2,dL,dN,du,dJ);dO+=bY}else{if(e.bIsPaused){if(di==TEXT.MENU_ARE_YOU_SURE){e.txtDraw(q,Text_GetString(di),dR,(e.bIsPaused?cu:aO),TOP|HCENTER)}var dp=C[B[b5]].length-f.CHILD_INDEXES;for(var d9=0,d8=0;d9<C[B[b5]].length-f.CHILD_INDEXES;d9++){var d2=C[C[B[b5]][f.CHILD_INDEXES+d9]];if((Language.count==1&&d2[f.STATE]==STATE.SELECT_LANGUAGE)||(d2[f.STATE]==STATE.CONTINUE_GAME&&e._gameProgress==o)||(d2[f.STATE]==STATE.POPUP_TNB_PURCHASECODE&&!e.hasBillingProblem())||(d2[f.STATE]==STATE.RESTART_LEVEL&&e.bIsMiniMap)||(d2[f.STATE]==STATE.BACK_TO_MINIMAP&&e.bIsMiniMap)||(d2[f.STATE]==STATE.RESTART_LEVEL&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(d2[f.STATE]==STATE.BACK_TO_MINIMAP&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(!(Build.useIGP&&G)&&d2[f.STATE]==STATE.MENU_GET_MORE_GAMES)){--dp;continue}}var ea=(cS+6)*(dp)-ASprite.GetCurrentStringHeight();var eb=dP+(dw-ea)/2;dG=eb}}var ed=-1*cS;var d4=(dq+az+dO)-5*DScreen.RATIO;var dr=d4+cS*5;if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){if(dn>b1){cl=d5-4;ca=U[cl];b1=U[cl+4];b6=(d5-4)*(ed);e._menuShiftPos=(-1)*(ed);cY=true}if(dn<ca){cl=d5;ca=U[cl];b1=U[cl+4];b6=b6-(ed);e._menuShiftPos=(ed);cA=true}}if(e.bIsTnBPopup){var dU="";var d7=1;var dH=DEF.VIEW_W-10;var dX=dR;var dW=DGUI.HELP_POSY-25;var dN=0;var du=30;var dJ=5;dO=50;var eg=C[B[b5]][f.STATE];var dF="";switch(eg){case STATE.POPUP_TNB_DEMO:var dI=Text_GetString(TEXT.MENU_DEMO_TRIALS).replace("#",(e.currentTrials));var dh=Text_GetString(TEXT.MENU_DEMO_TIMES).replace("#",Math.floor(J/1000));if(an[e.curLanguage]==GLLang.BR){dO=65}dF=dh+"\n"+dI+"\n\n"+Text_GetString(TEXT.MENU_TNB_INFO);break;case STATE.POPUP_TNB_CONFIRM:cP=true;dF=a3;dH=e.getAlignLineWidth(STATE.POPUP_TNB_CONFIRM,dH);break;case STATE.POPUP_TNB_TC:cP=true;dF=Billing.getTnCString();dO=95;dW=DGUI.HELP_POSY-85;dH=e.getAlignLineWidth(STATE.POPUP_TNB_TC,dH);dJ=2;break;case STATE.POPUP_TNB_UNLOCK_SUCCESS:dF=Text_GetString(TEXT.MENU_TNB_SUCCESS);dW=DGUI.LOADING_POSY;dH-=10;break;case STATE.POPUP_TNB_UNLOCK_FAILED:dF=Text_GetString(TEXT.MENU_TNB_TRANS_FAILED);dW=DGUI.LOADING_POSY;dH-=10;break;case STATE.POPUP_TNB_PROBLEM:dF=Text_GetString(TEXT.MENU_TNB_PROBLEM);dW=DGUI.LOADING_POSY-20;dH-=20;break;case STATE.POPUP_TNB_PURCHASECODE:dF=Text_GetString(TEXT.MENU_TNB_ENTER_PC);dW=DGUI.LOADING_POSY-40;var dv=WasAnyKeyReleased();if(e.elemInput==null&&dv!=GLKey.k_menuBack){cd();e.createOverlayElement(0,0,DEF.VIEW_W,DEF.VIEW_H,"white","40%","5vh")}if(WasAnyKeyPressed()){e.purchaseCode=bW(e.elemInput)}if(e.elemInput!=null){A(e.purchaseCode,dR,dq)}break;case STATE.POPUP_TNB_ENDGAME:dF=Text_GetString(TEXT.MENU_TNB_LIKE);dW=DGUI.LOADING_POSY;break;case STATE.POPUP_TNB_LIMIT:dF=Text_GetString(TEXT.MENU_TNB_LIMIT);dW+=30;break;case STATE.POPUP_TNB_UNLOCK_CODE_FAILED:dF=Text_GetString(TEXT.MENU_TNB_INVALID_PC);dW=DGUI.LOADING_POSY;break;case STATE.POPUP_TNB_DOUBLE_CONFIRM:if(Billing.isUseSpecificRule(20)){dF=Text_GetString(TEXT.MENU_TNB_DOUBLECONFIRM_DE).replace("(PRICE)",Billing.getGamePrice())}else{dF=Text_GetString(TEXT.MENU_TNB_DOUBLECONFIRM_UK).replace("(PRICE)",Billing.getGamePrice())}dO=70;break}for(var d9=0;d9<dF.length;d9++){if(dF.charAt(d9)=="^"){dU=dU+"\n"}else{dU=dU+dF.charAt(d9)}}dF=dU;e.txtSetFont(aV);if(bX()&&bg){if(V==null){e.createOverlayElement(dX,dW,DEF.VIEW_W,DEF.VIEW_H)}}e.DrawMultiLineText(g,dF,dX,dW,d7,2,dH,dN,du,dJ);cP=false;e.txtSetFont(cX)}for(var d9=0,d8=0;d9<C[B[b5]].length-f.CHILD_INDEXES;d9++){var d2=C[C[B[b5]][f.CHILD_INDEXES+d9]];if((Language.count==1&&d2[f.STATE]==STATE.SELECT_LANGUAGE)||(d2[f.STATE]==STATE.CONTINUE_GAME&&e._gameProgress==o)||(d2[f.STATE]==STATE.POPUP_TNB_PURCHASECODE&&!e.hasBillingProblem())||(d2[f.STATE]==STATE.RESTART_LEVEL&&e.bIsMiniMap)||(d2[f.STATE]==STATE.BACK_TO_MINIMAP&&e.bIsMiniMap)||(d2[f.STATE]==STATE.RESTART_LEVEL&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(d2[f.STATE]==STATE.BACK_TO_MINIMAP&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(!(Build.useIGP&&G)&&d2[f.STATE]==STATE.MENU_GET_MORE_GAMES)){continue}if(aw){continue}if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){U[d8++]=d9;ca=U[cl];b1=U[cl+4]}if(!e.bIsPaused){var dZ=ASprite.GetCurrentStringHeight()>>1}var ds=d2[f.TITLE_AS_CHILD];if(bi==STATE.MENU_SELECT_LEVEL){ds=this.GetLevelTextByLevelId(e._worldId*DAI.LEVELS_NUM_PRE_WORLD)+d9}var d1;if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){g.setClip(DGUI.MENU_MAIN_CLIPX,(dq+az+dO)-DGUI.MENU_MAIN_CLIPOFFSETH,DGUI.MENU_MAIN_CLIPW,cS*5);d1=(dq+az+dO)+d0+b6}else{d1=(dq+az+dO)+d0}if(e.bIsPaused){d1=dG+d0}var dM=null;var dK=Text_GetString(ds);if(Language.count>1&&C[B[b5]][f.STATE]==STATE.SELECT_LANGUAGE){var dY=d2[f.TITLE_AS_CHILD]-TEXT.MENU_LANGUAGE_NAME;dK=c1[dY]}var dT=Text_GetString(TEXT.MENU_ON);var d6=Text_GetString(TEXT.MENU_OFF);var dV=[" "+dT," "+d6];if(e.isSoundEnabled){bC=0}else{bC=1}if(C[B[b5]][f.STATE]!=STATE.MENU_MAIN&&C[B[b5]][f.STATE]!=STATE.MENU_TNB_MAIN){if((dK==(Text_GetString(TEXT.MENU_SOUND))||dK==(Text_GetString(TEXT.MENU_OPTIONS)))){dK=Text_GetString(TEXT.MENU_SOUND)+dV[bC];if(cI[b5]==d9){eh=true}}}if(C[B[b5]][f.STATE]==STATE.POPUP_TNB_DOUBLE_CONFIRM){if(dK==(Text_GetString(TEXT.MENU_TNB_BUYNOW_ALL))){if(Billing.isUseSpecificRule(20)){dK=Text_GetString(TEXT.MENU_TNB_BUYNOW_DE)}else{dK=Text_GetString(TEXT.MENU_TNB_BUYNOW_ALL)}}}if(bq){cI[b5]=0;cl=0;b6=0;ca=U[cl];b1=U[cl+4]}if(cI[b5]==d9){dk=d2[f.TITLE_AS_CHILD];if(bi==STATE.MENU_SELECT_LEVEL){dk=this.GetLevelTextByLevelId(e._worldId*DAI.LEVELS_NUM_PRE_WORLD)+d9}if((C[B[b5]][f.STATE]==STATE.POPUP_TNB_DOUBLE_CONFIRM&&Billing.isUseSpecificRule(20))||(ds==TEXT.MENU_TNB_TC&&(an[e.curLanguage]==GLLang.RU||an[e.curLanguage]==GLLang.FR||an[e.curLanguage]==GLLang.DE||an[e.curLanguage]==GLLang.EN||an[e.curLanguage]==GLLang.IT||an[e.curLanguage]==GLLang.ES))||(ds==TEXT.MENU_TNB_DEMO&&(an[e.curLanguage]==GLLang.DE||an[e.curLanguage]==GLLang.RU))){dK=dK.split(" ");var dm="";var dQ="";if(dK.length==3){dm=dK[0]+" "+dK[1];dQ=dK[2]}else{if(dK.length==2){dm=dK[0];dQ=dK[1]}}dM=this.txtDrawSpecialEffectWave(cI[b5]==d9?cF:cb,dm,dR,d1+e._menuShiftPos,LEFT);this.txtDrawSpecialEffectWave(cI[b5]==d9?cF:cb,dQ,dR,d1+e._menuShiftPos+15,LEFT)}else{dM=this.txtDrawSpecialEffectWave(cI[b5]==d9?cF:cb,dK,dR,d1+e._menuShiftPos,LEFT)}}else{var dE=(cI[b5]==d9?cF:cb);if(d2[f.STATE]==STATE.MENU_GET_MORE_GAMES){dE=aC}if((ds==TEXT.MENU_TNB_TC&&(an[e.curLanguage]==GLLang.RU||an[e.curLanguage]==GLLang.FR||an[e.curLanguage]==GLLang.DE||an[e.curLanguage]==GLLang.EN||an[e.curLanguage]==GLLang.IT||an[e.curLanguage]==GLLang.ES))||(ds==TEXT.MENU_TNB_DEMO&&(an[e.curLanguage]==GLLang.RU||an[e.curLanguage]==GLLang.DE))){dK=dK.split(" ");var dm="";var dQ="";if(dK.length==3){dm=dK[0]+" "+dK[1];dQ=dK[2]}else{if(dK.length==2){dm=dK[0];dQ=dK[1]}}e.txtDraw(dE,dm,dR,d1+e._menuShiftPos,TOP|HCENTER);e.txtDraw(dE,dQ,dR,d1+e._menuShiftPos+15,TOP|HCENTER)}else{e.txtDraw(dE,dK,dR,d1+e._menuShiftPos,TOP|HCENTER)}}g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);if(cI[b5]==d9){var dC,dB;if(e.bIsPaused){dC=dM[0]-15*DScreen.RATIO;dB=dM[1]+15*DScreen.RATIO;d1+=ASprite.GetCurrentStringHeight()>>1}else{var ec=LowAPI.Gen_Array([4],0);e._interface.GetAFrameRect(ec,DAnimID.INTERFACE_MENU_CURSOR,0,0,0,0);dC=dM[0]-DGUI.MENU_ICON_OFFX;dB=dM[1]+DGUI.MENU_ICON_OFFX;d1+=ASprite.GetCurrentStringHeight()>>1}e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_CURSOR,s_game_currentFrameNB%e._interface.GetAFrames(DAnimID.INTERFACE_MENU_CURSOR),dC,d1,0);e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_CURSOR,s_game_currentFrameNB%e._interface.GetAFrames(DAnimID.INTERFACE_MENU_CURSOR),dB,d1,0)}else{if(!e.bIsPaused){d1+=ASprite.GetCurrentStringHeight()>>1}}if(e.bIsPaused){d1+=(ASprite.GetCurrentStringHeight()>>1)+cx}var dA=false;var ef=false;var dg=false;var dy=0;var dx=(e._gameProgress==o?6:5);if((b1>U[3]&&b1<U[6])){dA=true}if((ca>U[0]&&ca<=U[4])){ef=true}if(e.isPointInRect(cv,d1-(aa>>1),GetScreenWidth()-(cv<<1),aa)){if(C[B[b5]][f.STATE]==STATE.MENU_MAIN&&((dA&&d9==dx&&!ef)||(ef&&d9==dy&&!dA))){dg=true}if(DEF.dbgEnable){Dbg("******************************************* isArrowIgnoreListener "+dg)}if(!dg){if((!eh&&((bi==STATE.MENU_OPTIONS&&d9==0)||(bi==STATE.MENU_INGAME&&d9==3)))){if(DEF.dbgEnable){Dbg("******************************************* SOUND OFF -> ON")}eh=true}this.keyPressed(GLLibConfig.keycodeFire);this.keyReleased(GLLibConfig.keycodeFire);e.UpdateKeyState()}cI[b5]=d9;if(DEF.dbgEnable){Dbg("------------------------------------------- click , soundSelected : "+eh+" i : "+d9)}}if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){d0+=cS}else{if((ds==TEXT.MENU_TNB_TC&&(an[e.curLanguage]==GLLang.RU||an[e.curLanguage]==GLLang.FR||an[e.curLanguage]==GLLang.DE||an[e.curLanguage]==GLLang.EN||an[e.curLanguage]==GLLang.IT||an[e.curLanguage]==GLLang.ES))||(ds==TEXT.MENU_TNB_DEMO&&(an[e.curLanguage]==GLLang.RU||an[e.curLanguage]==GLLang.DE))){d0+=cS*1.5+6}else{d0+=cS+6}}}if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){if(b1>U[3]&&b1<U[6]){e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_ARROW_DOWN,0,DEF.SCR_W_D2,dr+9*DScreen.RATIO,0)}if(ca>U[0]&&ca<=U[4]){e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_ARROW_UP,0,DEF.SCR_W_D2,d4-7*DScreen.RATIO,0)}}e.redrawAll=false}bS=WasAnyKeyReleased();if(bS>=0){if(DEF.dbgEnable){Dbg("******************************************* _keycode : "+bS+" s_game_state : "+bi)}if(((bS==GLKey.k_menuOK)||(bS==GLKey.k_fire))&&b5<f.MAX_DEPTH){var d3=C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE];if(e.bIsPaused){var ee=Text_GetString(dk);if(ee==(Text_GetString(TEXT.MENU_HELP))||d3==STATE.MENU_HELP){aw=true}}if(eh&&(d3==STATE.ASK_SOUND_LEVEL||d3==STATE.MENU_INGAME_OPTIONS)){if(bC==0){if(e.isSoundEnabled){this.StopSound();e.isSoundEnabled=false}e.RMS_Save()}else{this.startSound();e.RMS_Save()}bC=++bC%2}else{}}else{if(bS==GLKey.k_menuBack){if(C[B[b5]][f.STATE]==STATE.MENU_MAIN||C[B[b5]][f.STATE]==STATE.MENU_TNB_MAIN||C[B[b5]][f.STATE]==STATE.POPUP_TNB_LIMIT||(e.currentTrials==0&&C[B[b5]][f.STATE]==STATE.POPUP_TNB_CONFIRM)){e.exitApp()}else{if(e.currentTrials>0&&C[B[b5]][f.STATE]==STATE.POPUP_TNB_CONFIRM&&C[B[b5-1]][f.STATE]!=STATE.MENU_TNB_MAIN){e.goToMenuById(STATE.MENU_TNB_MAIN,bF.RESET_ALL_MENU);e.removeOverlayElement()}else{if(b5>0&&C[B[b5]][f.RSK_TEXT]!=-1){b5--;bi=C[B[b5]][f.STATE];e.removeOverlayElement()}else{if(e.bIsPaused&&bi==STATE.MENU_INGAME){if(e.bIsMiniMap){bi=STATE.MENU_MAP}else{bi=STATE.GAMEPLAY_UPDATE}e.bIsPaused=false;this.ResumeSoundBGM()}}}}e.PlaySound(DSound_Channel.SFX,DATA.SOUND_MENU_CONFIRM)}}if(bS==GLKey.k_up){if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){if(ca>U[0]||dn!=ca){cI[b5]--}}else{cI[b5]--}if(cI[b5]<0){cI[b5]=C[B[b5]].length-f.CHILD_INDEXES-1}while((Language.count==1&&C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.SELECT_LANGUAGE)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.CONTINUE_GAME&&e._gameProgress==o)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.RESTART_LEVEL&&e.bIsMiniMap)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.BACK_TO_MINIMAP&&e.bIsMiniMap)||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.RESTART_LEVEL&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.BACK_TO_MINIMAP&&(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME||e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END))||(!(Build.useIGP&&G)&&C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.MENU_GET_MORE_GAMES)||(!e.hasBillingProblem()&&C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE]==STATE.POPUP_TNB_PURCHASECODE)){cI[b5]--;if(cI[b5]<0){cI[b5]=C[B[b5]].length-f.CHILD_INDEXES-1}}}else{if(bS==GLKey.k_down){if(C[B[b5]][f.STATE]==STATE.MENU_MAIN){if(b1<U[6]||dn!=b1){cI[b5]++}}else{cI[b5]++}if(cI[b5]>C[B[b5]].length-f.CHILD_INDEXES-1){cI[b5]=0}}}e.redrawAll=true;ResetKey()}if(cY){e._menuShiftPos-=4*DScreen.RATIO;if(e._menuShiftPos<=0){cY=false;e._menuShiftPos=0}}if(cA){e._menuShiftPos+=4*DScreen.RATIO;if(e._menuShiftPos>=0){cA=false;e._menuShiftPos=0}}if(!aw){this.setSoftKeys(C[B[b5]][f.LSK_TEXT],C[B[b5]][f.RSK_TEXT]);this.drawSoftKeys()}var d3=C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE];if((((bS==GLKey.k_menuOK)&&bi!=STATE.MENU_INGAME)||(bS==GLKey.k_fire)||e.bIsForceChangeMenu)&&b5<f.MAX_DEPTH&&d3!=STATE.ASK_SOUND_LEVEL&&d3!=STATE.MENU_INGAME_OPTIONS){var df=bi;bi=C[C[B[b5]][f.CHILD_INDEXES+cI[b5]]][f.STATE];var dS=C[B[b5]][f.CHILD_INDEXES+cI[b5]];b5++;B[b5]=dS;cI[b5]=0;if(Language.count>1&&df!=STATE.SELECT_LANGUAGE&&bi==STATE.SELECT_LANGUAGE){cI[b5]=e.curLanguage}e.PlaySound(DSound_Channel.SFX,DATA.SOUND_MENU_CONFIRM)}if(e.bIsForceChangeMenu){e.bIsForceChangeMenu=false;C[B[b5-1]].pop();if(e.bIsForceRemoveParent){e.bIsForceRemoveParent=false;B[b5-1]=B[b5];cI[b5-1]=cI[b5];b5--}}return bi};e._isInputEvent=false;e._isinitgame=true;e._eventCallback=null;e.prototype._FakegetMousePos=function(df){return e.__superproto__._FakegetMousePos.call(this,df)};e.prototype.requireUserInputEvent=function(){gllib_runtime.requireUserInputEvent(function(df){e._eventCallback=df;e._isInputEvent=true;Player.processUserInputEvent()})};e.GAMELOFT_LOGO_WAIT_TIME=2500;e.bIsPaused=false;e.bIsMiniMap=false;e.bIsMainMain=false;e.bIsTnBPopup=false;e.redrawAll=false;e.loadingPhase=0;e.s_next_state=0;e.gameAreaX=0;e.gameAreaY=0;e.gameAreaWidth=0;e.gameAreaHeight=0;e.playerCar=null;e.curLanguage=0;var cc=0;e.bSetLanguage=false;e.bSetSound=false;var x;e.keyToIGPMap=null;e.s_License=null;e.prototype.preUpdate=function(){ce+=e._frameDT;var df=ce+(DEF.ANIMATION_FRAME_TICK/4);bm=df/DEF.ANIMATION_FRAME_TICK;ce=ce-(bm*DEF.ANIMATION_FRAME_TICK);e._velocityRate=Math_IntToFixedPoint(DEF.VELOCITY_FRAME_TICK)/1000;if(ac==s_game_keyJustPressed){if(s_game_keyPressedTime-c5>DEF.DOUBLE_PRESSED_INTERVAL){c5=s_game_keyPressedTime}}else{if(s_game_keyJustPressed!=-1){ac=s_game_keyJustPressed;c5=s_game_keyPressedTime}}};var am=2;var cg=0;e.prototype.Game_update=function(){if(ak!=-1){var dg=System.currentTimeMillis()-ak;if(dg>=J&&!e.bIsPaused&&!e.isFullGame()){ak=-1;e.RMS_Save();e.goToMenuById(STATE.POPUP_TNB_ENDGAME,bF.RESET_ALL_MENU)}}e._frameDT_Real=s_game_frameDT;s_game_frameDT=1000/GLLibConfig.FPSLimiter;e._frameDT=1000/GLLibConfig.FPSLimiter;T=0;bY=30;this.preUpdate();this.UpdatePointerEvents(false);switch(bi){case STATE.QUIT:GLLibPlayer.Snd_Quit();e.exitApp();break;case STATE.INIT:this.UpdateGameState_INIT();break;case STATE.GAMELOFT_LOGO:this.UpdateGameState_GAMELOFT_LOGO();break;case STATE.SPLASH:this.UpdateGameState_SPLASH();break;case STATE.SELECT_LANGUAGE_INIT:this.UpdateGameState_SELECT_LANGUAGE_INIT();break;case STATE.SELECT_LANGUAGE:this.UpdateGameState_SELECT_LANGUAGE();break;case STATE.LOAD_UNLOAD:this.UpdateGameState_LOAD_UNLOAD();break;case STATE.MENU_INIT:this.UpdateGameState_MENU_INIT();break;case STATE.ASK_SOUND:this.UpdateGameState_ASK_SOUND();break;case STATE.ASK_SOUND_LEVEL:this.UpdateGameState_ASK_SOUND_LEVEL();break;case STATE.MENU_EXIT:this.UpdateGameState_MENU_EXIT();break;case STATE.IGP:this.UpdateGameState_IGP();break;case STATE.MENU_GET_MORE_GAMES_INIT:this.UpdateGameState_MENU_GET_MORE_GAMES_INIT();break;case STATE.MENU_MAIN:this.UpdateGameState_MENU_MAIN();break;case STATE.MENU_INGAME_MAIN_MENU:this.UpdateGameState_MENU_INGAME_MAIN_MENU();break;case STATE.BACK_TO_MINIMAP:this.UpdateGameState_BACK_TO_MINIMAP();break;case STATE.GAMEPLAY_UPDATE:this.UpdateGameState_GAMEPLAY_UPDATE();break;case STATE.K_MRC_INIT:this.UpdateGameState_K_MRC_INIT();break;case STATE.K_MRC_VALIDATING:this.UpdateGameState_K_MRC_VALIDATING();break;case STATE.K_MRC_EXPIRED:this.UpdateGameState_K_MRC_EXPIRED();break;case STATE.K_MRC_NETWORK_FAILED:this.UpdateGameState_K_MRC_NETWORK_FAILED();break;case STATE.GAMEOVER:this.UpdateGameState_GAMEOVER();break;case STATE.GAMEEND:this.UpdateGameState_GAMEEND();break;case STATE.GAME_STATISTIC:this.UpdateGameState_GAME_STATISTIC();break;case STATE.END_GAME_IGP:this.UpdateGameState_END_GAME_IGP();break;case STATE.MENU_SELECT_LEVEL:var df=e._level2tiled.length>>2;switch(this.updateMenu()){case STATE.LOAD_UNLOAD:e._levelId+=C[B[b5]][f.TITLE_AS_CHILD]-TEXT.MENU_LEVEL1;e._tempLevelId=e._levelId;break}break;case STATE.MENU_SELECT_WORLD:switch(this.updateMenu()){case STATE.MENU_SELECT_LEVEL:e._worldId=(C[B[b5]][f.TITLE_AS_CHILD]-TEXT.MENU_LABYRINTH_WORLD);e._levelId=e._worldId*DAI.LEVELS_NUM_PRE_WORLD;break}break;case STATE.MENU_HELP:e._needSpecialProcess=true;if(b5>0&&C[B[b5]][f.RSK_TEXT]!=-1){this.UpdateGameState_MENU_HELP()}e._needSpecialProcess=false;break;case STATE.MENU_ABOUT:am=1;T=80*DScreen.RATIO;e._needSpecialProcess=true;if(b5>0&&C[B[b5]][f.RSK_TEXT]!=-1){this.UpdateGameState_MENU_ABOUT()}e._needSpecialProcess=false;break;case STATE.RESET_GAME:am=1;bY=0;T=70*DScreen.RATIO;switch(this.updateMenu()){case STATE.YES:e.RMS_Init();b5-=2;bi=C[B[b5]][f.STATE];if((C[B[b5]][f.STATE]==STATE.MENU_MAIN)){bi=STATE.MENU_NEW_GAME}break;case STATE.NO:b5-=2;bi=C[B[b5]][f.STATE];break}break;case STATE.MENU_OPTIONS:am=1;bY=-20;T=80;switch(this.updateMenu()){}break;case STATE.RESUME_GAME:if(e.bIsMiniMap){bi=STATE.MENU_MAP}else{bi=STATE.GAMEPLAY_UPDATE}e.bIsPaused=false;this.ResumeSoundBGM();break;case STATE.RESTART_LEVEL:switch(this.updateMenu()){case STATE.YES:e._checkPointData=null;e.GotoRestart(false);break;case STATE.NO:b5-=2;bi=C[B[b5]][f.STATE];break}break;case STATE.MENU_INGAME:if(DEF.dbgEnableCheat){if((this.useCheatCode()==bi)||DEF.dbgEnableGodMode||DEF.dbgUnlockLevel){if(DEF.dbgEnable){Dbg("_________ s_game_state: "+bi)}e.godModeUnlock=true}}switch(this.updateMenu()){case STATE.MENU_GET_MORE_GAMES:bi=STATE.MENU_GET_MORE_GAMES_INIT;break}break;case STATE.MENU_INGAME_OPTIONS:switch(this.updateMenu()){}break;case STATE.MENU_NEW_GAME:if(e._gameProgress==o){e._tempLevelId=DAI.LEVEL_ID_INTRO_NEW_GAME;bi=STATE.LOAD_UNLOAD;e._gameProgress++;e.RMS_Save()}else{bi=STATE.RESET_GAME}break;case STATE.CONTINUE_GAME:e.GotoMiniMap();break;case STATE.MENU_MAP:this.UpdateMiniMap();this.DrawMiniMap();if(WasKeyReleased(GLKey.k_menuOK)||(WasKeyReleased(GLKey.k_menuBack)&&!e.bIsPaused&&e._textBubbleState==e.TEXT_BUBBLE_OVER&&!e.overSkipIntro)){e.initIngameMenu(STATE.MENU_INGAME)}else{e.overSkipIntro=false}break;case STATE.MENU_TNB_MAIN:if(e.bIsTnBPopup){e.bIsTnBPopup=false}switch(this.updateMenu()){case STATE.BTN_TNB_BUYGAME:if(!e.bIsTnBPopup){e.bIsTnBPopup=true}e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.initBilling();break;case STATE.POPUP_TNB_PURCHASECODE:if(!e.bIsTnBPopup){e.bIsTnBPopup=true}break}break;case STATE.POPUP_TNB_DEMO:if(!e.bIsTnBPopup){e.bIsTnBPopup=true}switch(this.updateMenu()){case STATE.BTN_TNB_DEMO:e.RMS_Load();if(ak==-1&&e.currentTrials>0){e.currentTrials--;ak=System.currentTimeMillis()}Dbg("*** [AW] trials after demo: "+e.currentTrials);e.RMS_Save();if(e._gameProgress==o){e._tempLevelId=DAI.LEVEL_ID_INTRO_NEW_GAME;bi=STATE.LOAD_UNLOAD;e._gameProgress++;e.RMS_Save()}else{bi=STATE.LOAD_UNLOAD;e.loadingPhase=DLoadState.UNLOAD_OVER;e.s_next_game_state_after_unload=STATE.MENU_MAP}e.bIsTnBPopup=false;break;case STATE.BTN_TNB_BUYGAME:e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.initBilling();break}break;case STATE.POPUP_TNB_CONFIRM:if(!e.bIsTnBPopup){e.bIsTnBPopup=true}switch(this.updateMenu()){case STATE.BTN_TNB_GETNOW:if(Billing.isUseSpecificRule(20)||Billing.isUseSpecificRule(21)){e.goToMenuById(STATE.POPUP_TNB_DOUBLE_CONFIRM,bF.REMOVE_PARENT)}else{e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.buyFullVersion()}e.removeOverlayElement();break;case STATE.POPUP_TNB_TC:e.removeOverlayElement();i=Billing.getTnCString().trim();break}break;case STATE.POPUP_TNB_TC:am=1;T=80*DScreen.RATIO;e._needSpecialProcess=true;this.UpdateGameState_POPUP_TNB_TC();e._needSpecialProcess=false;break;case STATE.POPUP_TNB_LOADING:this.UpdateGameState_POPUP_TNB_LOADING();break;case STATE.POPUP_TNB_UNLOCK_SUCCESS:switch(this.updateMenu()){case STATE.BTN_TNB_OK:e.initMenus();bi=STATE.MENU_MAIN;e.bIsTnBPopup=false;break}break;case STATE.POPUP_TNB_UNLOCK_FAILED:switch(this.updateMenu()){case STATE.BTN_TNB_TRY:e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.buyFullVersion();break;case STATE.BTN_TNB_EXIT:if(e.currentTrials<=0){e.exitApp()}else{e.goToMenuById(STATE.MENU_TNB_MAIN,bF.RESET_ALL_MENU)}break}break;case STATE.POPUP_TNB_UNLOCK_CODE_FAILED:switch(this.updateMenu()){case STATE.BTN_TNB_OK:Dbg("*** [AW] Trials: "+e.currentTrials);if(e.currentTrials==0){e.goToMenuById(STATE.POPUP_TNB_LIMIT,bF.RESET_ALL_MENU)}else{e.goToMenuById(STATE.MENU_TNB_MAIN,bF.RESET_ALL_MENU)}break}break;case STATE.POPUP_TNB_PROBLEM:switch(this.updateMenu()){case STATE.BTN_TNB_OK:b5-=2;bi=C[B[b5]][f.STATE];break}break;case STATE.POPUP_TNB_PURCHASECODE:if(!window.isBlockKey5){window.isBlockKey5=true}switch(this.updateMenu()){case STATE.BTN_TNB_OK:if(window.isBlockKey5){window.isBlockKey5=false}e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.checkUnlockCode(e.purchaseCode);n();e.removeOverlayElement();break}break;case STATE.POPUP_TNB_ENDGAME:if(!e.bIsTnBPopup){e.bIsTnBPopup=true}switch(this.updateMenu()){case STATE.BTN_TNB_MM:e.exitApp();break;case STATE.BTN_TNB_BUYGAME:e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.initBilling();break}break;case STATE.POPUP_TNB_LIMIT:switch(this.updateMenu()){case STATE.BTN_TNB_BUYGAME:e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.initBilling();break}break;case STATE.POPUP_TNB_DOUBLE_CONFIRM:switch(this.updateMenu()){case STATE.BTN_TNB_BUYNOW:e.goToMenuById(STATE.POPUP_TNB_LOADING,bF.REMOVE_PARENT);Billing.buyFullVersion();break}break}GLLibPlayer.Snd_Update();this.UpdatePointerEvents(true);this.RenderPointerEvent();this.ClearPointer()};e.NewAlgo=function(dg,dh){var di=240;var df=0;dh.getRGB(aG,0,di,0,0,240,320);e.DrawZoom(dg,0,0);e.DrawZoom(dg,120,0);e.DrawZoom(dg,0,80);e.DrawZoom(dg,120,80);e.DrawZoom(dg,0,160);e.DrawZoom(dg,120,160);e.DrawZoom(dg,0,240);e.DrawZoom(dg,120,240)};e.DrawZoom=function(di,dj,dh){var dg=0;var dk;for(var dl=dh;dl<(dh+80);++dl){for(var df=dj;df<(dj+120);++df){dk=aG[(dl)*240+(df)];ap[dg++]=dk;ap[dg++]=dk}for(var df=dj;df<(dj+120);++df){dk=aG[(dl)*240+(df)];ap[dg++]=dk;ap[dg++]=dk}}};var d=false;var K=0;var c2=0;var bP=DEF.VIEW_H;var cs=false;var al=255;var at=255;e.ShowTheStory=function(){g.setColor(0);g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);g.fillRect(0,0,DEF.VIEW_W,DEF.VIEW_H);K=DGUI.TOPLINEOFSTORYTEXT_OFFSET_Y;e.txtSetFont(aV);e.txtDraw(2,Text_GetString(TEXT.MENU_SK_SKIP),GLLibConfig.screenWidth,GLLibConfig.screenHeight,BOTTOM|RIGHT);if(cs){bP=K+10}if(c2<3){g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H-25);var dg=0;e.DrawMultiLineText(g,Text_GetString(TEXT.MENU_STORY_B1+c2),10,K+10,0,2,DEF.VIEW_W-10,0,10,dg);if(!cs){al-=6;if(al<=0){al=0}}else{al+=12;if(al>=at){al=at}}var df=al<<24;e.FillArgbRect(0,0,DEF.VIEW_W,DEF.VIEW_H-20,df|bd)}if(bP--<K+10&&!cs){cs=true;e._lastFrameNB=s_game_currentFrameNB}if(s_game_currentFrameNB-e._lastFrameNB==15){bP=DEF.VIEW_H;c2++;cs=false;al=255}if(c2==3){c2=0;e.txtSetFont(cX);d=true}if(IsKeyDown(GLKey.k_menuBack)){c2=0;e.txtSetFont(cX);d=true}};e.godModeUnlock=false;var cD=[[1,GLKey.k_num1,GLKey.k_num9,GLKey.k_num7,GLKey.k_num3,STATE.MENU_MAIN],[1,GLKey.k_num3,GLKey.k_num7,GLKey.k_num9,GLKey.k_num1,STATE.MENU_INGAME],];var aZ=0;var cf=1000;var aA=false;var b=2;var ay=0;e.prototype.useCheatCode=function(){var dg,df=-1;for(var dh=0;dh<cD.length;dh++){dg=cD[dh][0];if(WasAnyKeyPressed()!=GLKey.k_invalid){if(WasKeyPressed(cD[dh][dg])){dg++;if(dg==cD[dh].length-1){df=cD[dh][dg];cD[dh][0]=1;break}}else{cD[dh][0]=1;continue}}cD[dh][0]=dg}ay=1;if(bi==STATE.MENU_MAIN){ay=0}if(aA){aZ=System.currentTimeMillis();aA=false}if(e.isPointInRect(0,0,50*DScreen.RATIO,50*DScreen.RATIO)){if(System.currentTimeMillis()-aZ<cf){b++}else{b=2}aA=true}if(e.isPointInRect(GLLibConfig.screenWidth-50*DScreen.RATIO,0,50*DScreen.RATIO,50*DScreen.RATIO)){if(b==cD[ay].length-1){df=cD[ay][b]}}if(df==STATE.MENU_INGAME){if(DEF.dbgEnable){Dbg("____________ ingame, cheat")}}if(df==STATE.MENU_MAIN){if(DEF.dbgEnable){Dbg("____________ main menu, cheat")}}return df};e.InitSelectMenuLanguage=function(){for(var dg=0;dg<Language.count;dg++){Text_LoadTextFromPack_INI("/"+Text_GetLanguageAsString(an[dg]),DATA.TEXT_INIT);c1[dg]=Text_GetString(TEXT.INIT_LANGUAGE_NAME)}var df=C.length;var dh=9;for(var dg=0;dg<an.length;dg++){var di=[STATE.YES,TEXT.MENU_LANGUAGE_NAME+dg];C.push(di);C[dh].push(df+dg)}};e.prototype.UpdateGameState_INIT=function(){Math_Init(DATA.PACK_MISC,DATA.MISC_COS,DATA.MISC_SQRT);if(DEF.dbgEnable){Dbg("loading mime type")}Pack_LoadMIME(DATA.PACK_MIME_TYPE);Text_SetEncoding(Build.encoding);this.LoadMisc();an=LowAPI.Gen_Array([Language.count],0);c1=LowAPI.Gen_Array([Language.count],0);var dg=0;if(Language.EN){an[dg++]=GLLang.EN}if(Language.DE){an[dg++]=GLLang.DE}if(Language.FR){an[dg++]=GLLang.FR}if(Language.IT){an[dg++]=GLLang.IT}if(Language.ES){an[dg++]=GLLang.ES}if(Language.BR){an[dg++]=GLLang.BR}if(Language.PT){an[dg++]=GLLang.PT}if(Language.RU){an[dg++]=GLLang.RU}if(Language.JP){an[dg++]=GLLang.JP}if(Language.CN){an[dg++]=GLLang.CN}if(Language.KR){an[dg++]=GLLang.KR}e.InitSelectMenuLanguage();ASprite.InitCachePool(2);ASprite.InitPoolSize(0,100);ASprite.InitPoolSize(1,100);if(DEF.dbgEnable){Dbg("loading RMS")}e.RMS_Load();if(DEF.dbgEnable){Dbg("loading fonts")}this.fontLoad();GLLibPlayer.Snd_Init(DATA.SOUND_MAX);e.LoadUnload(DLoadState.LOAD_SOUND);if(cW){for(var df=0;df<C.length;df++){if(C[df]==cB){C[df]=aI}}}bi=e.isOPTGLLogo?STATE.SELECT_LANGUAGE_INIT:STATE.GAMELOFT_LOGO;if(Build.useIGP){if(DEF.dbgEnable){Dbg("initializing IGPs")}G=true}};var bq=false;e.prototype.LoadMisc=function(){Pack_Open(DATA.PACK_MISC);e._class2sprites=Pack_ReadData(DATA.MISC_CLASS2SPRIT);e._level2tiled=Pack_ReadData(DATA.MISC_LEVEL2TILED);Pack_Close()};var bj=0;e.prototype.UpdateGameState_GAMELOFT_LOGO=function(){if(e.spriteArray[DSpriteID.GAMELOFT_LOGO]==null){if(DEF.dbgEnable){Dbg("loading gameloft logo")}Pack_Open(DATA.PACK_SPRITE);e.spriteLoad(DSpriteID.GAMELOFT_LOGO,DATA.SPRITE_GAMELOFT_LOGO,true,false);Pack_Close();e.redrawAll=true;x=System.currentTimeMillis()+e.GAMELOFT_LOGO_WAIT_TIME}else{if(e.redrawAll){SetColor(4294967295);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);e.spriteArray[DSpriteID.GAMELOFT_LOGO].PaintFrame(g,DAnimID.LOGO_FRAME_MAIN,(GLLibConfig.screenWidth/2)-(e.spriteArray[DSpriteID.GAMELOFT_LOGO].GetFrameWidth(DAnimID.LOGO_FRAME_MAIN)/2),(GLLibConfig.screenHeight/2)-(e.spriteArray[DSpriteID.GAMELOFT_LOGO].GetFrameHeight(DAnimID.LOGO_FRAME_MAIN)/2),0);bj=System.currentTimeMillis();var dg=document.getElementById("loading_gif");if(dg.style.display="inline"){dg.style.display="none"}e.redrawAll=false}}x=Math.min(x,System.currentTimeMillis()+e.GAMELOFT_LOGO_WAIT_TIME);if(System.currentTimeMillis()>x){if((System.currentTimeMillis()-bj<1300)){for(var df=0;df<100;df++){}}e.spriteUnLoad(DSpriteID.GAMELOFT_LOGO);if(by){a4=DATA.PACK_TEXT;bi=STATE.MENU_INIT;e.loadingPhase=0}else{bi=e.isOPTGLLogo?STATE.SPLASH:STATE.SELECT_LANGUAGE_INIT}e.redrawAll=true;this.requireUserInputEvent()}};e.prototype.UpdateGameState_SPLASH=function(){if(e.redrawAll||bq){aJ.PaintAFrame(g,0,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);var df=3;if((s_game_currentFrameNB%10)>5){if(Billing.isProfileProcessed()){e.DrawMultiLineText(g,Text_GetString(Canvas.isTouchDevice?TEXT.INIT_PRESS_ANY_KEY_TOUCH:TEXT.INIT_TEXT_PRESS_SKIP),GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-30*DScreen.RATIO,BOTTOM|HCENTER,df,GLLibConfig.screenWidth,0,10,15)}}e.redrawAll=false}e.redrawAll=true;if(WasKeyReleased(GLKey.k_fire)&&Billing.isProfileProcessed()){e.RMS_Load();if(e.currentTrials==0&&!e.isFullGame()){e.bIsTnBPopup=true;e.goToMenuById(STATE.POPUP_TNB_LIMIT,bF.RESET_ALL_MENU)}else{bi=STATE.MENU_INIT}}};e.prototype.UpdateGameState_SELECT_LANGUAGE_INIT=function(){e.loadingPhase=0;if(Language.count==1){a4=DATA.PACK_TEXT}else{a4="/"+Text_GetLanguageAsString(an[e.curLanguage])}if(e.bSetLanguage){Dbg("[AW][Start detect lang]");e.curLanguage=0;var dg=(navigator.language||navigator.userLanguage);if(DEF.dbgEnable){Dbg("------------------------- "+dg)}for(var df=0;df<Language.count;df++){if(dg.includes(Text_GetLanguageAsString(an[df]))){e.curLanguage=df;break}}e.initMenus();a4="/"+Text_GetLanguageAsString(an[e.curLanguage]);e.bSetLanguage=false;bi=e.isOPTGLLogo?STATE.GAMELOFT_LOGO:STATE.SPLASH}else{if(e.bSetSound){e.initMenus();B[b5]=av;bi=STATE.ASK_SOUND}else{e.initMenus();bi=e.isOPTGLLogo?STATE.GAMELOFT_LOGO:STATE.SPLASH}}if(!by){Text_LoadTextFromPack_INI(a4,DATA.TEXT_INIT)}cc=e.curLanguage;e.redrawAll=true};var cq=["x",GLLang.EN,GLLang.DE,GLLang.FR,GLLang.IT,GLLang.ES,GLLang.BR,GLLang.PT,GLLang.RU];var p=["x"];e.prototype.UpdateGameState_SELECT_LANGUAGE=function(){am=1;bY=-70*DScreen.RATIO;T=100*DScreen.RATIO;switch(this.updateMenu()){case STATE.YES:var df=e.curLanguage;e.curLanguage=C[B[b5]][f.TITLE_AS_CHILD]-TEXT.MENU_LANGUAGE_NAME;e.RMS_Save();if(cq.indexOf(an[df])*p.indexOf(an[e.curLanguage])>0){if(DEF.dbgEnable){Dbg("-------------------------- Reload font ...")}this.fontLoad()}a4="/"+Text_GetLanguageAsString(an[e.curLanguage]);Text_LoadTextFromPack_INI(a4,DATA.TEXT_MENU);if(e.bSetSound){Text_LoadTextFromPack_INI(a4,DATA.TEXT_INIT);B[b5]=av;bi=STATE.ASK_SOUND;e.bSetLanguage=false}else{b5-=1;bi=C[B[b5]][f.STATE]}break}};e.prototype.GetLevelPaletteIdByWorldId=function(df){if(df>DAI.WORLD_ID_ICE){df++}return df+1};e.prototype.GetLevelMapActorBossByWorldId=function(df){return DAnimID.MAP_ACTOR_BOSS_1+df};e.prototype.GetWorldMapActorIconByWorldId=function(df){if(df>DAI.WORLD_ID_ICE){df++}return DAnimID.MAP_ACTOR_ICON_LABYRINTH+df};e.prototype.GetLevelTextByLevelId=function(df){if(df>=(DAI.WORLD_ID_ICE+1)*DAI.LEVELS_NUM_PRE_WORLD){df+=DAI.LEVELS_NUM_PRE_WORLD}var dg=df-DAI.LEVELS_NUM_PRE_WORLD;return TEXT.MENU_LEVEL1+df};e.prototype.GetLevelMenuTextByLevelId=function(df){var dg=df;return TEXT.MENU_LV1_1+df};e.prototype.GetLevelWizardTextByWorldId=function(df){if(df>DAI.WORLD_ID_ICE){df++}return TEXT.MENU_WIZARD_LABYRINTH+df+1};e.dummyLoadingStep=0;e.prototype.DrawSpecialEffect_Load_Unload=function(dp){var dq=0;var dr=0;FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);dp=this.GetWorldMapActorIconByWorldId(dp);var dz=e.spriteArray[DSpriteID.MAP_ACTOR].GetAnimFrame(dp,0);dr=e.spriteArray[DSpriteID.MAP_ACTOR].GetFrameWidth(dz);var dw=e.spriteArray[DSpriteID.MAP_ACTOR].GetFrameModuleX(dz,0);var dg=0-dw;if(e._gameProgress>bl&&dp<=DAnimID.MAP_ACTOR_ICON_SPACE){e.spriteArray[DSpriteID.MAP_ACTOR].PaintAFrame(g,dp,dq,dg+(GLLibConfig.screenWidth-dr)/2,DGUI.INTERFACE_LOAD_UNLOAD_WORLDICON_POS_Y,0)}var dv=1;var df=DEF.VIEW_W-20;var du=0;var ds=30;var dn=DEF.VIEW_W_D2;var dm=80;var dx=0;var di=5;if(e._gameProgress>bl&&e._tempLevelId<DAI.LEVEL_ID_INTRO_NEW_GAME){e.DrawMultiLineText(g,Text_GetString(this.GetLevelTextByLevelId(e._tempLevelId)),dn,DGUI.INTERFACE_LOAD_UNLOAD_WORLDICON_POS_Y-DGUI.LOAD_UNLOAD_TEXT_OFFSETY,dv,dx,df,du,ds,di)}var dk=DGUI.LOADSTAR_X;var dj=DGUI.LOADSTAR_Y;this.DrawLevelStars(e._tempLevelId,dk,dj);var dt=(56+e.loadingPhase*17)*DScreen.RATIO;var dy=37*DScreen.RATIO;g.setClip(dt,DEF.VIEW_H-dy,DEF.VIEW_W-dt,dy);aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);g.setClip(0,0,DEF.SCR_W,DEF.SCR_H);var dh=e._loadingSpriteMap[e._worldId<<1];var dl=e._loadingSpriteMap[(e._worldId<<1)+1];if(dp==0){}if(e._tempLevelId<DAI.LEVEL_ID_INTRO_NEW_GAME&&e.loadingPhase!=DLoadState.LOAD_OVER){if(e._gameProgress>bl){e.spriteArray[dh].PaintAFrame(g,dl,s_game_currentFrameNB%e.spriteArray[dh].GetAFrames(dl),dt,DEF.VIEW_H-DGUI.INTERFACE_STAR_BOTTOM_OFFSET_Y_LOADING+72*DScreen.RATIO,0)}}if(e.loadingPhase!=DLoadState.LOAD_OVER){e.txtDraw(0,Text_GetString(TEXT.MENU_LOADING)+"...",GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-10*DScreen.RATIO,VCENTER|HCENTER);if(!(e._gameProgress>bl)){var dt=(56+e.dummyLoadingStep*15)*DScreen.RATIO;var dy=37*DScreen.RATIO;g.setClip(dt,DEF.VIEW_H-dy,DEF.VIEW_W-dt,dy);aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);g.setClip(0,0,DEF.SCR_W,DEF.SCR_H);return}}else{if((s_game_currentFrameNB%10)>5){e.DrawMultiLineText(g,Text_GetString(Canvas.isTouchDevice?TEXT.MENU_PRESS_ANY_KEY_TOUCH:TEXT.MENU_TEXT_PRESS_SKIP),GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-5*DScreen.RATIO,BOTTOM|HCENTER,0,GLLibConfig.screenWidth+50,0,10,5)}}e.dummyLoadingStep=0};e.DrawSpecialEffect_Load_Unload_MiniMap=function(dh){FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);if(aJ==null){if(DEF.dbgEnable){Dbg("---------------------- splash..reload")}Pack_Open(DATA.PACK_SPLASH);aJ=e.LoadSprite(DATA.SPLASH_SPLASH,-1,true,false);Pack_Close()}aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);if(dh!=e.MINI_MAP_LOADING_STEP){e.txtDraw(0,Text_GetString(TEXT.MENU_LOADING)+"...",GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-10*DScreen.RATIO,VCENTER|HCENTER)}else{if((s_game_currentFrameNB%10)>5){e.DrawMultiLineText(g,Text_GetString(Canvas.isTouchDevice?TEXT.MENU_PRESS_ANY_KEY_TOUCH:TEXT.MENU_TEXT_PRESS_SKIP),GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-10*DScreen.RATIO,BOTTOM|HCENTER,0,GLLibConfig.screenWidth,0,10,5)}}var df=(56+dh*17)*DScreen.RATIO;var dg=37*DScreen.RATIO;g.setClip(df,DEF.VIEW_H-dg,DEF.VIEW_W-df,dg);aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);g.setClip(0,0,DEF.SCR_W,DEF.SCR_H)};var bV=0;e.prototype.UpdateGameState_LOAD_UNLOAD=function(){if(e.loadingPhase==0){e.dummyLoadingStep=1;e._sprites_load_mask=(1<<DSpriteID.BONUS)|(1<<DSpriteID.MAP_ACTOR);e._sprites_load_mask|=(1<<e._loadingSpriteMap[e._worldId<<1]);bV=e._sprites_load_mask;e.LoadUnload(DLoadState.LOAD_SPRITE);e.dummyLoadingStep=2}e.loadingPhase=e.LoadUnload(e.loadingPhase);if(e.dummyLoadingStep<7){e.dummyLoadingStep++}if(e.loadingPhase>0){try{this.DrawSpecialEffect_Load_Unload(e._worldId)}catch(di){if(DEF.dbgEnable){Dbg(" DrawSpecialEffect_Load_Unload  error : "+di.message)}}}if(e.loadingPhase==DLoadState.LOAD_OVER){if(WasAnyKeyReleased()==GLKey.k_fire){if(by){bi=STATE.SELECT_LANGUAGE_INIT}else{e.GotoInitLevel(false);var dg=e.MiniMapGetLevelByPoint(e._miniMapCursorAtPoint);if(dg>=0){var df=Text_GetString(this.GetLevelMenuTextByLevelId(dg));df=df.substring(df.length-3,df.length);GGTracking.getInstance().push(POINTCUTID.LEVELSTART,df,e._levelTotalScore[e._tempLevelId])}for(var dh=0;dh<64;dh++){if((bV&(1<<dh))!=0){if((e._sprites_load_mask&(1<<dh))==0){if(DEF.dbgEnable){Dbg("spriteUnLoad : *******************  DLoadState.LOAD_OVER")}e.spriteUnLoad(dh)}}}bV=0}if(Build.useCGMRC){e.s_next_state=bi;bi=STATE.K_MRC_INIT}e.redrawAll=true}e.loadingPhase--}else{if(e.loadingPhase==DLoadState.UNLOAD_OVER){if(e.s_next_game_state_after_unload!=-1){bi=e.s_next_game_state_after_unload;if(bi==STATE.MENU_MAP){bi=STATE.CONTINUE_GAME}e.s_next_game_state_after_unload=-1}else{bi=STATE.QUIT}}}};var ae=0;var ck=0;var L=false;var cU=false;e.prototype.UpdateGameState_GAMEOVER=function(){if(e.redrawAll){if(e.bIsPaused){if(e.bIsMiniMap){this.DrawMiniMap()}else{this.gameDraw()}}}var dg=false;if(ck>=DEF.VIEW_H_D2){ck=DEF.VIEW_H_D2;dg=true}if(!dg){ae+=Math.floor(DGUI.SCREEN_CLOSED_STEP);ck=ae;e._lastFrameNB=s_game_currentFrameNB}if(ae>=DEF.VIEW_H_D2){ae=DEF.VIEW_H_D2}g.setColor(0);g.setClip(0,0,DEF.VIEW_W,ck);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);g.setClip(0,DEF.VIEW_H-ae,DEF.VIEW_W,ck);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);if(dg){if(CEntity._HeroParams[DAI.HPI_LIVES]<=0){g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);if(CEntity._HeroParams[DAI.HPI_LIVES]<=0){e.txtDraw(0,Text_GetString(TEXT.MENU_GAME_OVER),GLLibConfig.screenWidth/2,30*DScreen.RATIO,BOTTOM|HCENTER)}e.DrawAnimation(DSpriteID.HERO,DAnimID.HERO_GAME_OVER,DEF.VIEW_W_D2,100*DScreen.RATIO,4);this.DrawgameOverChoice()}else{var df=10;if(s_game_currentFrameNB-e._lastFrameNB>=df){e.GotoRestart(true);L=true;ae=DEF.VIEW_H_D2;ck=DEF.VIEW_H_D2}}}};e.prototype.UpdateGameState_GAMEEND=function(){var df=false;if(ck>=DEF.VIEW_H_D2){ck=DEF.VIEW_H_D2;df=true}if(!df){ae+=14;ck=ae;e._lastFrameNB=s_game_currentFrameNB}g.setColor(0);g.setClip(0,0,DEF.VIEW_W,ck);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);g.setClip(0,DEF.VIEW_H-ae,DEF.VIEW_W,ck);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);if(df){g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);e.txtDraw(0,Text_GetString(TEXT.MENU_THE_END),DEF.SCR_W_D2,DEF.SCR_H_D2,VCENTER|HCENTER);if((s_game_currentFrameNB%10)>5){e.DrawMultiLineText(g,Text_GetString(Canvas.isTouchDevice?TEXT.MENU_PRESS_ANY_KEY_TOUCH:TEXT.MENU_TEXT_PRESS_SKIP),GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-DGUI.PRESS_5_OFFSET_POSY,BOTTOM|HCENTER,0,GLLibConfig.screenWidth,0,10,5)}bS=WasAnyKeyReleased();if(bS>=0){if(e._multiLineTextCurrentCursor>=0){e._multiLineTextCurrentCursor=-1}if(((bS==GLKey.k_menuOK)||(bS==GLKey.k_fire))&&b5<f.MAX_DEPTH){bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;e.initMenus();e.s_next_game_state_after_unload=STATE.MENU_ABOUT;B[++b5]=bQ;cU=true;ae=0;ck=0}e.redrawAll=true;ResetKey()}}};var bN=0;e.prototype.DrawgameOverChoice=function(){var dl=2;var dj=GLLibConfig.screenWidth/2;var di=[200*DScreen.RATIO,230*DScreen.RATIO];var df=null;g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);e.txtDraw(dl,Text_GetString(TEXT.MENU_RESTART_REQUIRE),dj,160*DScreen.RATIO,TOP|HCENTER);for(var dk=0;dk<2;dk++){if(e.isPointInRect(cv,di[dk]-(aa>>1)+5,GetScreenWidth()-(cv<<1),aa)){if(bN==dk){this.keyPressed(GLLibConfig.keycodeFire);this.keyReleased(GLLibConfig.keycodeFire);e.UpdateKeyState()}else{bN=dk}}if(bN==dk){df=this.txtDrawSpecialEffectWave(bN==dk?cF:cb,Text_GetString(TEXT.MENU_SK_YES+dk),dj,di[dk],LEFT)}else{e.txtDraw(dl,Text_GetString(TEXT.MENU_SK_YES+dk),dj,di[dk],TOP|HCENTER)}}var dh=df[0]-15*DScreen.RATIO;var dg=df[1]+15*DScreen.RATIO;var dn=di[bN]+5;e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_CURSOR,s_game_currentFrameNB%e._interface.GetAFrames(DAnimID.INTERFACE_MENU_CURSOR),dh,dn,0);e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_CURSOR,s_game_currentFrameNB%e._interface.GetAFrames(DAnimID.INTERFACE_MENU_CURSOR),dg,dn,0);bS=WasAnyKeyReleased();if(bS>=0){if(((bS==GLKey.k_menuOK)||(bS==GLKey.k_fire))&&b5<f.MAX_DEPTH){try{e.RMS_Load()}catch(dm){if(DEF.dbgEnable){Dbg("-------------------- error : "+dm.message)}}if(bN==1){this.GotoMainMenu()}else{if(e._playerInfo[DAI.HPI_LIVES]<3){e._playerInfo[DAI.HPI_LIVES]=3}bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;e.s_next_game_state_after_unload=STATE.MENU_MAP;e.bIsPaused=false}cU=true;ae=0;ck=0}if(bS==GLKey.k_up){bN=(++bN)%2}else{if(bS==GLKey.k_down){bN=(++bN)%2}}e.redrawAll=true;ResetKey()}};e.drawTheCurtainOpen=function(){ae-=18;ck=ae;if(ck<=0){ae=0;ck=0;L=false}g.setColor(0);g.setClip(0,0,DEF.VIEW_W,ck);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);g.setClip(0,DEF.VIEW_H-ae,DEF.VIEW_W,ck);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight)};var k=false;var r=false;var bw=0;var cz=0;var u=1;var c9=2;e.prototype.UpdateGameState_GAME_STATISTIC=function(){this.gameDraw();var dh=GLLibConfig.screenWidth;var dq=GLLibConfig.screenHeight;var dg=DGUI.GAME_STATISTIC_STARTX,df=DGUI.GAME_STATISTIC_STARTY;e.FillArgbRect(0,0,dh,dq,1744830464|aE);var dp=LowAPI.Gen_Array([3],0);var dj=1;var di=4;var dm=1;var dl=120;switch(bw){case cz:cn.SetCurrentPalette(1);e._stopMove=true;k=false;r=false;var dk=DEF.VIEW_W;this.txtDarwSpecialEffecFlowIntoTheScreen(Text_GetString(TEXT.MENU_LEVEL_COMPLETE),cn,dh>>1,df,aR,dk,dl,LEFT);if(e._stopAdd){bw++;e._stopMove=false;e._moveSpeed=0;e._firstEnterIntoThisFunction=true}break;case u:this.txtDrawSpecialEffectWave_New(1,Text_GetString(TEXT.MENU_LEVEL_COMPLETE),dh>>1,df,di,dm,LEFT);var dn=this.DrawAllTheItemsResults(dg,df,dh,dp,dj);if(dn){e._moveSpeed=0;e._stopMove=false;bw++}break;case c9:this.txtDrawSpecialEffectWave_New(1,Text_GetString(TEXT.MENU_LEVEL_COMPLETE),dh>>1,df,di,dm,LEFT);this.DrawAllTheItemsResults(dg,df,dh,dp,dj);this.DrawTheTotalSums(dg,df+130*DScreen.RATIO,dh,dp,dj);break;default:}if(P){if((s_game_currentFrameNB%10)>5){e.DrawMultiLineText(g,Text_GetString(Canvas.isTouchDevice?TEXT.MENU_PRESS_ANY_KEY_TOUCH:TEXT.MENU_TEXT_PRESS_SKIP),GLLibConfig.screenWidth/2,GLLibConfig.screenHeight-DGUI.PRESS_5_OFFSET_POSY,BOTTOM|HCENTER,0,GLLibConfig.screenWidth,0,10,5)}}if(WasKeyReleased(GLKey.k_fire)){if(!P){bw=c9;e._moveSpeed=0;e._stopMove=true}else{e._moveSpeed=0;e._stopMove=false;k=false;bw=0;P=false;e._playerInfo[DAI.HPI_LIVES]=CEntity._HeroParams[DAI.HPI_LIVES];e._playerInfo[DAI.HPI_HP_MAX]=CEntity._hero._hp;e.GotoNextLevel(true);e._firstEnterIntoThisFunction=true;e._actionSpeed=0}}if(!e._stopMove){e._moveSpeed+=15}};var c=[30*DScreen.RATIO,73*DScreen.RATIO,83*DScreen.RATIO,138*DScreen.RATIO,148*DScreen.RATIO,218*DScreen.RATIO];e.prototype.DrawAllTheItemsResults=function(dg,df,dh,ds,di){var dr=0;var dp=df;var dq=[DAnimID.BONUS_CRYSTAL,DAnimID.BONUS_1UP,DAnimID.BONUS_STAR];var dj=[CEntity._HeroParams[DAI.HPI_CRYSTAL_COUNT],CEntity._HeroParams[DAI.HPI_LIVES],(DAI.MAX_STAR_NUM-e._levelStarInfo[e._tempLevelId*DAI.STAR_INFO_SIZE])];var dn=[1,100,200];df+=20*DScreen.RATIO;var dm=[DEF.VIEW_W,DEF.VIEW_W+50,DEF.VIEW_W+50*2,DEF.VIEW_W+50*3,DEF.VIEW_W+50*4,DEF.VIEW_W+50*5];var dk=LowAPI.Gen_Array([c.length],0);for(var dl=0;dl<c.length;dl++){dk[dl]=c[dl]}for(var dl=0;dl<3;dl++){dp=df+40*(dl+1)*DScreen.RATIO;if(bw==u){dr=dm[dl]-e._moveSpeed;if(dr<=dk[0]){dr=dk[0];if(dl==2){e._stopMove=true}}}else{dr=dk[0]}e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,dq[dl],s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(dq[dl]),dr,dp,0);if(bw==u){dr=dm[dl]-e._moveSpeed;if(dr<=dk[1]){dr=dk[1]}}else{dr=dk[1]}dp-=15*DScreen.RATIO;e.txtDraw(di,String(dj[dl]),dr,dp,TOP|RIGHT);if(bw==u){dr=dm[dl]-e._moveSpeed;if(dr<=dk[2]){dr=dk[2]}}else{dr=dk[2]}e.txtDraw(di,"X",dr,dp,TOP|LEFT);if(bw==u){dr=dm[dl]-e._moveSpeed;if(dr<=dk[3]){dr=dk[3]}}else{dr=dk[3]}e.txtDraw(di,String(dn[dl]),dr,dp,TOP|RIGHT);if(bw==u){dr=dm[dl]-e._moveSpeed;if(dr<=dk[4]){dr=dk[4]}}else{dr=dk[4]}e.txtDraw(di,"=",dr,dp,TOP|LEFT);if(bw==u){dr=dm[dl]-e._moveSpeed;if(dr<=dk[5]){dr=dk[5]}}else{dr=dk[5]}ds[dl]=dj[dl]*dn[dl];e.txtDraw(di,String(ds[dl]),dr,dp,TOP|RIGHT)}return e._stopMove};var P=false;e.prototype.DrawTheTotalSums=function(di,df,dj,dq,dk){var dh=[DEF.VIEW_H,DEF.VIEW_H+30,DEF.VIEW_H+30+30,DEF.VIEW_H+30+30+30];var dl;var dp=di;var dn=df;dn+=30*DScreen.RATIO;g.setColor(16744448);dl=dh[0]-e._moveSpeed;if(dl<=dn||e._stopMove){dl=dn}g.drawLine(dp,dl,dj-(di),dl);dn+=2;dl=dh[0]-e._moveSpeed+10;if(dl<=dn||e._stopMove){dl=dn}g.drawLine(dp,dl,dj-(di),dl);dn+=1;dl=dh[0]-e._moveSpeed+20;if(dl<=dn||e._stopMove){dl=dn}g.drawLine(dp,dl,dj-(di),dl);dp=c[3];dn+=8*DScreen.RATIO;dl=dh[1]-e._moveSpeed;if(dl<=dn||e._stopMove){dl=dn}e.txtDraw(dk,Text_GetString(TEXT.MENU_TOTAL),dp,dl,TOP|RIGHT);dp=DGUI.GAME_STATISTIC_TOTAL_NUM_OFFSETX;dl=dh[2]-e._moveSpeed;if(dl<=dn||e._stopMove){dl=dn}e.txtDraw(dk,"=",dp,dl,TOP|LEFT);var dm=dq[0]+dq[1]+dq[2];if(dm>e._levelTotalScore[e._tempLevelId]){k=true;e._levelTotalScore[e._tempLevelId]=dm}if(!r){r=true;var dg=e.MiniMapGetLevelByPoint(e._miniMapCursorAtPoint);var dr=Text_GetString(this.GetLevelMenuTextByLevelId(dg));dr=dr.substring(dr.length-3,dr.length);GGTracking.getInstance().push(POINTCUTID.LEVELCOMPLETION,dr,dm);e.RMS_Save()}dl=dh[3]-e._moveSpeed;if(dl<=dn||e._stopMove){dl=dn;P=true}dp=dj-(di<<1)+18*DScreen.RATIO;e.txtDraw(dk,String(dm),dp,dl,TOP|RIGHT);if(k){dk=3;e.txtDraw(dk,Text_GetString(TEXT.MENU_NEW_RECORD),dp,dl+24*DScreen.RATIO,TOP|RIGHT)}};e.prototype.UpdateGameState_MENU_INIT=function(){e.initMenus();Text_LoadTextFromPack_INI(a4,DATA.TEXT_MENU);if(e.bIsPaused){B[b5]=bs;bi=STATE.MENU_INGAME}else{if(e.is_reset_to_menu){B[b5]=e.s_next_force_change_menu_idx;bi=e.s_next_force_change_menu;e.is_reset_to_menu=false;e.s_next_force_change_menu=-1;e.s_next_force_change_menu_idx=-1}else{if(e.isFullGame()){bi=STATE.MENU_MAIN}else{bi=STATE.MENU_TNB_MAIN}}}e.redrawAll=true};e.prototype.UpdateGameState_ASK_SOUND=function(){if(e._isInputEvent){e._isInputEvent=false;var df=this._FakegetMousePos(e._eventCallback);be=df.x;bc=df.y}switch(this.updateMenu()){case STATE.YES:bC=0;if(!e.isSoundEnabled){if(cW){GLLibPlayer.Snd_SetMasterVolume(aS)}this.startSound()}if(e.bSetSound){bi=STATE.SPLASH}else{b5-=1;bi=C[B[b5]][f.STATE]}e.bSetSound=false;e.RMS_Save();break;case STATE.NO:bC=1;if(e.isSoundEnabled){this.StopSound()}if(e.bSetSound){bi=STATE.SPLASH}else{b5-=1;bi=C[B[b5]][f.STATE]}e.bSetSound=false;e.RMS_Save();break}};e.prototype.UpdateGameState_ASK_SOUND_LEVEL=function(){T=80;bY=-20;switch(this.updateMenu()){case STATE.YES:this.startSound();b5-=2;bi=C[B[b5]][f.STATE];e.RMS_Save();break;case STATE.NO:if(e.isSoundEnabled){this.StopSound();e.isSoundEnabled=false}b5-=2;bi=C[B[b5]][f.STATE];e.RMS_Save();break;case STATE.SOUND_HIGH:if(GLLibPlayer.s_snd_masterVolume!=aS||!e.isSoundEnabled){GLLibPlayer.Snd_SetMasterVolume(aS);this.StopSound();this.startSound()}b5-=2;bi=C[B[b5]][f.STATE];e.RMS_Save();break;case STATE.SOUND_MEDIUM:if(GLLibPlayer.s_snd_masterVolume!=b7||!e.isSoundEnabled){GLLibPlayer.Snd_SetMasterVolume(b7);this.StopSound();this.startSound()}b5-=2;bi=C[B[b5]][f.STATE];e.RMS_Save();break;case STATE.SOUND_LOW:if(GLLibPlayer.s_snd_masterVolume!=bJ||!e.isSoundEnabled){GLLibPlayer.Snd_SetMasterVolume(bJ);this.StopSound();this.startSound()}b5-=2;bi=C[B[b5]][f.STATE];e.RMS_Save();break;case STATE.SOUND_OFF:if(e.isSoundEnabled){this.StopSound();e.isSoundEnabled=false}b5-=2;bi=C[B[b5]][f.STATE];e.RMS_Save();break}};e.prototype.UpdateGameState_MENU_EXIT=function(){switch(this.updateMenu()){case STATE.YES:bi=STATE.QUIT;break;case STATE.NO:b5-=2;bi=C[B[b5]][f.STATE];break}};var b4=0;var cE=[0,0,0];var ci=0;e.prototype.UpdateGameState_MENU_HELP=function(){if(!aw){aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0)}else{var dp=GLLibConfig.screenWidth/2;var ds=GLLibConfig.screenHeight/2;var dg=0;var dh=0;var dl=0;var dC=LowAPI.Gen_Array([4],0);var dq,dA;N.GetAFrameRect(dC,DAnimID.MENU_INGAME_INGAMEMENU,0,0,0,0);dq=dC[DEF.BOX_RIGHT]-dC[DEF.BOX_LEFT];dA=dC[DEF.BOX_BOTTOM]-dC[DEF.BOX_TOP];var dj=dp-(dq>>1);var di=ds-(dA>>1);dg=dA-DGUI.INGAMEMENU_BACKGROUND_WH;dh=di+DGUI.INGAMEMENU_BACKGROUND_XY;if(e.bIsMiniMap){this.DrawMiniMap()}else{this.gameDraw()}g.setColor(0);g.fillRect(dj,di+DGUI.INGAMEMENU_BACKGROUND_XY-13,DEF.VIEW_W,dA-DGUI.BACKGROUND_OFFSET_H);N.PaintAFrame(g,DAnimID.MENU_INGAME_INGAMEMENU,0,dj-dC[DEF.BOX_LEFT],di-dC[DEF.BOX_TOP],0)}var dy=C[B[b5]][f.TITLE_AS_PARENT];var dB=0;var dp=GLLibConfig.screenWidth/2;T=80*DScreen.RATIO;e.txtSetFont(cX);cn.SetCurrentPalette(0);if(dy>0||aw){e.txtDraw(0,Text_GetString(dy),dp,(e.bIsPaused?cu-DGUI.HELP_TITLE_OFFSET_Y:aO-T),TOP|HCENTER);dB+=0}else{if(e.bIsPaused){dB-=20*DScreen.RATIO}}this.setSoftKeys(C[B[b5]][f.LSK_TEXT],C[B[b5]][f.RSK_TEXT]);this.drawSoftKeys();var dw=1;var df=DEF.VIEW_W-130;var dv=0;var du=20;var dk=5;var dn=dp;var dm=100;var dt="";var dz;if(b4<2){if(Canvas.isTouchDevice){dz=Text_GetString(TEXT.MENU_HELP_CONTROL_TOUCH+b4)}else{if(b4==0){dz=Text_GetString(TEXT.MENU_HELP_CONTROL_KEY_MOVE)+"^"+Text_GetString(TEXT.MENU_HELP_CONTROL_KEY_JUMP)+"^"+Text_GetString(TEXT.MENU_HELP_CONTROL_KEY_CROUCH)}else{dz=Text_GetString(TEXT.MENU_HELP_CONTROL_KEY_ATTACK)+"^"+Text_GetString(TEXT.MENU_HELP_CONTROL_KEY_DJUMP)+"^"+Text_GetString(TEXT.MENU_HELP_CONTROL_KEY_OPEN_PARA)}}}else{dz=Text_GetString(TEXT.MENU_HELP_CONTROL+1)}switch(b4){case 0:case 1:dw=1;df=DEF.VIEW_W-40;dn=dp;dm=DGUI.HELP_POSY;break;case 2:dw=4;dk=15;df=DEF.VIEW_W-40;dn=dp+20*DScreen.RATIO;dm=DGUI.HELP_POSY;break}for(var dx=0;dx<dz.length;dx++){if(dz.charAt(dx)=="^"){dt=dt+"\n"}else{dt=dt+dz.charAt(dx)}}dz=dt;e.txtSetFont(aV);ci=DGUI._ICONINHELP_POSX;e.DrawMultiLineText(g,dz,dn,dm,dw,2,df,dv,du,dk);if(e.spriteArray[DSpriteID.BONUS]==null){Pack_Open(DATA.PACK_SPRITE);e.spriteLoad(DSpriteID.BONUS,DATA.SPRITE_BONUS,true,true);Pack_Close()}if(b4==2){e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_CRYSTAL,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_CRYSTAL),ci,cE[0]+DGUI.ICON_OFFSETY1,0);e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_CRYSTAL_FLOWER,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_CRYSTAL_FLOWER),ci,cE[1]+DGUI.ICON_OFFSETY2,0);e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_1UP,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_1UP),ci,cE[2]+DGUI.ICON_OFFSETY2,8)}var dr=WasAnyKeyReleased();if(dr>=0){switch(dr){case GLKey.k_menuBack:if(b5>0&&C[B[b5]][f.RSK_TEXT]!=-1){b5--;bi=C[B[b5]][f.STATE];e.txtSetFont(cX);b4=0}break;case GLKey.k_menuOK:b4=(++b4)%3;break}if(e.isAnyPointPressed()){e.UpdateKeyState();ResetKey()}}};var bD=0;var b3=0;var bI;e.prototype.UpdateGameState_MENU_ABOUT=function(){aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);var dk=C[B[b5]][f.TITLE_AS_PARENT];var dg=0;var dh=GLLibConfig.screenWidth/2;if(dk>0&&!e.bIsPaused){e.txtSetFont(cX);cn.SetCurrentPalette(0);e.txtDraw(0,Text_GetString(dk),dh,(e.bIsPaused?cu:aO-T),TOP|HCENTER);dg+=30}else{if(e.bIsPaused){dg-=20}}this.setSoftKeys(C[B[b5]][f.LSK_TEXT],C[B[b5]][f.RSK_TEXT]);this.drawSoftKeys();var dj=DEF.VIEW_W-0;var df=dh;g.setClip(0,(e.bIsPaused?cu:aO-T)+25*DScreen.RATIO,DEF.VIEW_W,DEF.VIEW_H-(e.bIsPaused?cu:aO-T)-45*DScreen.RATIO);if(bI==null){var dn=Text_GetString(TEXT.MENU_ABOUT_1);var dl;if((dl=dn.indexOf("X.X.X"))>=0){dn=dn.substring(0,dl)+e.version+dn.substring(dl+5)}bI=dn}if(bI.indexOf("^")>-1){bI=bI.replace("^","\n")}e.txtSetFont(aV);var dp=5;var dq=(DEF.VIEW_H-(e.bIsPaused?cu:aO-T)-40);dq+=(dp+aV.GetLineHeight())*2;var ds=dq/(dp+aV.GetLineHeight());var dr=Math_FixedPointToInt(bD);var dm=e.DrawMultiLineText(g,bI,df,DEF.VIEW_H-dr,GRPH.HCENTER,2,dj,b3,ds,dp);if(dm&&bD>Math_IntToFixedPoint(dq)*2){bD=0;b3=0;dr=0}bD+=Math_IntToFixedPoint(DGUI.INTERFACE_ROLL_SPEED)*e._frameDT_Real/DEF.VELOCITY_FRAME_TICK;if(!dm){if(bD>Math_IntToFixedPoint(dq)){b3++;bD-=Math_IntToFixedPoint(dp+aV.GetLineHeight())}}var di=WasAnyKeyReleased();if(di>=0){switch(di){case GLKey.k_menuBack:if(b5>0&&C[B[b5]][f.RSK_TEXT]!=-1){bI=null;b5--;bi=C[B[b5]][f.STATE];e.txtSetFont(cX);bD=0;b3=0;e.PlaySoundBGM()}break;case GLKey.k_menuOK:break}}g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H)};e.prototype.UpdateGameState_POPUP_TNB_LOADING=function(){var dp=GLLibConfig.screenWidth/2;var ds=GLLibConfig.screenHeight/2;var dg=0;var di=0;var dm=0;var dz=0;aJ.PaintAFrame(g,am,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);var dA=LowAPI.Gen_Array([4],0);var dr,dy;c8.GetAFrameRect(dA,DAnimID.MENU_INGAME_INGAMEMENU,0,0,0,0);dr=dA[DEF.BOX_RIGHT]-dA[DEF.BOX_LEFT];dy=dA[DEF.BOX_BOTTOM]-dA[DEF.BOX_TOP];var dk=dp-(dr>>1);var dj=ds-(dy>>1);dg=dy-DGUI.INGAMEMENU_BACKGROUND_WH;di=dj+DGUI.INGAMEMENU_BACKGROUND_XY;e.FillArgbRect(dk,dj+DGUI.INGAMEMENU_BACKGROUND_XY-13,DEF.VIEW_W,dy-DGUI.BACKGROUND_OFFSET_H,3355443200|aE);c8.PaintAFrame(g,DAnimID.MENU_INGAME_INGAMEMENU,0,dk-dA[DEF.BOX_LEFT],dj-dA[DEF.BOX_TOP],0);var du="";var dw=1;var df=DEF.VIEW_W;var dq=dp;var dn=DGUI.LOADING_POSY;var dv=0;var dt=20;var dl=5;var dh=Text_GetString(TEXT.MENU_TNB_WAIT);for(var dx=0;dx<dh.length;dx++){if(dh.charAt(dx)=="^"){du=du+"\n"}else{du=du+dh.charAt(dx)}}dh=du;e.txtSetFont(aV);e.DrawMultiLineText(g,dh,dq,dn,dw,2,df,dv,dt,dl);e.txtSetFont(cX);e.redrawAll=true};var aN=Math_IntToFixedPoint(DEF.VIEW_W-DGUI.BACKGROUND_OFFSET_H+15);var cV=0;var a0;var af=false;var cC=false;e.prototype.UpdateGameState_POPUP_TNB_TC=function(){var du=GLLibConfig.screenHeight/2;var dm=GLLibConfig.screenWidth/2;var dg=0;var dh=0;var ds,dB;var dC=0;var df=DEF.VIEW_W-10;var dn=dm;aJ.PaintAFrame(g,1,0,DEF.SCR_W_D2-DGUI.SPLASH_OFFSET_X,DEF.SCR_H_D2,0);var dD=LowAPI.Gen_Array([4],0);c8.GetAFrameRect(dD,DAnimID.MENU_INGAME_INGAMEMENU,0,0,0,0);ds=dD[DEF.BOX_RIGHT]-dD[DEF.BOX_LEFT];dB=dD[DEF.BOX_BOTTOM]-dD[DEF.BOX_TOP];var dj=dm-(ds>>1);var di=du-(dB>>1);e.FillArgbRect(dj,di+DGUI.INGAMEMENU_BACKGROUND_XY-13,DEF.VIEW_W,dB-DGUI.BACKGROUND_OFFSET_H,3355443200|aE);c8.PaintAFrame(g,DAnimID.MENU_INGAME_INGAMEMENU,0,dj-dD[DEF.BOX_LEFT],di-dD[DEF.BOX_TOP],0);g.setClip(0,(aO-T)+25*DScreen.RATIO,DEF.VIEW_W/2,DEF.VIEW_H-(aO-T)-45*DScreen.RATIO);a0=i;e.txtSetFont(aV);var dl=5;var dq=(DEF.VIEW_H-(aO-T)-40);dq+=(dl+aV.GetLineHeight())*2;var dA=Math_FixedPointToInt(aN);cP=true;if(bX()&&bg){if(V==null){e.createOverlayElement(dn,DGUI.BACKGROUND_OFFSET_H-15,DEF.VIEW_W,DEF.VIEW_H)}}var dx=e.DrawMultiLineText(g,a0,dn,DEF.VIEW_H-dA,GRPH.HCENTER,2,e.getAlignLineWidth(STATE.POPUP_TNB_TC,df),cV,9,dl);cP=false;if(dx&&aN>Math_IntToFixedPoint(dq)*2){aN=Math_IntToFixedPoint(dq);cV=0;dA=0}g.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);e.txtSetFont(cX);var dr=C[C[B[b5]][f.CHILD_INDEXES]];var dk=Text_GetString(dr[f.TITLE_AS_CHILD]);var dp=DEF.VIEW_H-70*DScreen.RATIO;var dw=this.txtDrawSpecialEffectWave(cF,dk,dm,dp,LEFT);var dv=LowAPI.Gen_Array([4],0);e._interface.GetAFrameRect(dv,DAnimID.INTERFACE_MENU_CURSOR,0,0,0,0);var dz=dw[0]-DGUI.MENU_ICON_OFFX;var dy=dw[1]+DGUI.MENU_ICON_OFFX;dp+=ASprite.GetCurrentStringHeight()>>1;e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_CURSOR,s_game_currentFrameNB%e._interface.GetAFrames(DAnimID.INTERFACE_MENU_CURSOR),dz,dp,0);e._interface.PaintAFrame(g,DAnimID.INTERFACE_MENU_CURSOR,s_game_currentFrameNB%e._interface.GetAFrames(DAnimID.INTERFACE_MENU_CURSOR),dy,dp,0);var dt=WasAnyKeyReleased();if(dt>=0){switch(dt){case GLKey.k_menuBack:case GLKey.k_menuOK:case GLKey.k_fire:b5--;bi=C[B[b5]][f.STATE];e.txtSetFont(cX);aN=Math_IntToFixedPoint(DEF.VIEW_W-DGUI.BACKGROUND_OFFSET_H+15);cV=0;e.removeOverlayElement();a3=Billing.getBuyString().trim().replace(/<br>/g,"\n");break;case GLKey.k_down:if(!bg){if(!(dx&&aN>Math_IntToFixedPoint(dq))){aN+=Math_IntToFixedPoint(DGUI.INTERFACE_ROLL_SPEED*4)*e._frameDT_Real/DEF.VELOCITY_FRAME_TICK;af=true}if(cC){cV++;cC=false}if(!dx){if(aN>Math_IntToFixedPoint(dq)){cV++;aN-=Math_IntToFixedPoint(dl+aV.GetLineHeight())}}}else{if(!dx||cC){if(cV==-1){cV=0}cV++;cC=false}else{af=true}}break;case GLKey.k_up:if(!bg){if(!(dx&&aN<Math_IntToFixedPoint(dq))){aN-=Math_IntToFixedPoint(DGUI.INTERFACE_ROLL_SPEED*4)*e._frameDT_Real/DEF.VELOCITY_FRAME_TICK;cC=true}if(af){af=false;cV--}if(!dx){if(aN<Math_IntToFixedPoint(dq-15)){cV--;aN+=Math_IntToFixedPoint(dl+aV.GetLineHeight())}}}else{if(!dx||af){cV--;af=false}else{cC=true}}break;default:break}}};e.prototype.UpdateGameState_IGP=function(){if(DEF.dbgEnable){Dbg("-------------------------- launch IGP ...")}var df="";if(window.location.toString().split("?").length>1){df=window.location.toString().split("?")[1]}window.open("/?"+df,"_self")};e.prototype.UpdateGameState_END_GAME_IGP=function(){g.setColor(0);g.fillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);var df=15;e.DrawMultiLineText(g,Text_GetString(TEXT.MENU_LIKEGAME),GLLibConfig.screenWidth/2,GLLibConfig.screenHeight/3,TOP|HCENTER,1,GLLibConfig.screenWidth,0,10,df);this.setSoftKeys(TEXT.MENU_SK_YES,bZ);this.drawSoftKeys();var dg=WasAnyKeyReleased();if(dg>=0){switch(dg){case GLKey.k_menuOK:bi=STATE.IGP;break}}};e.prototype.UpdateGameState_MENU_GET_MORE_GAMES_INIT=function(){bi=STATE.IGP};e.prototype.UpdateGameState_MENU_MAIN=function(){e._miniMapCursorAtPoint=-1;am=2;if(DEF.dbgEnableCheat){if((this.useCheatCode()==bi)||DEF.dbgUnlockLevel||DEF.dbgUnlockLevelButCastle){var df=e._levelInfo.length;if(DEF.dbgUnlockLevelButCastle){df=DAI.LEVEL_ID_CASTLE}for(var dg=0;dg<df;dg++){e._levelInfo[dg]=1}}}switch(this.updateMenu()){case STATE.MENU_GET_MORE_GAMES:bi=STATE.MENU_GET_MORE_GAMES_INIT;break}};e.prototype.UpdateGameState_MENU_INGAME_MAIN_MENU=function(){switch(this.updateMenu()){case STATE.YES:e.RMS_Load();this.GotoMainMenu();break;case STATE.NO:b5-=2;bi=C[B[b5]][f.STATE];break}};e.prototype.UpdateGameState_BACK_TO_MINIMAP=function(){switch(this.updateMenu()){case STATE.YES:e.RMS_Load();e.bIsPaused=false;bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;e.s_next_game_state_after_unload=STATE.MENU_MAP;break;case STATE.NO:b5-=2;bi=C[B[b5]][f.STATE];break}};e.GotoRestart=function(dl){e.bIsPaused=false;try{e.LoadUnload(DLoadState.UNLOAD_SEGMENT);e.LoadUnload(DLoadState.UNLOAD_ENTITY)}catch(di){if(DEF.dbgEnable){Dbg("GotoRestart LoadUnload----------------------- error : "+di.message)}}e.ReleaseLevel(dl);try{e.InitLevel();Pack_Open("/"+((DATA.PACK_LEVEL01_1.charAt(1)-"0")+e._tempLevelId));var dj=GLLibConfig.tileset_maxLayerCount-1;GLLibPlayer.Tileset_Destroy(dj);var dm;var dg=null;var dh=null;var dk=e.level2Tiled(e._tempLevelId,dj);var df=DATA.LEVEL01_1_TOP_SIZE;dm=Pack_ReadData(df++);dg=Pack_ReadData(df++);dh=Pack_ReadData(df++);GLLibPlayer.Tileset_LoadLayer(dj,dm,dg,dh,e.spriteArray[dk+DSpriteID.TILESET_BASE],false,TOP,GLLibPlayer.WRAP_CLAMP,GLLibPlayer.WRAP_CLAMP);GLLibPlayer.Tileset_SetCamera(dj,0,0);e._topLayerData=dg;e._topLayerFlip=dh;e.LoadUnload(DLoadState.LOAD_ENTITY);e.LoadUnload(DLoadState.LOAD_SEGMENT);Pack_Close()}catch(di){if(DEF.dbgEnable){Dbg("GotoRestart ----------------------- error : "+di.message)}}e.GotoInitLevel(dl)};e.GotoInitLevel=function(df){e.LoadCheckPoint();CEntity.CheckActive();CEntity.UpdateAll(-1);if(df){CEntity._hero._hp=CEntity._heroHpBeforeDie}else{CEntity._hero._hp=e._playerInfo[DAI.HPI_HP_MAX];CEntity._HeroParams[DAI.HPI_LIVES]=e._playerInfo[DAI.HPI_LIVES];e.RMS_Load()}CEntity._HeroParams[DAI.HPI_CRYSTAL_COUNT]=CEntity._hero._hp;e.redrawAll=true;bi=STATE.GAMEPLAY_UPDATE;if(aJ!=null){if(DEF.dbgEnable){Dbg("spriteUnLoad : ******************* -----_splash")}aJ.FreeCacheData();aJ.FreeCachedFrames();aJ.FreeCachedModules();aJ=null}c6=null;b9=null;e.PlaySoundBGM()};e.needTrans=false;e.GotoNextLevel=function(dg){e.bIsPaused=false;e._checkPointData=null;bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;if(e.needTrans){e.s_next_game_state_after_unload=STATE.LOAD_UNLOAD;e.initMenus()}else{e.s_next_game_state_after_unload=STATE.MENU_MAP}if(e._tempLevelId==DAI.LEVEL_ID_INTRO_NEW_GAME){e._tempLevelId=0;e.s_next_game_state_after_unload=STATE.MENU_MAP}else{if(!e.needTrans&&e._tempLevelId==DAI.LEVEL_ID_CASTLE_FINAL_BOSS){e._tempLevelId=DAI.LEVEL_ID_INTRO_THE_END;e.s_next_game_state_after_unload=STATE.LOAD_UNLOAD;e.initMenus()}else{if(e._tempLevelId==DAI.LEVEL_ID_INTRO_THE_END){e.initMenus();e.s_next_game_state_after_unload=STATE.GAMEEND;B[++b5]=v}else{if(dg&&(e._tempLevelId+1<cj.LEVEL_INFO_NUM)){e._levelInfo[e._tempLevelId+1]=1}}}}if(e.needTrans){var df=0;while(CEntity._miniGameTriger!=null&&true){if((CEntity._miniGameTriger._params[DParamIndex.TRIGGER_TRANSPORT_WORLD]>>df)==1){break}df++}if(CEntity._miniGameTriger!=null){e._worldId=df-1;e._tempLevelId=e._worldId*DAI.LEVELS_NUM_PRE_WORLD+CEntity._miniGameTriger._params[DParamIndex.TRIGGER_TRANSPORT_LEVEL]}}e.needTrans=false;e.RMS_Save()};e.prototype.GotoMainMenu=function(){e.bIsMainMain=true;e.bIsPaused=false;bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;e.s_next_game_state_after_unload=STATE.MENU_INIT;e.initMenus();e.PlaySound(DSound_Channel.BGM,DATA.SOUND_BGM_MAIN_MENU)};e.GotoEndGameIGP=function(){e.bIsPaused=false;bi=STATE.LOAD_UNLOAD;e.loadingPhase=-DLoadState.LOAD_OVER;e.s_next_game_state_after_unload=STATE.END_GAME_IGP};e.prototype.UpdateGameState_GAMEPLAY_UPDATE=function(){if(bq){e.initIngameMenu(STATE.MENU_INGAME);return}DTimer.resetAll();DTimer.startTimer(DTimer.INDEX_AI);this.gameUpdate();if(bi==STATE.GAMEPLAY_UPDATE){DTimer.endTimer(DTimer.INDEX_AI);DTimer.startTimer(DTimer.INDEX_DRAW);this.gameDraw();if(!e.InCinemitic()){this.DrawInterface();if(this.GetLevelTextByLevelId(e._tempLevelId)!=TEXT.MENU_SELECT_WORLD){if(e._specialEffectStep<=e.EFFECT_OVER){var dg=DEF.VIEW_W_D2;var df=120*DScreen.RATIO;this.DrawIntroAnimation(Text_GetString(this.GetLevelTextByLevelId(e._tempLevelId)),dg,df,0)}}}else{cX.SetCurrentPalette(0);cX.DrawString(g,Text_GetString(TEXT.MENU_SK_SKIP),DEF.VIEW_W,DEF.VIEW_H,GRPH.RIGHT_BOTTOM)}if(!e.bIsPaused){e._interface.PaintAFrame(g,DAnimID.INTERFACE_IGM,s_game_currentFrameNB%e.spriteArray[DSpriteID.INTERFACE].GetAFrames(DAnimID.INTERFACE_IGM),DGUI.INTERFACE_IGM_OFFSET_X,DEF.VIEW_H-DGUI.INTERFACE_LEFTSOFTKEY_OFFSET_Y,0)}this.DrawWeatherEffect();this.DrawFadeEffect();DTimer.endTimer(DTimer.INDEX_DRAW);DTimer.drawTimers(g);if(L){e.drawTheCurtainOpen()}}};e._firstEnterIntoThisFunction=true;e._specialEffectStep=0;e.EFFECT_DOWNING_INTO_SCREEN=0;e.EFFECT_FLOWING_OUTOF_SCREEN=1;e.EFFECT_OVER=2;e._explode_step=0;e._lastFrameNB=0;var ad=null;e._stringFrameLength=0;e.prototype.DrawIntroAnimation=function(dg,dk,dj,dh){e.textChars=dg.split("");var df=0;switch(e._specialEffectStep){case e.EFFECT_DOWNING_INTO_SCREEN:var di=e.txtDrawSpecialEffectFlowFromTheSky(df,dg,dk,dj,dh);if(di){e._lastFrameNB=s_game_currentFrameNB;e._specialEffectStep++}break;case e.EFFECT_FLOWING_OUTOF_SCREEN:if(s_game_currentFrameNB-e._lastFrameNB>20){e._currentPosX-=20}e.txtDrawSpecialEffectFlowFromTheSky(df,dg,dk+e._currentPosX,dj,dh);if(e._currentPosX<-240){e._specialEffectStep++}break;case e.EFFECT_OVER:e._specialEffectStep++;e._explode_step=0;e._currentPosX=0;e._currentPosY=0;break;default:}};e.prototype.UpdateGameState_K_MRC_INIT=function(){if(Build.useCGMRC){s_License=new License(s_application);if(s_License.isLicenseValid()){bi=e.s_next_state;if(DEF.dbgEnable){Dbg("VALID")}}else{s_License.sendValidateLicense();bi=STATE.K_MRC_VALIDATING;if(DEF.dbgEnable){Dbg("go to VALIDATING")}}}};e.prototype.UpdateGameState_K_MRC_VALIDATING=function(){if(Build.useCGMRC){SetClip(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);SetColor(0);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);var dg=cn.WraptextB(Text_GetString(TEXT.INIT_MRC_VALIDATING),GLLibConfig.screenWidth,GLLibConfig.screenHeight);cn.DrawPageB(g,Text_GetString(TEXT.INIT_MRC_VALIDATING),dg,GLLibConfig.screenWidth>>1,(GLLibConfig.screenHeight>>1),0,10,Graphics.HCENTER|Graphics.VCENTER);if(GLLibConfig.softkeyOKOnLeft){e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_EXIT),1,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.LEFT)}else{e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_EXIT),GLLibConfig.screenWidth-1,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.RIGHT)}if(WasKeyPressed(GLKey.k_menuBack)){if(DEF.dbgEnable){Dbg("k_mrc_validating MENU_CANCEL")}s_License.cleanup();s_License=null;bi=STATE.QUIT}else{if(s_License.handleValidateLicense()==true){if(DEF.dbgEnable){Dbg("k_mrc_validating handleValidateLicense")}var df=s_License.getLastError();if(DEF.dbgEnable){Dbg(""+df)}s_License.cleanup();switch(df){case XPlayer.Error.ERROR_NONE:if(s_License.isLicenseValid()){bi=e.s_next_state}else{bi=STATE.K_MRC_EXPIRED}break;case XPlayer.Error.ERROR_CONNECTION:bi=STATE.K_MRC_NETWORK_FAILED;break;default:if(DEF.dbgEnable){Dbg("UNKNOWN MRC ERROR : "+df)}bi=STATE.QUIT;break}}}}};e.prototype.UpdateGameState_K_MRC_EXPIRED=function(){if(Build.useCGMRC){SetClip(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);SetColor(0);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);var df=cn.WraptextB(Text_GetString(TEXT.INIT_MRC_EXPIRED),GLLibConfig.screenWidth,GLLibConfig.screenHeight);cn.DrawPageB(g,Text_GetString(TEXT.INIT_MRC_EXPIRED),df,GLLibConfig.screenWidth>>1,(GLLibConfig.screenHeight>>1),0,10,Graphics.HCENTER|Graphics.VCENTER);if(GLLibConfig.softkeyOKOnLeft){e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_EXIT),1,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.LEFT)}else{e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_EXIT),GLLibConfig.screenWidth,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.RIGHT)}if(WasKeyPressed(GLKey.k_menuBack)){bi=STATE.QUIT}}};e.prototype.UpdateGameState_K_MRC_NETWORK_FAILED=function(){if(Build.useCGMRC){SetClip(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);SetColor(0);FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);var df=cn.WraptextB(Text_GetString(TEXT.INIT_MRC_NETWORK_FAILED),GLLibConfig.screenWidth,GLLibConfig.screenHeight);cn.DrawPageB(g,Text_GetString(TEXT.INIT_MRC_NETWORK_FAILED),df,(GLLibConfig.screenWidth>>1),(GLLibConfig.screenHeight>>1),0,10,Graphics.HCENTER|Graphics.VCENTER);if(GLLibConfig.softkeyOKOnLeft){e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_RETRY),GLLibConfig.screenWidth,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.RIGHT);e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_EXIT),1,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.LEFT)}else{e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_RETRY),1,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.LEFT);e.txtDraw(0,Text_GetString(TEXT.INIT_MRC_EXIT),GLLibConfig.screenWidth,GLLibConfig.screenHeight-1,Graphics.BOTTOM|Graphics.RIGHT)}if(WasKeyPressed(GLKey.k_menuBack)){bi=STATE.QUIT}else{if(WasKeyPressed(GLKey.k_menuOK)){bi=STATE.K_MRC_INIT}}}};var c3="SCOMSAV";e.RMS_Save=function(){if(DEF.dbgEnable){Dbg("Saving RMS...")}var dg=LowAPI.Gen_Array([cj.SIZE],0);if(e.isFullGame()){dg[cj.LANGUAGE]=e.curLanguage}dg[cj.SOUND_ENABLED]=(e.isSoundEnabled?1:0);dg[cj.GAME_PROGRESS]=e._gameProgress;dg[cj.LEVEL_INDEX]=e._levelId;dg[cj.LEVEL_INFO_STRAT]=1;for(var df=1;df<cj.LEVEL_INFO_NUM;df++){dg[cj.LEVEL_INFO_STRAT+df]=e._levelInfo[df]}dg[cj.LEVEL_FINAL_INFO1]=e._levelFinalInfo1;dg[cj.LEVEL_FINAL_INFO2]=e._levelFinalInfo2;for(var df=0;df<cj.PLAYER_INFO_NUM;df++){dg[cj.PLAYER_INFO_STRAT+df]=e._playerInfo[df]}var dh=cj.LEVEL_STAR_INFO_START;for(var df=0;df<cj.LEVEL_STAR_INFO_NUM;df++){Mem_SetShort(dg,dh,e._levelStarInfo[df]);dh+=2}dh=cj.LEVEL_TOTAL_SCORE_START;for(var df=0;df<cj.LEVEL_TOTAL_SCORE_NUM;df++){Mem_SetInt(dg,dh,e._levelTotalScore[df]);dh+=4}dg[cj.TNB_TRIALS]=e.currentTrials;dg[cj.TNB_BILLING_FAILED]=e.bIsBillingFailed;Rms_Write(c3,dg)};e.RMS_Load=function(){if(DEF.dbgEnable){Dbg("Loading RMS...")}var di=Rms_Read(c3);if(!e.isFullGame()){e.bSetLanguage=true}if(di==null||di.length==0){e.RMS_Init();e.isSoundEnabled=true;e.RMS_Save()}else{if(e.isFullGame()){e.curLanguage=di[cj.LANGUAGE]}e.isSoundEnabled=di[cj.SOUND_ENABLED]==1;e._gameProgress=di[cj.GAME_PROGRESS];e._levelId=(di[cj.LEVEL_INDEX]==255)?-1:di[cj.LEVEL_INDEX];for(var dg=0;dg<cj.LEVEL_INFO_NUM;dg++){e._levelInfo[dg]=di[cj.LEVEL_INFO_STRAT+dg]}e._levelFinalInfo1=di[cj.LEVEL_FINAL_INFO1];e._levelFinalInfo2=di[cj.LEVEL_FINAL_INFO2];for(var dg=0;dg<cj.PLAYER_INFO_NUM;dg++){e._playerInfo[dg]=di[cj.PLAYER_INFO_STRAT+dg]}var dj=cj.LEVEL_STAR_INFO_START;for(var dg=0;dg<cj.LEVEL_STAR_INFO_NUM;dg++){e._levelStarInfo[dg]=Mem_GetShort(di,dj);dj+=2}dj=cj.LEVEL_TOTAL_SCORE_START;for(var dg=0;dg<cj.LEVEL_TOTAL_SCORE_NUM;dg++){e._levelTotalScore[dg]=Mem_GetInt(di,dj);dj+=4}var df=di[cj.TNB_TRIALS];e.currentTrials=(isNaN(df)?a:df);var dh=di[cj.TNB_BILLING_FAILED];e.bIsBillingFailed=(isNaN(dh)?false:dh)}};e.RMS_Init=function(){if(DEF.dbgEnable){Dbg("Initializing RMS...")}e.bSetLanguage=(Language.count>1)?true:false;e.curLanguage=0;e._gameProgress=o;e._levelId=255;e._levelInfo[0]=1;GLLibPlayer.Snd_SetMasterVolume(aS);var dg=0;if(DEF.dbgUnlockLevel){dg=1}for(var df=1;df<cj.LEVEL_INFO_NUM;df++){e._levelInfo[df]=dg}e._levelFinalInfo1=0;e._levelFinalInfo2=0;for(var df=0;df<cj.PLAYER_INFO_NUM;df++){e._playerInfo[df]=0}e._playerInfo[DAI.HPI_LIVES]=3;e._playerInfo[DAI.HPI_HP_MAX]=0;for(var df=0;df<e._levelStarInfo.length;df++){e._levelStarInfo[df++]=DAI.MAX_STAR_NUM;e._levelStarInfo[df++]=0;e._levelStarInfo[df++]=0;e._levelStarInfo[df++]=0;e._levelStarInfo[df++]=0;e._levelStarInfo[df++]=0;e._levelStarInfo[df]=0}for(var df=0;df<e._levelTotalScore.length;df++){e._levelTotalScore[df]=0}e.RMS_Save();e._levelId=-1;e._worldId=0};e.prototype.RMS_Reset=function(){if(DEF.dbgEnable){Dbg("Resetting game-specific RMS...")}};var an=null;var c1=null;e.spriteArray=LowAPI.Gen_Array([128],null);e.blendSpriteArray;var a4=null;var bK=false;var cn;var bu;e.m_chtFont;var cX;var aV;var E=false;e.prototype.fontLoad=function(){var di=an[e.curLanguage];bK=false;E=false;if(bK){bu=LowAPI.Gen_Array([2],0);bu[0]=16711680;bu[1]=65280}if(DEF.dbgEnable){Dbg("opening font pack")}if(E){cX=new CHT_ASprite();aV=new CHT_ASprite()}else{cX=new ASprite();aV=new ASprite()}if(DEF.dbgEnable){Dbg("reading font pack")}var dh,dg,df,dj;if(di==GLLang.RU){dh=DATA.PACK_FONT_EN;dg=DATA.FONT_EN_01;df=DATA.FONT_EN_02;dj=DATA.FONT_EN_TABLE}else{if(di==GLLang.CN){dh=DATA.PACK_FONT_CN;dg=DATA.FONT_CN_01;df=DATA.FONT_CN_02;dj=DATA.FONT_CN_TABLE}else{dh=DATA.PACK_FONT_EN;dg=DATA.FONT_EN_01;df=DATA.FONT_EN_02;dj=DATA.FONT_EN_TABLE}}Pack_Open(dh);cX=e.Load_TextFontSprite(dg,dj);Pack_Close();Pack_Open(dh);aV=e.Load_TextFontSprite(df,dj);Pack_Close();e.txtSetFont(cX)};e.Load_TextFontSprite=function(dk,di){var dj=false;var dh=false;var dm=new ASprite();dm.Load(Pack_ReadData(dk),0);var dl=Pack_ReadArray(di);dm.SetCharMap(dl);var dg=dm.GetNumPalettes();for(var df=0;df<dg;df++){if(dj){dm.BuildCacheImages(df,0,-1,-1);dm.BuildCacheFrames(df,0,-1)}else{dm.BuildCacheImages(df,0,-1,-1)}}if(dj){dm.PushCacheFramesToGL()}else{dm.PushCacheImagesToGL()}if(dj){dm.FreeCachedModules()}else{dm.FreeCachedFrames()}if(dh){dm.FreeCacheData()}return dm};e.txtSetFont=function(df){cn=df};e.txtDraw=function(df,di,dj,dh,dg){e.txtDraw7(df,di,dj,dh,dg,-1,-1)};e.txtDraw7=function(dg,dj,dl,di,dh,dk,df){if(bK){SetColor(bu[dg]);DrawString(dj,dl,di,dh)}else{cn.SetSubString(dk,df);cn.SetCurrentPalette(dg);cn.DrawString(g,dj,dl,di,dh)}};var cw=0;e.prototype.txtDrawSpecialEffectWave=function(di,dr,dh,dg,dl){var ds=(dr==null)?0:dr.length;var dq=dh;var dn=dg;var df=0;var dk=[dg,dg-1,dg-1,dg-2,dg-2,dg-1,dg-1,dg,dg,dg+1,dg+1,dg+2,dg+2,dg+1,dg+1,dg];cn.SetCurrentPalette(di);for(var dj=0;dj<ds;dj++){df+=cn.getCharSize(dr.charAt(dj))}var dm=LowAPI.Gen_Array([2],0);dq=(GLLibConfig.screenWidth-df)/2;dm[0]=dq;cw=(++cw)%dk.length;var dp=false;for(var dj=0;dj<ds;dj++){dn=dk[(cw+dj)%dk.length];cn.DrawString(g,dr.charAt(dj),dq,dn,dl);dq+=cn.getCharSize(dr.charAt(dj))}dm[1]=dq;return dm};var c0;e.prototype.txtDrawSpecialEffectWave_New=function(dk,dr,dh,dg,dj,dn,dm){var ds=dr.length;var dq=dh;var dp=dg;var df=0;var di=LowAPI.Gen_Array([dj*4],0);for(var dl=0;dl<dj*4;dl++){if(dl<dj*2){di[dl]=dg-(dj-Math_Abs(dl-dj))-1}else{di[dl]=dg+(dj-Math_Abs(dl-3*dj))+1}}cn.SetCurrentPalette(dk);for(var dl=0;dl<ds;dl++){df+=cn.getCharSize(dr.charAt(dl))}dq=(GLLibConfig.screenWidth-df)/2;cw=(++cw)%di.length;for(var dl=0;dl<ds;dl++){dp=di[(cw+dl)%di.length];cn.DrawString(g,(dr.charAt(dl)),dq,dp,dm);dq+=cn.getCharSize(dr.charAt(dl))}c0=0};e._actionSpeed;e._xCurrent;e._yCurrent;e._stopAdd;e._stopAdd2;e.txtDrawSpecialEffectCongregate_NEW=function(dl,dv,dh,dg,dr){var dw=dv.length;var dk=dv.split("");var dj;var du=0;var df=0;var dq=0;var dt=0;var dn=0;var di=LowAPI.Gen_Array([dw],0);var ds=0;var dm=0;for(var dp=0;dp<dw;dp++){du=cn.getCharSize(dk[dp]);df+=du;if(dk[dp]=="^"){dn=dp+1;dq=df}if(dp>0){di[dp]=di[dp-1]+dp*2+9}else{di[dp]=df+200}}dt=df-dq;if(bK){SetColor(bu[dl]);DrawString(dv,dh,dg,dr)}else{for(var dp=0;dp<dw;dp++){if(dn<=dp){dm=dg+25;df=dt;ds=dn}else{df=dq;ds=0;dm=dg+10}dj=e.getTheFinalPosOfCurrentChar(dk,ds,dp)+(GLLibConfig.screenWidth-df)/2;e._xCurrent=di[dp]-e._actionSpeed;if(e._xCurrent<=dj){e._xCurrent=dj;if(dp==dw-1){e._stopAdd2=true}}cn.SetCurrentPalette(0);cn.SetSubString(dp,dp+1);cn.DrawStringOrChars(g,null,dk,e._xCurrent,dm,dr,true);cn.SetSubString(-1,-1)}}if(!e._stopAdd2){e._actionSpeed+=40}};var aR=-1;var au=1;var I=0;var bk=0;var cZ=0;var cR=0;var aU;var bv;e.textChars=null;var aK;var a6=null;var aY=null;var aX=null;var ba=null;e.prototype.txtDarwSpecialEffecFlowIntoTheScreen=function(dn,ds,dj,di,dE,dy,dx,dh){var dA=0;var dp=0;var dr=dn.length;var dg;var df=0;var dk=0;var du=0;if(e._firstEnterIntoThisFunction){e._firstEnterIntoThisFunction=false;e._stopAdd=false;e._actionSpeed=0;e._stringFrameLength=0;ad=LowAPI.Gen_Array([dr],0);aK=1;e.textChars=dn.split("");for(var dw=0;dw<dr;dw++){if(e.textChars[dw]=="^"){e.textChars[dw]=" "}}var dz=0;var dl=0;var dq=LowAPI.Gen_Array([3],0);var dm=0;for(var dw=0;dw<dr;dw++){df=ds.getCharSize(e.textChars[dw]);dz+=df;if(dz>dy){if(e.textChars[dl]==" "){e.textChars[dl]="^"}else{if(e.textChars[dl]=="-"){if(dm<3){dq[dm]=dl;dm++}}}dz=0;++aK;if(dw!=dr-1){dw=dl}continue}if(e.textChars[dw]==" "||e.textChars[dw]=="-"){dl=dw}}dz=0;a6=LowAPI.Gen_Array([aK],0);aY=LowAPI.Gen_Array([aK],0);aX=LowAPI.Gen_Array([aK],0);ba=LowAPI.Gen_Array([aK],false);a6[0]=0;var dt=0;for(var dw=0;dw<dr;dw++){df=ds.getCharSize(e.textChars[dw]);dz+=df;if(e.textChars[dw]=="^"||e.textChars[dw]=="-"){var dC=false;if(e.textChars[dw]=="-"){for(var dv=2;dv>=0;dv--){if(dq[dv]==dw){dC=true}}}else{dC=true}if(dC){a6[dt+1]=dw+1;aY[dt]=dw-1;ba[dt]=false;aX[dt]=dz-df;dt++;dz=0}}if(dw==dr-1){aX[dt]=dz;aY[dt]=dw}}if(dE==au){dt=0;var dD=0;for(var dw=0;dw<dr;dw++){df=ds.getCharSize(e.textChars[dw]);e._stringFrameLength+=df;if(e.textChars[dw]=="^"){dD=a6[dt]-1;dt++;e._stringFrameLength=0;ad[dw]=DEF.VIEW_W;continue}if(dw>0){ad[dw]=ad[dw-1]+(dw-a6[dt])*df+2}else{ad[dw]=e._stringFrameLength+DEF.VIEW_W}}}else{if(dE==aR){dt=aK-1;var dD=0;for(var dw=dr-1;dw>=0;dw--){df=ds.getCharSize(e.textChars[dw]);e._stringFrameLength+=df;if(e.textChars[dw]=="^"){dD=a6[dt]-1;dt--;e._stringFrameLength=0;ad[dw]=0;continue}if(dw<dr-1){ad[dw]=ad[dw+1]-(((dD)-dw)*df+2)}else{ad[dw]=0-e._stringFrameLength;dD=dw}}}}}if(bK){SetColor(bu[dA]);DrawString(dn,dj,di,dh)}else{if(dE==au){for(var dw=0;dw<dr;dw++){for(var dv=0;dv<aK;dv++){if(dw>=a6[dv]){dk=a6[dv];e._stringFrameLength=aX[dv];du=di+15+(6+ASprite.GetCurrentStringHeight())*dv}}dg=e.getTheFinalPosOfCurrentChar(e.textChars,dk,dw)+(GLLibConfig.screenWidth-e._stringFrameLength)/2;e._xCurrent=ad[dw]-e._actionSpeed;if(e._xCurrent<=dg){e._xCurrent=dg;dp=dw;var dB=true;for(var dv=0;dv<aK;dv++){if(dw==aY[dv]){ba[dv]=true}dB=dB&ba[dv]}if(dB){e._stopAdd=true}}ds.SetSubString(dw,dw+1);ds.DrawStringOrChars(g,null,e.textChars,e._xCurrent,du,dh,true);ds.SetSubString(-1,-1)}}else{if(dE==aR){for(var dw=dr-1;dw>=0;dw--){for(var dv=0;dv<aK;dv++){if(dw>=a6[dv]){dk=a6[dv];e._stringFrameLength=aX[dv];du=di+15+(6+ASprite.GetCurrentStringHeight())*dv}}dg=e.getTheFinalPosOfCurrentChar(e.textChars,dk,dw)+(GLLibConfig.screenWidth-e._stringFrameLength)/2;e._xCurrent=ad[dw]+e._actionSpeed;if(e._xCurrent>=dg){e._xCurrent=dg;dp=dw;var dB=true;for(var dv=0;dv<aK;dv++){if(dw==a6[dv]){ba[dv]=true}dB=dB&ba[dv]}if(dB){e._stopAdd=true}}ds.SetSubString(dw,dw+1);ds.DrawStringOrChars(g,null,e.textChars,e._xCurrent,du,dh,true);ds.SetSubString(-1,-1)}}else{if(dE==I){for(var dw=dr-1;dw>=0;dw--){for(var dv=0;dv<aK;dv++){if(dw>=a6[dv]){dk=a6[dv];e._stringFrameLength=aX[dv];du=di+15+(6+ASprite.GetCurrentStringHeight())*dv}}dg=e.getTheFinalPosOfCurrentChar(e.textChars,dk,dw)+(GLLibConfig.screenWidth-e._stringFrameLength)/2;ds.SetSubString(dw,dw+1);ds.DrawStringOrChars(g,null,e.textChars,dg,du,dh,true);ds.SetSubString(-1,-1)}}}}}if(!e._stopAdd){e._actionSpeed+=dx}return dp};var ch=0;var cN=255;e._popUpEnded=false;e._initArrayForPalette=true;var dd=5;e.txtDrawSpecialEffectPopUp=function(di,dp,dg,df,dj,dh,dm,dk){var dn=df-dj;var dl=dm;if(dh<=0){dh=1}e.txtSetFont(cX);if(e._initArrayForPalette&&E){e.CreateAlphaPalette(cn,di,4,255,false);e._initArrayForPalette=false}cn.SetCurrentPalette(4);cn.ModifyPaletteAlpha(4,cN);if(E){cn.CHT_ModifyPaletteAlpha(cn._nModules,4,cN)}if(!e._popUpEnded){if(!e.bIsPaused){ch-=dd}e.txtDraw(4,dp,dg,df+ch,dk)}if(ch+df<=dn){cN-=15;dd=1}if(ch+df<=df-dl){e._initArrayForPalette=true;e._popUpEnded=true;ch=0;cN=255;dd=dh}};e._currentPosX=0;e._currentPosY=0;e.txtDrawSpecialEffectFlowFromTheSky=function(dh,dm,dg,df,di){e._currentPosY+=20;if(e._currentPosY>=df){e._currentPosY=df}var dk=1;var dn=0;var dp=10;var dl=5;var dj=DEF.VIEW_W-20;e.DrawMultiLineText(g,dm,dg,e._currentPosY,dk,2,dj,dn,dp,dl);if(e._currentPosY==df){return true}else{return false}};e.txtDrawSpecialEffectFlowFromLeft=function(dl,dv,dh,dg,dr){var dw=dv.length;var dk=dv.split("");var dj;var du=0;var df=0;var dq=0;var dt=0;var dn=0;var di=LowAPI.Gen_Array([dw],0);var ds=0;var dm=0;for(var dp=0;dp<dw;dp++){du=cn.getCharSize(dk[dp]);df+=du;if(dk[dp]=="^"){dn=dp+1;dq=df}if(dp>0){di[dp]=di[dp-1]+dp*2+9}else{di[dp]=df+200}}dt=df-dq;if(bK){SetColor(bu[dl]);DrawString(dv,dh,dg,dr)}else{for(var dp=0;dp<dw;dp++){if(dn<=dp){dm=dg+25;df=dt;ds=dn}else{df=dq;ds=0;dm=dg+10}dj=e.getTheFinalPosOfCurrentChar(dk,ds,dp)+(GLLibConfig.screenWidth-df)/2;e._xCurrent=di[dp]-e._actionSpeed;if(e._xCurrent<=dj){e._xCurrent=dj;if(dp==dw-1){e._stopAdd=true}}cn.SetCurrentPalette(0);fontSprite.SetSubString(dp,dp+1);cn.DrawStringOrChars(g,null,dk,e._xCurrent,dm,dr,true);fontSprite.SetSubString(-1,-1)}}if(!e._stopAdd){e._actionSpeed+=40}};e.getTheFinalPosOfCurrentChar=function(dm,dk,dg){var di=0;var dj;var df=0;var dl=dm;for(var dh=dk;dh<dg;dh++){dj=cn.getCharSize(dl[dh]);df+=dj}di=df;return di};e.LoadSprite=function(){if(arguments){switch(arguments.length){case 4:return e.LoadSprite4.apply(this,arguments);case 5:if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"&&typeof arguments[2]=="number"){e.LoadSprite5v.apply(this,arguments);break}else{return e.LoadSprite5.apply(this,arguments)}case 6:return e.LoadSprite6.apply(this,arguments);case 8:return e.LoadSprite8.apply(this,arguments)}}else{throw new Error("InvalidArguments")}};var c4=0;var bH=1;var ag=2;e.LoadSprite5v=function(dj,di,df,dh,dg){if(e.spriteArray[dj]==null){e.spriteArray[dj]=e.LoadSprite4(di,df,dh,dg)}};e.LoadSprite5=function(df,dh,dj,dg,di){return e.LoadSprite8(df,dh,c4,0,dj,dg,di,true)};e.LoadSprite6=function(dg,di,dk,dh,dj,df){return e.LoadSprite8(dg,di,c4,0,dk,dh,dj,df)};e.LoadSprite4=function(df,dh,di,dg){return e.LoadSprite8(df,dh,c4,0,di,dg,false,true)};e.LoadSprite8=function(dq,dj,dr,dp,df,dh,dt,dm){var ds=new ASprite();var dn=null;dn=Pack_ReadData(dq);if(dn.length==0){return null}if(ds.Load(dn,0)===false){Err("load sprite error");return null}if(dj==-1){dj=0;for(var dl=0;dl<ds._palettes;dl++){dj|=(1<<dl)}}var dk=false;if(dq==DATA.SPRITE_MOBS_CANNON||dq==DATA.SPRITE_OBJ_BALANCE){if(DEF.dbgEnable){Dbg("=================================== cache frame sprite mobs_cannon.")}dk=true}var di=false;for(var dg=0;(dj>>dg)!=0;dg++){if(((dj>>dg)&1)!=0){if(dr!=c4){if(dr==bH){ds.ModifyPaletteAlpha(dg,dp)}else{if(dr==ag){ds.ModifyPaletteAlphaUsingLastPalette(dg)}}}if(di||dk){ds.BuildCacheImages(dg,0,-1,-1);if(dk){switch(dq){case DATA.SPRITE_MOBS_CANNON:ds.BuildCacheFrames(dg,20,25);ds.BuildCacheFrames(dg,17,17);break;case DATA.SPRITE_OBJ_BALANCE:ds.BuildCacheFrames(dg,0,1);break;default:break}}else{ds.BuildCacheFrames(dg,0,-1)}}else{ds.BuildCacheImages(dg,0,-1,-1)}}}if(dk){ds.PushCacheFramesToGL()}if(di){ds.PushCacheFramesToGL()}else{ds.PushCacheImagesToGL()}if(df&&dh){ds.FreeCacheData()}else{if(!dh&&dm&&(ds._data_format==ASprite.ENCODE_FORMAT_I256)){ds.ConvertCompressedData_I256_I256RLE(true)}}dn=null;return ds};e.spriteLoad=function(df,dg,di,dh){if(df==DATA.SPRITE_HERO&&e.spriteArray[df]!=null){return}e.LoadSprite(df,dg,-1,di,!dh)};e.spriteUnLoad=function(df){if(df==DATA.SPRITE_MOBS_WHITE||df==DATA.SPRITE_BONUS){if(DEF.dbgEnable){Dbg("spriteUnLoad : ******************* IGNORE --- "+df)}return}if(e.spriteArray[df]!=null){if(df!=DATA.SPRITE_HERO){if(DEF.dbgEnable){Dbg("spriteUnLoad : ******************* "+df)}e.spriteArray[df].FreeCacheData();e.spriteArray[df].FreeCachedFrames();e.spriteArray[df].FreeCachedModules();e.spriteArray[df]=null}}};e._loadingSpriteMap=[DSpriteID.MOBS_WHITE,DAnimID.MOBS_WHITE_WALK,DSpriteID.SEAGULL,DAnimID.SEAGULL_FLY,DSpriteID.HERO,DAnimID.HERO_FAT_WALK,DSpriteID.MOBS_UFO,DAnimID.MOBS_UFO_MOVE,DSpriteID.BOSS_WATCH,DAnimID.BOSS_WATCH_LAUGH];e.level2Tiled=function(dh,dg){var df=e._tempLevelId;return e._level2tiled[(df*(GLLibConfig.tileset_maxLayerCount))+dg]};e._optimizeSprite=[DATA.SPRITE_GAMELOFT_LOGO,DATA.SPRITE_LV1_ELEMENTS,DATA.SPRITE_MOBS_YETI,DATA.SPRITE_MOBS_PENGUIN,DATA.SPRITE_ACTOR_SNOWMAN];e.LoadUnload=function(dC){switch(dC){case 0:e._actionSpeed=0;e._firstEnterIntoThisFunction=true;e._stopMove=false;e._stopAdd=false;e._moveSpeed=0;if(e._tempLevelId>DAI.LEVEL_ID_CASTLE_FINAL_BOSS){e._specialEffectStep=e.EFFECT_OVER}else{e._specialEffectStep=e.EFFECT_DOWNING_INTO_SCREEN}dC=DLoadState.LOAD_TEXT;GLLibPlayer.Snd_Stop(DSound_Channel.BGM);case DLoadState.LOAD_TEXT:e.InitLevel();Text_LoadTextFromPack_INI(a4,DATA.TEXT_MENU);break;case DLoadState.UNLOAD_TEXT:e.ReleaseLevel(false);e._checkPointData=null;e._actionSpeed=0;e._firstEnterIntoThisFunction=true;e._stopMove=false;e._stopAdd=false;e._moveSpeed=0;break;case DLoadState.LOAD_TILESET:if(DEF.dbgEnable){Dbg("loading tilesets")}Pack_Open(DATA.PACK_TILESET);for(var dE=0;dE<GLLibConfig.tileset_maxLayerCount;dE++){var dh=e.level2Tiled(e._tempLevelId,dE);if(dh!=-1&&dE!=1){var dH=true;var du=true;var dL=dh;dL-=Math.floor(dh/GLLibConfig.tileset_maxLayerCount);if(dh==DClassID.BG_6-DClassID.BTM){dL++}if(DEF.dbgEnable){Dbg("loading tilesets ------------------------------ i : "+dE)}e.spriteLoad(dh+DSpriteID.TILESET_BASE,dE>1?dL-1:dL,dH,du)}}Pack_Close();GLLibPlayer.Tileset_Init(DGUI.SCREEN_WIDTH_FORTILE,DGUI.SCREEN_HEIGHT_FORTILE,DEF.TILE_W,DEF.TILE_H);var dN;var dp=null;var dA=null;var dw=10000;for(var dE=0;dE<GLLibConfig.tileset_maxLayerCount;dE++){if(dE==0){var dq=(DATA.PACK_LEVEL01_B.charAt(1)-"0")*10+(DATA.PACK_LEVEL01_B.charAt(2)-"0");if(e._tempLevelId>DAI.LEVEL_ID_CASTLE_FINAL_BOSS){dq+=DAI.WORLD_ID_PIRATE}else{if(e._tempLevelId>DAI.LEVELS_NUM_PRE_WORLD*DAI.WORLD_ID_CASTLE){dq+=e._tempLevelId-DAI.LEVELS_NUM_PRE_WORLD*DAI.WORLD_ID_CASTLE-1}else{dq+=Math.floor(e._tempLevelId/DAI.LEVELS_NUM_PRE_WORLD)}}Pack_Open("/"+dq)}else{if(dE==2){Pack_Close();var dq=(DATA.PACK_LEVEL01_1.charAt(1)-"0")+e._tempLevelId;if(e._tempLevelId>DAI.LEVEL_ID_CASTLE_FINAL_BOSS){dq=(DATA.PACK_INTRO_1.charAt(1)-"0")+e._tempLevelId-DAI.LEVEL_ID_INTRO_NEW_GAME}Pack_Open("/"+dq)}}var dh=e.level2Tiled(e._tempLevelId,dE);if(dh==-1||dE==1){continue}var dj=GLLibPlayer.WRAP_CLAMP;var dK=false;if(dE==0){dK=true}if(dh==DClassID.BG_6-DClassID.BTM){dj=GLLibPlayer.WRAP_REPEAT}var dt;if(dE>1){dt=(dE-2)*3}else{dt=dE*3}dN=Pack_ReadData(dt++);dp=Pack_ReadData(dt++);dA=Pack_ReadData(dt++);GLLibPlayer.Tileset_LoadLayer(dE,dN,dp,dA,e.spriteArray[dh+DSpriteID.TILESET_BASE],dK,TOP,dj,dj);GLLibPlayer.Tileset_SetCamera(dE,0,0);if(DClassID.BTM+dE==DClassID.BG){e._mapTileCountWidth=Mem_GetShort(dN,0);e._mapTileCountHeight=Mem_GetShort(dN,2)}}e._topLayerData=dp;e._topLayerFlip=dA;break;case DLoadState.UNLOAD_TILESET:for(var dE=0;dE<GLLibConfig.tileset_maxLayerCount;dE++){GLLibPlayer.Tileset_Destroy(dE)}e._topLayerData=null;e._topLayerFlip=null;break;case DLoadState.LOAD_ENTITY:if(DEF.dbgEnable){Dbg("loading entities")}e.LoadLevelData(DATA.LEVEL01_1_DESIGN);e.InitTraceAreas();e.InitCamera();CEntity.MonsterchestInitHP();e._entityMaxId=ao;for(var dE=0;dE<GLLibConfig.tileset_maxLayerCount;dE++){var dJ=LowAPI.Gen_Array([DParamIndex.ANIMID+1],0);dJ[DParamIndex.ID]=e._entityMaxId++;dJ[DParamIndex.CLASS_ID]=(DClassID.BTM+dE);dJ[DParamIndex.FLAGS]=DFlags.FIXED;e._entitiesRowTable.put(dJ[DParamIndex.ID],dJ);e._entitiesRowData[e._entityRowDataCount++]=dJ}e.LoadCinematics(Pack_ReadData(DATA.LEVEL01_1_CINEMATICS));Pack_Close();break;case DLoadState.UNLOAD_ENTITY:CEntity.RemoveAll();e._entitiesRowTable.clear();e._entitiesRowData=null;break;case DLoadState.LOAD_SEGMENT:Pack_Open(DATA.PACK_SEGMENT);var dB=Pack_ReadData(e._tempLevelId);var dl=0;var dm=Mem_GetShort(dB,dl);e._segmentCount=dm;dl+=2;var df=Mem_GetShort(dB,dl);dl+=2;e._segments=LowAPI.Gen_Array([dm+500],null);e._segmentParams=LowAPI.Gen_Array([dm+500],0);e._segmentAngles=LowAPI.Gen_Array([dm+500],null);e._entityMaxId=X;for(var dE=0;dE<dm;dE++){for(var dD=0;dD<df;dD++){e._segmentParams[dE]=Mem_GetShort(dB,dl);dl+=2}var dG=Mem_GetShort(dB,dl);dl+=2;e._segmentAngles[dE]=LowAPI.Gen_Array([dG-1],0);dG<<=1;e._segments[dE]=LowAPI.Gen_Array([dG],0);var dz=0;var dx=0;var dg=Number.MAX_VALUE;var dI=Number.MIN_VALUE;var dv=Number.MAX_VALUE;var dn=Number.MIN_VALUE;for(var dD=0;dD<dG;dD+=2){var ds=Mem_GetShort(dB,dl);dl+=2;var dr=Mem_GetShort(dB,dl);dl+=2;if(dD==0){dz=ds;dx=dr}dg=Math.min(ds,dg);dI=Math.max(ds,dI);e._segments[dE][dD]=(ds-dz)<<DEF.SHIFT;dv=Math.min(dr,dv);dn=Math.max(dr,dn);e._segments[dE][dD+1]=(dr-dx)<<DEF.SHIFT;var dy=(dD-2+dD)>>2;if(dy>=0){var dF=Math_Atan(e._segments[dE][dD]-e._segments[dE][dD-2],e._segments[dE][dD+1]-e._segments[dE][dD-1]);e._segmentAngles[dE][dy]=dF}}var dJ=LowAPI.Gen_Array([DParamIndex.SEGMENT_HEIGHT+1],0);dJ[DParamIndex.CLASS_ID]=DClassID.SEGMENT;dJ[DParamIndex.ID]=e._entityMaxId++;dJ[DParamIndex.POSX]=dz;dJ[DParamIndex.POSY]=dx;dJ[DParamIndex.FLAGS]=(DFlags.FIXED|DFlags.NO_UPDATE_AI);dJ[DParamIndex.EX_FLAGS]=DFlags.EX_SEGMENT;dJ[DParamIndex.SEGMENT_SEGMENT_ID]=dE;dJ[DParamIndex.SEGMENT_LEFT]=(dg-dz-1);dJ[DParamIndex.SEGMENT_TOP]=(dv-dx-1);dJ[DParamIndex.SEGMENT_WIDTH]=(dI-dg+2);dJ[DParamIndex.SEGMENT_HEIGHT]=(dn-dv+2);dJ[DParamIndex.SEGMENT_WIDTH]=Math.max(dJ[DParamIndex.SEGMENT_WIDTH],1);dJ[DParamIndex.SEGMENT_HEIGHT]=Math.max(dJ[DParamIndex.SEGMENT_HEIGHT],1);e._entitiesRowTable.put(dJ[DParamIndex.ID],dJ);e._entitiesRowData[e._entityRowDataCount++]=dJ}e._entityMaxId=w;Pack_Close();break;case DLoadState.UNLOAD_SEGMENT:e._segments=null;e._segmentAngles=null;e._segmentParams=null;e._segmentCount=0;break;case DLoadState.LOAD_SPRITE:if(DEF.dbgEnable){Dbg("loading sprites")}Pack_Open(DATA.PACK_SPRITE);for(var dE=0;dE<DATA.SPRITE_MAX;dE++){if((e._sprites_load_mask&(1<<dE))!=0&&e.spriteArray[dE]==null){if(e._optimizeSprite.indexOf(dE)>-1){continue}if(DEF.dbgEnable){Dbg("loading sprite id : ----------------------------- "+dE)}e.spriteLoad(dE,dE,true,true)}else{if((dE==DATA.SPRITE_HINT||dE==DATA.SPRITE_BONUS||dE==DATA.SPRITE_STONE)&&e.spriteArray[dE]==null){if(DEF.dbgEnable){Dbg("loading missing sprite id : ----------------------------- "+dE)}e.spriteLoad(dE,dE,true,true)}}}Pack_Close();if(e.spriteArray[DSpriteID.MOBS_WHITE]!=null){Pack_Open(DATA.PACK_MODULE_MAP);for(var dE=0;dE<DATA.MODULE_MAP_MAX;dE++){e.spriteArray[DSpriteID.MOBS_WHITE].SetModuleMapping(dE,Pack_ReadData(dE))}Pack_Close()}if(e.spriteArray[DSpriteID.MOBS_FLY]!=null){Pack_Open(DATA.PACK_MODULE_MAP_FLY);for(var dE=0;dE<DATA.MODULE_MAP_FLY_MAX;dE++){e.spriteArray[DSpriteID.MOBS_FLY].SetModuleMapping(dE,Pack_ReadData(dE))}Pack_Close()}if(e.spriteArray[DSpriteID.BOSS_OCTOPUS]!=null){Pack_Open(DATA.PACK_MODULE_MAP_BOSS_OCTOPUS);for(var dE=0;dE<DATA.MODULE_MAP_BOSS_OCTOPUS_MAX;dE++){e.spriteArray[DSpriteID.BOSS_OCTOPUS].SetModuleMapping(dE,Pack_ReadData(dE))}Pack_Close()}if(e.spriteArray[DSpriteID.HERO]!=null){Pack_Open(DATA.PACK_MODULE_MAP_HERO);for(var dE=0;dE<DATA.MODULE_MAP_HERO_MAX;dE++){e.spriteArray[DSpriteID.HERO].SetModuleMapping(dE,Pack_ReadData(dE))}Pack_Close()}if(e.spriteArray[DSpriteID.MAP_ACTOR]!=null){e.CreateAlphaPalette(e.spriteArray[DSpriteID.MAP_ACTOR],0,e.MINI_MAP_ALPHA_PAL,255,false)}break;case DLoadState.UNLOAD_SPRITE:if(DEF.dbgEnable){Dbg("UNLOAD_SPRITE *************")}for(var dE=0;dE<e.spriteArray.length;dE++){e.spriteUnLoad(dE)}break;case DLoadState.LOAD_EFFECT:e.CreateSpriteEffect();e.blendSpriteArray=LowAPI.Gen_Array([DATA.EFFECT_MAX],null);Pack_Open(DATA.PACK_EFFECT);for(var dE=0;dE<DATA.EFFECT_MAX;dE++){if(DEF.dbgEnable){Dbg("loading effect -------------------------------")}e.blendSpriteArray[dE]=e.LoadSprite4(dE,-1,true,false)}e.blendSpriteArray[DATA.EFFECT_SPAWN]._blend=CBlendSprite.BLEND_DISPLACEMENT;e.blendSpriteArray[DATA.EFFECT_SPAWN].ModifyPalette(1,5904216);e.blendSpriteArray[DATA.EFFECT_SPAWN].ModifyPalette(2,525720);e.ApplyModifyPalette(e.blendSpriteArray[DATA.EFFECT_SPAWN],[1,2]);e.blendSpriteArray[DATA.EFFECT_ATMOSPHERE].ModifyPalette(0,16728128);e.blendSpriteArray[DATA.EFFECT_ATMOSPHERE].ModifyPalette(1,3966191);e.ApplyModifyPalette(e.blendSpriteArray[DATA.EFFECT_ATMOSPHERE],[0,1]);for(var dE=0;dE<e.spriteArray.length;dE++){if(e.spriteArray[dE]!=null){e.spriteArray[dE].SetPool(1)}}Pack_Close();break;case DLoadState.UNLOAD_EFFECT:e.blendSpriteArray=null;break;case DLoadState.LOAD_SOUND:if(DEF.dbgEnable){Dbg("init sound engine")}if(DEF.dbgEnable){Dbg("load some sound")}for(var dE=0;dE<DATA.SOUND_MAX;dE++){if(GLLibConfiguration.sound_allowURLCreation){var dM=e.getSoundName(dE);var di=window.location.href.split("index")[0]+"/js/sounds/OPT_OGG/"+dM;var dk="audio/mpeg";GLLibPlayer.Snd_LoadSound(di,dk,dE,true)}else{GLLibPlayer.Snd_LoadSound(DATA.PACK_SOUND,dE)}}break;case DLoadState.UNLOAD_SOUND:if(DEF.dbgEnable){Dbg("unload some sound -------------------------")}for(var dE=0;dE<DATA.SOUND_MAX;dE++){GLLibPlayer.Snd_UnLoadSound(dE)}GLLibPlayer.Snd_Quit();break}dC++;return dC};e.getSoundName=function(dg){var df=null;switch(dg){case DATA.SOUND_HERO_HURT:df="sfx_hero_hurt.ogg";break;case DATA.SOUND_MAGIC_ATTACK:df="sfx_magic_attack.ogg";break;case DATA.SOUND_HIT_ENEMY:df="sfx_hit_enemy.ogg";break;case DATA.SOUND_MENU_CONFIRM:df="sfx_menu_confirm.ogg";break;case DATA.SOUND_STONE_BREAK:df="sfx_stone_break.ogg";break;case DATA.SOUND_TRANSFORM:df="sfx_transform.ogg";break;case DATA.SOUND_HIDDEN_BONUS:df="sfx_hidden_bonus.ogg";break;case DATA.SOUND_BGM_LOSE:df="m_lose.ogg";break;case DATA.SOUND_BGM_LEVEL_CLEAR:df="m_level_clear.ogg";break;case DATA.SOUND_BGM_TITLE:df="m_title.ogg";break;case DATA.SOUND_BGM_STAGE_CHOOSE:df="m_stage_choose.ogg";break;case DATA.SOUND_BGM_LABYRINTH_LEVEL:df="m_bgm_01.ogg";break;case DATA.SOUND_BGM_BOSS_FIGHT:df="m_boss_fight.ogg";break;case DATA.SOUND_BGM_CUTSCENE_STORY:df="m_cutscene_story.ogg";break;case DATA.SOUND_BGM_MAIN_MENU:df="m_menu.ogg";break;case DATA.SOUND_BGM_01:df="m_bgm_01.ogg";break;case DATA.SOUND_BGM_02:df="m_bgm_02.ogg";break}return df};e.ApplyModifyPalette=function(df,dg){for(var dh=0;dh<dg.length;dh++){df.BuildCacheImages(dg[dh],0,-1,-1)}df.PushCacheImagesToGL()};e.CreateAlphaPalette=function(df,dk,dn,dh,di){if(GLLibConfig.sprite_useNokiaUI){var dl=df._pal_short[0][dk];var dm=LowAPI.Gen_Array([dl.length],0);System.arraycopy(dl,0,dm,0,dm.length);df._pal_short[0][dn]=dm}else{var dl=df._pal_int[0][dk];var dm=LowAPI.Gen_Array([dl.length],0);System.arraycopy(dl,0,dm,0,dm.length);df._pal_int[0][dn]=dm}df._palettes++;if(di){if(GLLibConfig.sprite_useNokiaUI){df._pal_short[0][dn]=LowAPI.Gen_Array([df._pal_short[0][dk].length],0);dh=(dh>>4)&255;for(var dj=0;dj<df._pal_short[0][dk].length;dj++){if((df._pal_short[0][dk][dk]&4095)!=3855){df._pal_short[0][dn][dj]=(((dh&15)<<12)|(df._pal_short[0][dk][dj]&4095)|dh)}}}else{df._pal_int[0][dn]=LowAPI.Gen_Array([df._pal_int[0][dk].length],0);dh=dh&255;for(var dj=0;dj<df._pal_int[0][dk].length;dj++){if((df._pal_int[0][dk][dj]&4278190080)!=0&&(df._pal_int[0][dk][dj]&16777215)!=16711935){df._pal_int[0][dn][dj]=(((dh)<<24)|(df._pal_int[0][dk][dj]&16777215)|dh)}}}}else{df.ModifyPaletteAlpha(dn,dh)}var dg=false;if(dg){df.BuildCacheImages(dn,0,-1,-1);df.BuildCacheFrames(dn,0,-1);df.PushCacheFramesToGL()}else{df.BuildCacheImages(dn,0,-1,-1);df.PushCacheImagesToGL()}};e.LoadLevelData=function(dh){var df;df=Pack_ReadData(dh);var di=df.length;var dl=0;while(dl<di){var dm=(df[dl++]&255);var dk=LowAPI.Gen_Array([dm],0);for(var dg=0;dg<dm;dg++){dk[dg]=Mem_GetShort(df,dl);dl+=2}e._entitiesRowTable.put(dk[DParamIndex.ID],dk);e._entitiesRowData[e._entityRowDataCount++]=dk;var dj=CEntity.InitSprite(dk);e._sprites_load_mask|=CEntity.GetSpriteLoadMask(dj)}};e.InitCamera=function(){for(var df=0;df<e._entityRowDataCount;df++){var dg=e._entitiesRowData[df];if(dg[DParamIndex.CLASS_ID]==DClassID.CAMERA){if(dg[DParamIndex.CAMERA_WIDTH]==DEF.DESIGN_SCR_W){dg[DParamIndex.POSX]-=(DEF.SCR_W-DEF.DESIGN_SCR_W)/2;dg[DParamIndex.POSX]=Math.max(0,dg[DParamIndex.POSX]);dg[DParamIndex.POSX]=Math.min(e._mapTileCountWidth*DEF.TILE_W-DEF.SCR_W,dg[DParamIndex.POSX]);dg[DParamIndex.CAMERA_WIDTH]=DEF.SCR_W}if(dg[DParamIndex.CAMERA_HEIGHT]==DEF.DESIGN_SCR_H){dg[DParamIndex.POSY]-=(DEF.SCR_H-DEF.DESIGN_SCR_H)/2;dg[DParamIndex.POSY]=Math.max(0,dg[DParamIndex.POSY]);dg[DParamIndex.POSY]=Math.min(e._mapTileCountHeight*DEF.TILE_H-DEF.SCR_H,dg[DParamIndex.POSY]);dg[DParamIndex.CAMERA_HEIGHT]=DEF.SCR_H}}}};e.InitTraceAreas=function(){for(var dj=0;dj<e._entityRowDataCount;dj++){var di=e._entitiesRowData[dj];var dg=-1;var dk=-1;if(di[DParamIndex.CLASS_ID]==DClassID.TRACE_RENDER){dg=di[DParamIndex.TRACE_RENDER_FIRST_TRACE];dk=di[DParamIndex.TRACE_RENDER_LAST_TRACE]}else{if(di[DParamIndex.CLASS_ID]==DClassID.PLATFORM){dg=di[DParamIndex.PLATFORM_TRACE]}else{if(di[DParamIndex.CLASS_ID]==DClassID.ROLLING_PLATFORM){dg=di[DParamIndex.ROLLING_PLATFORM_TRACE]}else{if(di[DParamIndex.CLASS_ID]==DClassID.OBJ_DAMAGE_STONE){dg=di[DParamIndex.OBJ_DAMAGE_STONE_TRACE]}else{if(di[DParamIndex.CLASS_ID]==DClassID.MOBS_UFO){dg=di[DParamIndex.MOBS_UFO_TRACE]}}}}}if(dg>0){var dl=dg;var dn=null;var dh=Number.MAX_VALUE;var dp=Number.MIN_VALUE;var dm=Number.MAX_VALUE;var df=Number.MIN_VALUE;while(dl>0){dn=CEntity.GetRowDataByID(dl);dh=Math.min(dh,dn[DParamIndex.POSX]);dm=Math.min(dm,dn[DParamIndex.POSY]);dp=Math.max(dp,dn[DParamIndex.POSX]);df=Math.max(df,dn[DParamIndex.POSY]);if(dl==dk){break}dl=dn[DParamIndex.TRACE_NEXT_TRACE];if(dl==dg){break}}di[DParamIndex.POSX]=dh;di[DParamIndex.POSY]=dm;if(di[DParamIndex.CLASS_ID]==DClassID.TRACE_RENDER){di[DParamIndex.TRACE_RENDER_WIDTH]=(dp-dh);di[DParamIndex.TRACE_RENDER_HEIGHT]=(df-dm)}else{if(di[DParamIndex.CLASS_ID]==DClassID.PLATFORM){di[DParamIndex.PLATFORM_WIDTH]=(dp-dh);di[DParamIndex.PLATFORM_HEIGHT]=(df-dm)}else{if(di[DParamIndex.CLASS_ID]==DClassID.ROLLING_PLATFORM){di[DParamIndex.ROLLING_PLATFORM_WIDTH]=(dp-dh);di[DParamIndex.ROLLING_PLATFORM_HEIGHT]=(df-dm)}else{if(di[DParamIndex.CLASS_ID]==DClassID.OBJ_DAMAGE_STONE){di[DParamIndex.OBJ_DAMAGE_STONE_WIDTH]=(dp-dh);di[DParamIndex.OBJ_DAMAGE_STONE_HEIGHT]=(df-dm)}else{if(di[DParamIndex.CLASS_ID]==DClassID.MOBS_UFO){di[DParamIndex.MOBS_UFO_WIDTH]=(dp-dh);di[DParamIndex.MOBS_UFO_HEIGHT]=(df-dm)}}}}}}}};e.CreateSpriteEffect=function(){var dm;var dr;var dp;var dn;dr=e.spriteArray[DSpriteID.HERO];dp=DAI.HERO_PAL_SHADOW1;dn=DAI.HERO_PAL_NORMAL;for(var di=0;di<2;di++){if(di==1){dp=DAI.HERO_PAL_POWERUP_SHADOW1;dn=DAI.HERO_PAL_POWERUP}for(var dj=dp;dj<dp+3;dj++){var dh=170;if(dj==dp+1){dh=136}else{if(dj==dp+2){dh=102}}e.CreateAlphaPalette(dr,dn,dj,dh,true)}}if(e.spriteArray[DSpriteID.BOSS_WATCH]!=null){dr=e.spriteArray[DSpriteID.BOSS_WATCH];dp=DAI.BOSS_WITCH_PAL_SHADOW1;dn=DAI.BOSS_WITCH_PAL_NORMAL;for(var di=0;di<1;di++){for(var dj=dp;dj<dp+DAI.BOSS_WITCH_PAL_SHADOWMAX;dj++){var dh=170;if(dj==dp+1){dh=136}else{if(dj==dp+2){dh=102}else{if(dj==dp+3){dh=68}else{if(dj==dp+4){dh=34}}}}e.CreateAlphaPalette(dr,dn,dj,dh,true)}}}if(e.spriteArray[DSpriteID.OBJ_WAVE]!=null){e.spriteArray[DSpriteID.OBJ_WAVE].ModifyPaletteAlpha(0,32);e.spriteArray[DSpriteID.OBJ_WAVE]._alpha=true;e.spriteArray[DSpriteID.OBJ_WAVE].BuildCacheImages(0,0,-1,-1);e.spriteArray[DSpriteID.OBJ_WAVE].BuildCacheImages(1,0,-1,-1);e.spriteArray[DSpriteID.OBJ_WAVE].PushCacheImagesToGL()}if(e.spriteArray[DSpriteID.OBJ_BALANCE]!=null){var dg=e.spriteArray[DSpriteID.OBJ_BALANCE].GetModuleCount();e._balanceImageData=LowAPI.Gen_Array([dg],null);e._balanceImageSize=LowAPI.Gen_Array([dg<<1],0);for(var dk=0;dk<e.spriteArray[DSpriteID.OBJ_BALANCE].GetModuleCount();dk++){var dq=e.spriteArray[DSpriteID.OBJ_BALANCE].GetModuleWidth(dk);var dl=e.spriteArray[DSpriteID.OBJ_BALANCE].GetModuleHeight(dk);e._balanceImageSize[dk<<1]=dq;e._balanceImageSize[(dk<<1)+1]=dl;e._balanceImageData[dk]=LowAPI.Gen_Array([dq*dl],0);var df=e.spriteArray[DSpriteID.OBJ_BALANCE].DecodeImage(dk);System.arraycopy(df,0,e._balanceImageData[dk],0,e._balanceImageData[dk].length)}}if(e.spriteArray[DSpriteID.FIELD]!=null){e.spriteArray[DSpriteID.FIELD].ModifyPaletteAlpha(0,136)}};var de={};de.ENDED=-1;de.INIT=1;de.MENU=2;de.TEST_ARENA=3;de.TEST_LOGIN=20;de.TEST_SENDINGSCORE=21;de.TEST_GETSTATES=22;de.TEST_GETRANK=23;de.TEST_GETRANK_AROUND_PLAYER=24;de.TEST_RATEGAME=25;de.TEST_RECOMMENDGAME=26;de.TEST_REGISTER=30;de.TEST_NICK_TAKEN=31;de.TEST_DISPLAY_GAME_RATINGS=32;de.TEST_CONNECTION_ERROR=40;de.TEST_SERVER_ERROR=41;var b8={};b8.SINGLE_SCORE=0;b8.SINGLE_SCORE_SUPPLEMENTAL_DATA=1;b8.MULTIPLE_SCORE=2;b8.MULTIPLE_SCORE_SUPPLEMENTAL_DATA=3;e.currentScoreSendingPolicy=b8.SINGLE_SCORE;e.USE_CONDENSED_VERSION=false;var aT={};aT.SET=0;aT.WAIT=1;aT.PROCESS=2;aT.DISPLAY=3;e.vareractiv=null;var bT=[TEXT.MENU_XPLAYER_GAMELOFT_LIVE,TEXT.MENU_XPLAYER_PLAY,];e.MENU_STATE_TEST_ARENA=0;e.MENU_STATE_EXIT=1;var bM=[TEXT.MENU_XPLAYER_SEND_SCORE,TEXT.MENU_XPLAYER_GET_TOP_PLAYERS,TEXT.MENU_XPLAYER_GET_RANKING,TEXT.MENU_XPLAYER_MY_STATS,TEXT.MENU_XPLAYER_RATE_GAME,TEXT.MENU_XPLAYER_RECOMMEND_GAME,TEXT.MENU_XPLAYER_VISIT_GAME_LOBBY,];var bA=bM.length;var cp=[TEXT.MENU_XPLAYER_ROOT_CANAL,TEXT.MENU_XPLAYER_GARBAGE,TEXT.MENU_XPLAYER_AWFUL,TEXT.MENU_XPLAYER_DISAPPOINTING,TEXT.MENU_XPLAYER_AVERAGE,TEXT.MENU_XPLAYER_GOOD,TEXT.MENU_XPLAYER_GREAT,TEXT.MENU_XPLAYER_EXCELLENT,TEXT.MENU_XPLAYER_OUTSTANDING,TEXT.MENU_XPLAYER_THE_BEST,];var a5=cp.length;var bt=true;var cy=0;var aF="";var ax=0;var cH=0;var W=0;e.keymap=[["0"],["_","1"],["A","B","C","2"],["D","E","F","3"],["G","H","I","4"],["J","K","L","5"],["M","N","O","6"],["P","Q","R","S","7"],["T","U","V","8"],["W","X","Y","Z","9"]];var cM=0;var H=2;var aj=1;var ab=0;var bR=0;var co=0;var bS=-1;var R=-1;var bf=true;var be=0;var bc=0;var bp=0;var bn=0;var ct=0;var cr=0;var ah=-256;var aM=null;e.prototype.pointerPressed=function(df,dg){be=df;bc=dg;bp=df;bn=dg;ct=df;cr=dg;if(DEF.dbgEnable){Dbg("called Pressed  pointerPosX : "+be+"  pointerPosY : "+bc)}};e.prototype.pointerDragged=function(df,dg){if(DEF.dbgEnable){Dbg("called Dragged.")}ct=df;cr=dg};e.prototype.pointerReleased=function(df,dg){if(DEF.dbgEnable){Dbg("called Released.")}be=-1000;bc=-1000;bp=-1000;bn=-1000;ct=-1000;cr=-1000;ResetKey()};e.isPointInRect=function(df,di,dg,dh){return e.isPointInRectAbs(df,di,df+dg,di+dh)};e.isPointInRectAbs=function(dg,di,df,dh){if(DEF.dbgEnableTouchBox){g.setColor(16711680);g.drawRect(dg,di,df-dg,dh-di)}return(be>dg&&bc>di&&be<df&&bc<dh)};e.isPointHoldInRect=function(df,di,dg,dh){return e.isPointHoldInRectAbs(df,di,df+dg,di+dh)};e.isPointHoldInRectAbs=function(dg,di,df,dh){return(bp>dg&&bn>di&&bp<df&&bn<dh)};e.isPointInRect_FixedPoint=function(df,di,dg,dh){return e.isPointInRect(Math_FixedPointToInt(df-CEntity._camX),Math_FixedPointToInt(di-CEntity._camY),Math_FixedPointToInt(dg),Math_FixedPointToInt(dh))};e.isPointInRectAbs_FixedPoint=function(df,di,dg,dh){return e.isPointInRectAbs(Math_FixedPointToInt(df-CEntity._camX),Math_FixedPointToInt(di-CEntity._camY),Math_FixedPointToInt(dg-CEntity._camX),Math_FixedPointToInt(dh-CEntity._camY))};e.prototype.detectSoftKeys=function(){if(bi==STATE.GAMEPLAY_UPDATE&&!e.InCinemitic()){if(e.isPointInRect(0,DEF.SCR_H-S,D,S)){this.keyPressed(GLLibConfig.keycodeLeftSoftkey);this.keyReleased(GLLibConfig.keycodeLeftSoftkey)}if(e.isPointInRect(DEF.SCR_W-D,DEF.SCR_H-S,D,S)){this.keyPressed(GLLibConfig.keycodeRightSoftkey);this.keyReleased(GLLibConfig.keycodeRightSoftkey)}}else{if(e.isPointInRect(0,DEF.SCR_H-O,ai,O)){if(bi==STATE.GAMEPLAY_UPDATE||bi==STATE.MENU_HELP||bi==STATE.MENU_MAP){this.keyPressed(GLLibConfig.keycodeLeftSoftkey);this.keyReleased(GLLibConfig.keycodeLeftSoftkey)}}if(e.isPointInRect(DEF.SCR_W-ai,DEF.SCR_H-O,ai,O)){this.keyPressed(GLLibConfig.keycodeRightSoftkey);this.keyReleased(GLLibConfig.keycodeRightSoftkey)}}};e.prototype.ClearPointer=function(){be=-1000;bc=-1000;ct=-1000;cr=-1000};e.isAnyPointPressed=function(){return !(be==-1000&&bc==-1000)};e.s_isEnemyPointed=false;e.prototype.UpdatePointerEvents=function(dh){if(dh){if(bi==STATE.GAMEPLAY_UPDATE){var dg;if(!e.InCinemitic()&&e.isPointInRect((DEF.SCR_W-aQ>>1),DEF.SCR_H-S,aQ,cL)){this.keyPressed(GLLibConfig.keycodeFire);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== ")}}if(e.InCinemitic()||CEntity._hero._subState==DState.SS_HERO_IN_FLY_CANNON){if(e.isPointInRectAbs(0,0,DEF.SCR_W,DEF.SCR_H-S)){this.keyPressed(GLLibConfig.keycodeFire);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 1")}}return}var df=CEntity._hero.CheckFlag(DFlags.REVERSAL_GRAVITY);dg=CEntity._hero.GetAbsoluteBox(df?j:db);if(e.s_isEnemyPointed||e.isPointInRectAbs_FixedPoint(dg[0],dg[1],dg[2],dg[3])){if(CEntity.show_hint_Press2){this.keyPressed(GLLibConfig.keycodeUp);CEntity.show_hint_Press2=false}this.keyPressed(GLLibConfig.keycodeFire);e.s_isEnemyPointed=false;if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 2")}}else{if(!df&&e.isPointInRectAbs_FixedPoint(dg[2],dg[1],Math_IntToFixedPoint(DEF.SCR_W)+CEntity._camX,Math_IntToFixedPoint(DEF.SCR_H-S)+CEntity._camY)||df&&e.isPointInRectAbs_FixedPoint(dg[2],CEntity._camY,Math_IntToFixedPoint(DEF.SCR_W)+CEntity._camX,dg[3])){this.keyPressed(GLLibConfig.keycodeRight);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 3")}}else{if(!df&&e.isPointInRectAbs_FixedPoint(CEntity._camX,dg[1],dg[0],Math_IntToFixedPoint(DEF.SCR_H-S)+CEntity._camY)||df&&e.isPointInRectAbs_FixedPoint(CEntity._camX,CEntity._camY,dg[0],dg[3])){this.keyPressed(GLLibConfig.keycodeLeft);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 4")}}else{if(e.isPointInRectAbs_FixedPoint(dg[0],CEntity._camY,dg[2],dg[1])){this.keyPressed(GLLibConfig.keycodeUp);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 5")}}else{if(e.isPointInRectAbs_FixedPoint(dg[0],dg[3],dg[2],Math_IntToFixedPoint(DEF.SCR_H-S)+CEntity._camY)){this.keyPressed(GLLibConfig.keycodeDown);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 6")}}else{if(!df&&e.isPointInRectAbs_FixedPoint(CEntity._camX,CEntity._camY,dg[0],dg[1])){this.keyPressed(GLKey.k_num1);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 7")}}else{if(!df&&e.isPointInRectAbs_FixedPoint(dg[2],CEntity._camY,Math_IntToFixedPoint(DEF.SCR_W)+CEntity._camX,dg[1])){this.keyPressed(GLKey.k_num3);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 8")}}else{if(df&&e.isPointInRectAbs_FixedPoint(CEntity._camX,dg[3],dg[0],Math_IntToFixedPoint(DEF.SCR_H-S)+CEntity._camY)){this.keyPressed(GLKey.k_num7);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 9")}}else{if(df&&e.isPointInRectAbs_FixedPoint(dg[2],dg[3],Math_IntToFixedPoint(DEF.SCR_W)+CEntity._camX,Math_IntToFixedPoint(DEF.SCR_H-S)+CEntity._camY)){this.keyPressed(GLKey.k_num9);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 10")}}else{if(CEntity._hero._state==DState.STATE_INAIR&&ct-bp>0&&ct>Math_FixedPointToInt(dg[2]-CEntity._camX)){this.keyReleased(GLLibConfig.keycodeLeft);this.keyPressed(GLLibConfig.keycodeRight);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 11")}}else{if(CEntity._hero._state==DState.STATE_INAIR&&ct!=-1000&&ct-bp<0&&ct<Math_FixedPointToInt(dg[0]-CEntity._camX)){this.keyReleased(GLLibConfig.keycodeRight);this.keyPressed(GLLibConfig.keycodeLeft);if(DEF.dbgEnableKey){Dbg("UpdatePointerEvents GAMEPLAY_UPDATE =============================================== 12")}}}}}}}}}}}}if(e.isAnyPointPressed()){e.UpdateKeyState()}}return}if(bi!=STATE.IGP){this.detectSoftKeys()}switch(bi){case STATE.GAMEPLAY_UPDATE:return;case STATE.ASK_SOUND:if(aM==null&&bB!=null&&Canvas.isTouchDevice){aM=new GLLibPlayer(bB,-1000,-1000)}break;case STATE.MENU_MAP:if(e.isPointInRectAbs(0,0,DEF.SCR_W,DEF.SCR_H)){if(e._miniMapState==e.MINI_MAP_STATE_IDLE){e._miniMapCursorX=be+e._miniMapCameraX;e._miniMapCursorY=bc+e._miniMapCameraY-2*DEF.TILE_H}this.keyPressed(GLLibConfig.keycodeFire)}break;case STATE.GAMEOVER:if(e.isPointInRectAbs(0,0,DEF.SCR_W,DEF.SCR_H)){this.keyPressed(GLLibConfig.keycodeFire)}break;case STATE.SPLASH:case STATE.GAME_STATISTIC:case STATE.LOAD_UNLOAD:case STATE.GAMEEND:if(e._isinitgame){if(WebAudioPlayer.isSoundComplete()){e._isinitgame=false;e._isInputEvent=true}}if(e._isInputEvent){if(aM==null&&bB!=null&&Canvas.isTouchDevice){aM=new GLLibPlayer(bB,-1000,-1000)}e._isInputEvent=false;be=-1000;bc=-1000;e.PlaySoundBGM()}if(e.isPointInRectAbs(0,0,DEF.SCR_W,DEF.SCR_H)){this.keyPressed(GLLibConfig.keycodeFire);this.keyReleased(GLLibConfig.keycodeFire)}break;default:break}if(e.isAnyPointPressed()){e.UpdateKeyState()}};var cJ;e.prototype.RenderPointerEvent=function(){if(bi<0){return}cJ=bi;if(aM!=null&&Canvas.isTouchDevice){if(e.isAnyPointPressed()){aM.SetPos(be,bc);aM.SetAnim(DAnimID.TOUCHINTERFACE_WAVE_TAP,1);aM.Render()}else{if(!aM.IsAnimOver()){aM.Update(s_game_frameDT);aM.Render()}}}};var a1=LowAPI.Gen_Array([GLKey.k_nbKey],0);e.UpdateKeyState=function(){UpdateKeypad_Game();if(GLLibConfig.useKeyAccumulation){}else{}};var ai=60*DScreen.RATIO;var O=23*DScreen.RATIO;var D=30*DScreen.RATIO;var S=O;var aQ=120*DScreen.RATIO;var cL=20*DScreen.RATIO;var aa=30*DScreen.RATIO;var bL=DEF.SCR_W-(aP<<1);var cx=-3*DScreen.RATIO;var db=[Math_IntToFixedPoint(-20*DScreen.RATIO),Math_IntToFixedPoint(-40*DScreen.RATIO),Math_IntToFixedPoint(20*DScreen.RATIO),Math_IntToFixedPoint(10*DScreen.RATIO)];var j=[db[0],db[3],db[2],-db[1]];e.TOUCH_ENEMY_BOUNDING_OFFSET=Math_IntToFixedPoint(20);e.prototype.setState=function(df){aj=df;ab=aT.SET;ResetKey()};e.prototype.setOnlineSubstate=function(df){ab=df};e.prototype.OnlineTypeinData=function(dh,dg,dm,di,dn,dl,dj){try{var df=null;if(s_keyState[GLKey.k_menuOK]>0){if(0!=di){setState(di)}if(0!=dn){setOnlineSubstate(dn)}aF="";cy=0}if(bt){dj.setColor(0,0,0);dj.fillRect(0,0,dj.getClipWidth(),dj.getClipHeight())}dj.setColor(208,80,80);e.txtDraw(0,dh,3,10,Graphics.LEFT|Graphics.TOP);e.txtDraw(0,dg,3,20,Graphics.LEFT|Graphics.TOP);bt=false;bt=WasAnyKeyReleased()>=0;if((0!=cy)&&(dl>aF.length)){e.txtDraw(0,aF+cy,3,50,Graphics.LEFT|Graphics.TOP)}else{e.txtDraw(0,aF,3,50,Graphics.LEFT|Graphics.TOP)}if(((s_keyState[GLKey.k_menuBack]>0))&&(2<aF.length)){if((0!=cy)&&(dl>aF.length)){aF=aF+cy}df=aF;bt=true;aF="";cy=0}if((bS=WasAnyKeyReleased())>=0){if((bS>=GLKey.k_num0)&&(bS<=GLKey.k_num9)){bS-=GLKey.k_num0;if((!dm)||(bS==0)){if(bS!=ax){if((0!=cy)&&(dl>aF.length)){aF=aF+cy}cH=0;cy=keymap[bS][cH];W=System.currentTimeMillis();ax=bS}else{if((System.currentTimeMillis()-W)>1000){if((0!=cy)&&(dl>aF.length)){aF=aF+cy}cH=0;cy=keymap[bS][cH];W=System.currentTimeMillis();ax=bS}else{cH=((cH+1)%keymap[bS].length);cy=keymap[bS][cH];W=System.currentTimeMillis();ax=bS}}}else{if(bS!=ax){if((0!=cy)&&(dl>aF.length)){aF=aF+cy}}cH=(keymap[bS].length-1);cy=keymap[bS][cH];W=System.currentTimeMillis();ax=bS;if((0!=cy)&&(dl>aF.length)){aF=aF+cy}cy=0;cH=0}}else{if((s_keyState[GLKey.k_star]>0)){if(aF.length>0){cy=aF.charAt(aF.length-1);aF=aF.substring(0,aF.length-1)}else{if(cy!=0){cy=0}else{df=""}}}}bS=0}return df}catch(dk){if(DEF.dbgEnable){Dbg("-------------------- error : "+dk.message)}return null}};e.prototype.drawOnline=function(dg){try{var df=null;var di="";dg.setColor(0,0,0);dg.fillRect(0,0,dg.getClipWidth(),dg.getClipHeight());dg.setColor(208,80,80);if(aj>=de.TEST_LOGIN&&aj<=de.TEST_RECOMMENDGAME&&ab!=aT.DISPLAY){df=Text_GetString(TEXT.MENU_XPLAYER_PLEASE_WAIT);e.txtDraw(0,df,dg.getClipWidth()/2,dg.getClipHeight()/2,Graphics.TOP|Graphics.HCENTER);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_CANCEL),1,dg.getClipHeight()-1,Graphics.BOTTOM|Graphics.LEFT);return}switch(aj){case de.INIT:DrawOnlineState_INIT(dg);break;case de.MENU:DrawOnlineState_MENU(dg);break;case de.TEST_ARENA:DrawOnlineState_TEST_ARENA(dg);break;case de.TEST_REGISTER:DrawOnlineState_TEST_REGISTER(dg);break;case de.TEST_NICK_TAKEN:DrawOnlineState_TEST_NICK_TAKEN(dg);break;case de.TEST_LOGIN:DrawOnlineState_TEST_LOGIN(dg);break;case de.TEST_SENDINGSCORE:DrawOnlineState_TEST_SENDINGSCORE(dg);break;case de.TEST_GETRANK:DrawOnlineState_TEST_GETRANK(dg);break;case de.TEST_GETRANK_AROUND_PLAYER:DrawOnlineState_TEST_GETRANK_AROUND_PLAYER(dg);break;case de.TEST_DISPLAY_GAME_RATINGS:DrawOnlineState_TEST_DISPLAY_GAME_RATINGS(dg);break;case de.TEST_RATEGAME:DrawOnlineState_TEST_RATEGAME(dg);break;case de.TEST_RECOMMENDGAME:DrawOnlineState_TEST_RECOMMENDGAME(dg);break;case de.TEST_CONNECTION_ERROR:DrawOnlineState_TEST_CONNECTION_ERROR(dg);break;case de.TEST_SERVER_ERROR:DrawOnlineState_TEST_SERVER_ERROR(dg);break;case de.ENDED:break}}catch(dh){if(DEF.dbgEnable){Dbg("-------------------- error : "+dh.message)}}};e.prototype.DrawOnlineState_INIT=function(df){setState(de.TEST_LOGIN);bf=true};e.prototype.DrawOnlineState_MENU=function(dg){var df=null;e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_MAIN_MENU),dg.getClipWidth()/2,dg.getClipHeight()/4,Graphics.TOP|Graphics.HCENTER);dg.setColor(192,176,0);df=Text_GetString(bT[bR]);if(bR>0){df="<- "+df}if(bR<H-1){df=df+" ->"}e.txtDraw(0,df,dg.getClipWidth()/2,dg.getClipHeight()/2,Graphics.TOP|Graphics.HCENTER);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),dg.getClipWidth()/2,dg.getClipHeight()-1,Graphics.BOTTOM|Graphics.HCENTER)};e.prototype.DrawOnlineState_TEST_ARENA=function(dh){var df=null;e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_ONLINE_MENU),dh.getClipWidth()/2,10,Graphics.TOP|Graphics.HCENTER);if(!(GLLibConfig.xplayer_CARRIER_USSPRINT|GLLibConfig.xplayer_CARRIER_USCINGULAR_ORANGE|GLLibConfig.xplayer_CARRIER_USCINGULAR_BLUE|GLLibConfig.xplayer_CARRIER_USNEXTEL|GLLibConfig.xplayer_CARRIER_USVIRGIN)){bA=3}for(var dg=0;dg<bA;dg++){df=Text_GetString(bM[dg]);if(cM==dg){df+="*"}e.txtDraw(0,df,dh.getClipWidth()/2,30+dg*15,Graphics.TOP|Graphics.HCENTER)}e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_CANCEL),1,dh.getClipHeight()-1,Graphics.BOTTOM|Graphics.LEFT)};e.prototype.DrawOnlineState_TEST_REGISTER=function(dg){var dh=interactiv.getUsername();if(dh.length==0){dh=OnlineTypeinData(Text_GetString(TEXT.MENU_XPLAYER_ENTER_YOUR_USERNAME),Text_GetString(TEXT.MENU_XPLAYER_MAX_15_CHARACTERS),false,de.MENU,0,15,dg);if((dh!=null)&&(dh.length>0)){W=0;ax=0;cH=0;cy=0;interactiv.setUsername(dh)}}else{var df=OnlineTypeinData(Text_GetString(TEXT.MENU_XPLAYER_ENTER_YOUR_PHONE_NUMBER),Text_GetString(TEXT.MENU_XPLAYER_10_CHARS),true,de.MENU,0,10,dg);if((df!=null)&&(df.length>0)){W=0;ax=0;cH=0;cy=0;interactiv.setPhoneNumber(df);this.setState(de.TEST_LOGIN)}}e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_STAR_TO_DELETE),dg.getClipWidth()/2,dg.getClipHeight()*2/3,Graphics.HCENTER|Graphics.HCENTER);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_CANCEL),1,dg.getClipHeight()-1,Graphics.BOTTOM|Graphics.LEFT);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_OK),dg.getClipWidth()-1,dg.getClipHeight()-1,Graphics.BOTTOM|Graphics.RIGHT)};e.prototype.DrawOnlineState_TEST_NICK_TAKEN=function(df){var dg=interactiv.getUsername();if(dg.length==0){dg=OnlineTypeinData(Text_GetString(TEXT.MENU_XPLAYER_NICK_TAKEN),Text_GetString(TEXT.MENU_XPLAYER_MAX_15_CHARACTERS),false,de.MENU,0,15,df);if((dg!=null)&&(dg.length>0)){W=0;ax=0;cH=0;cy=0;interactiv.setUsername(dg);this.setState(de.TEST_LOGIN)}}e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_CANCEL),1,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.LEFT);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_OK),df.getClipWidth()-1,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.RIGHT)};e.prototype.DrawOnlineState_TEST_LOGIN=function(df){if(interactiv.isLoggedIn()){e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_WELCOME)+" "+interactiv.getUsername(),df.getClipWidth()/2,df.getClipHeight()/2,Graphics.TOP|Graphics.HCENTER);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),df.getClipWidth()/2,df.getClipHeight()/2+10,Graphics.TOP|Graphics.HCENTER);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_CANCEL),1,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.LEFT)}};e.prototype.DrawOnlineState_TEST_SENDINGSCORE=function(df){var dg="";e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),df.getClipWidth()/2,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.HCENTER);dg=Text_GetString(TEXT.MENU_XPLAYER_NEW_RANK)+": "+interactiv.getNewRankAfterScoreSending();e.txtDraw(0,dg,10,df.getClipHeight()>>1,0)};e.prototype.DrawOnlineState_TEST_GETRANK=function(dn){var dm="";e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),dn.getClipWidth()/2,dn.getClipHeight()-1,Graphics.BOTTOM|Graphics.HCENTER);var dk;if(USE_CONDENSED_VERSION){var dq=interactiv.getLeaderboardSize();var dp=LowAPI.Gen_Array([dq],null);var dl=LowAPI.Gen_Array([dq],0);var di=LowAPI.Gen_Array([dq],0);var dh=LowAPI.Gen_Array([dq],0);if(interactiv.getLeaderboardData(dp,dl,di,dh)==false){return}for(var df=0;df<dq;df++){dk=""+dl[df]+": "+dp[df]+" "+di[df];if(dh!=null){var dg=dh[df];if(dg!=null){for(var dj=0;dj<dg.length;dj++){dk+=" "+dg[dj]}}}dm=dk;e.txtDraw(0,dm,30,30+df*14,0)}}else{for(var df=0;df<interactiv.getLeaderboardSize();df++){dk=""+interactiv.getLeaderboardEntryPlayerPosition(df)+": "+interactiv.getLeaderboardEntryPlayerName(df)+" "+interactiv.getLeaderboardEntryPlayerScore(df);var dg=interactiv.getLeaderboardEntryPlayerScoreData(df);if(dg!=null){for(var dj=0;dj<dg.length;dj++){dk+=" "+dg[dj]}}dm=dk;e.txtDraw(0,dm,30,30+df*14,0)}}if(interactiv.getCurrentPlayerLeaderboardPosition()>0){dk=Text_GetString(TEXT.MENU_XPLAYER_YOU)+":"+interactiv.getCurrentPlayerLeaderboardPosition()+" "+interactiv.getCurrentPlayerLeaderboardScore();var dg=interactiv.getCurrentPlayerLeaderboardScoreData();if(dg!=null){for(var dj=0;dj<dg.length;dj++){dk+=" "+dg[dj]}}e.txtDraw(0,dk,0,20,0)}};e.prototype.DrawOnlineState_TEST_GETRANK_AROUND_PLAYER=function(dn){var dm="";e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),dn.getClipWidth()/2,dn.getClipHeight()-1,Graphics.BOTTOM|Graphics.HCENTER);var dk;if(interactiv.getLeaderboardSize()<=0){dk=Text_GetString(TEXT.MENU_XPLAYER_NO_SCORE_SENT);dm=dk;e.txtDraw(0,dm,30,50,0);return}if(USE_CONDENSED_VERSION){var dq=interactiv.getLeaderboardSize();var dp=LowAPI.Gen_Array([dq],null);var dl=LowAPI.Gen_Array([dq],0);var di=LowAPI.Gen_Array([dq],0);var dh=LowAPI.Gen_Array([dq],null);if(interactiv.getLeaderboardData(dp,dl,di,dh)==false){return}for(var df=0;df<dq;df++){dk=""+dl[df]+": "+dp[df]+" "+di[df];if(dh!=null){var dg=dh[df];if(dg!=null){for(var dj=0;dj<dg.length;dj++){dk+=" "+dg[dj]}}}if(dp[df].compareTo(interactiv.getUsername())==0){dn.setColor(192,176,0)}else{dn.setColor(208,80,80)}dm=dk;e.txtDraw(0,dm,30,30+df*14,0)}}else{for(var df=0;df<interactiv.getLeaderboardSize();df++){dk=""+interactiv.getLeaderboardEntryPlayerPosition(df)+": "+interactiv.getLeaderboardEntryPlayerName(df)+" "+interactiv.getLeaderboardEntryPlayerScore(df);var dg=interactiv.getLeaderboardEntryPlayerScoreData(df);if(dg!=null){for(var dj=0;dj<dg.length;dj++){dk+=" "+dg[dj]}}if((interactiv.getLeaderboardEntryPlayerName(df)).compareTo(interactiv.getUsername())==0){dn.setColor(192,176,0)}else{dn.setColor(208,80,80)}dm=dk;e.txtDraw(0,dm,30,30+df*14,0)}}};e.prototype.DrawOnlineState_TEST_DISPLAY_GAME_RATINGS=function(dg){for(var df=a5;df>0;df--){if(a5-co==df){dg.setColor(13696768)}else{dg.setColor(13652048)}e.txtDraw(0,""+df+" - "+cp[df-1],dg.getClipWidth()/2,20+(a5-df)*10,Graphics.TOP|Graphics.HCENTER)}dg.setColor(13652048);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_CANCEL),1,dg.getClipHeight()-1,Graphics.BOTTOM|Graphics.LEFT);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_OK),dg.getClipWidth()-1,dg.getClipHeight()-1,Graphics.BOTTOM|Graphics.RIGHT)};e.prototype.DrawOnlineState_TEST_RATEGAME=function(df){var dg="";e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),df.getClipWidth()/2,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.HCENTER);dg=Text_GetString(TEXT.MENU_XPLAYER_RATING_SENT);e.txtDraw(0,dg,5,df.getClipHeight()>>1,0)};e.prototype.DrawOnlineState_TEST_RECOMMENDGAME=function(df){var dg="";e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_PRESS_5),df.getClipWidth()/2,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.HCENTER);dg=Text_GetString(TEXT.MENU_XPLAYER_RECOMMENDATION_SENT);e.txtDraw(0,dg,5,df.getClipHeight()>>1,0)};e.prototype.DrawOnlineState_TEST_CONNECTION_ERROR=function(df){var dg="";df.setColor(0);df.fillRect(0,0,df.getClipWidth(),df.getClipHeight());df.setColor(13652048);dg=Text_GetString(TEXT.MENU_XPLAYER_CONNECTION_ERROR);e.txtDraw(0,dg,10,df.getClipHeight()>>1,0);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_OK),df.getClipWidth()-1,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.RIGHT)};e.prototype.DrawOnlineState_TEST_SERVER_ERROR=function(df){var dg="";df.setColor(0);df.fillRect(0,0,df.getClipWidth(),df.getClipHeight());df.setColor(13652048);dg=Text_GetString(TEXT.MENU_XPLAYER_SERVER_ERROR_NR)+":"+interactiv.getLastError();e.txtDraw(0,dg,10,df.getClipHeight()>>1,0);e.txtDraw(0,Text_GetString(TEXT.MENU_XPLAYER_OK),df.getClipWidth()-1,df.getClipHeight()-1,Graphics.BOTTOM|Graphics.RIGHT)};e.prototype.updateOnline=function(){switch(aj){case de.INIT:break;case de.MENU:UpdateOnlineState_MENU();break;case de.TEST_LOGIN:UpdateOnlineState_TEST_LOGIN();break;case de.TEST_ARENA:UpdateOnlineState_TEST_ARENA();break;case de.TEST_SENDINGSCORE:UpdateOnlineState_TEST_SENDINGSCORE();break;case de.TEST_GETRANK:UpdateOnlineState_TEST_GETRANK();break;case de.TEST_GETRANK_AROUND_PLAYER:UpdateOnlineState_TEST_GETRANK_AROUND_PLAYER();break;case de.TEST_DISPLAY_GAME_RATINGS:UpdateOnlineState_TEST_DISPLAY_GAME_RATINGS();break;case de.TEST_RATEGAME:UpdateOnlineState_TEST_RATEGAME();break;case de.TEST_RECOMMENDGAME:UpdateOnlineState_TEST_RECOMMENDGAME();break;case de.TEST_CONNECTION_ERROR:UpdateOnlineState_TEST_CONNECTION_ERROR();break;case de.TEST_SERVER_ERROR:UpdateOnlineState_TEST_SERVER_ERROR();break;case de.ENDED:UpdateOnlineState_ENDED();break}};e.prototype.UpdateOnlineState_MENU=function(){if((s_keyState[GLKey.k_left]>0)){if(bR>0){bR--}}else{if((s_keyState[GLKey.k_right]>0)){if(bR<H-1){bR++}}else{if(s_keyState[GLKey.k_fire]>0){switch(bR){case MENU_STATE_TEST_ARENA:if(interactiv==null){if(DEF.dbgEnable){Dbg("make sure xplayer is here")}interactiv=new XPlayer(s_application)}if(interactiv.isLoggedIn()){this.setState(de.TEST_ARENA);break}bf=false;setState(de.TEST_LOGIN);break;case MENU_STATE_EXIT:aj=de.ENDED;break}}else{if((s_keyState[GLKey.k_menuOK]>0)||(s_keyState[GLKey.k_num3]>0)){interactiv.cancel();aj=de.ENDED}}}}};e.prototype.UpdateOnlineState_TEST_LOGIN=function(){switch(ab){case aT.SET:if(DEF.dbgEnable){Dbg("Xplayer is "+interactiv)}interactiv.sendLogin(null);this.setOnlineSubstate(aT.WAIT);break;case aT.WAIT:if(s_keyState[GLKey.k_menuOK]>0){interactiv.cancel();interactiv.setUsername("");interactiv.setPhoneNumber("");this.setState(de.MENU)}interactiv.handleLogin();R=interactiv.getLastError();if(R!=XPlayer.Error.ERROR_PENDING){interactiv.cleanup();this.setOnlineSubstate(aT.PROCESS)}break;case aT.PROCESS:switch(R){case XPlayer.Error.ERROR_NONE:this.setOnlineSubstate(aT.DISPLAY);break;case XPlayer.Error.ERROR_NICK_TAKEN:aF=interactiv.getUsername();interactiv.setUsername("");this.setState(de.TEST_NICK_TAKEN);bS=0;break;case XPlayer.Error.ERROR_REGISTER_FAILED:case XPlayer.Error.ERROR_NO_NICKNAME:case XPlayer.Error.ERROR_NO_PHONE_NUMBER:interactiv.setUsername("");interactiv.setPhoneNumber("");this.setState(de.TEST_REGISTER);bS=-1;break;case XPlayer.Error.ERROR_CONNECTION:this.setState(de.TEST_CONNECTION_ERROR);break;default:this.setState(de.TEST_SERVER_ERROR);break}break;case aT.DISPLAY:if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_ARENA)}else{if(s_keyState[GLKey.k_menuOK]>0){this.setState(de.MENU)}}break}};e.prototype.UpdateOnlineState_TEST_ARENA=function(){if(s_keyState[GLKey.k_menuOK]>0){interactiv.cancel();aj=de.MENU}else{if(s_keyState[GLKey.k_up]>0){if(cM>0){cM--}}else{if(s_keyState[GLKey.k_down]>0){if(cM<bA-1){cM++}}else{if(s_keyState[GLKey.k_fire]>0){switch(cM){case 0:this.setState(de.TEST_SENDINGSCORE);break;case 1:this.setState(de.TEST_GETRANK);break;case 2:this.setState(de.TEST_GETRANK_AROUND_PLAYER);break;case 3:this.setState(de.TEST_DISPLAY_GAME_RATINGS);break;case 4:this.setState(de.TEST_RECOMMENDGAME);break;case 5:aj=de.ENDED;break;default:break}}}}}};e.prototype.UpdateOnlineState_TEST_SENDINGSCORE=function(){switch(ab){case aT.SET:switch(currentScoreSendingPolicy){case b8.SINGLE_SCORE:interactiv.sendHighscore(500,0,XPlayer.SCORE_TYPE_POINTS);this.setOnlineSubstate(aT.WAIT);break;case b8.SINGLE_SCORE_SUPPLEMENTAL_DATA:var df=LowAPI.Gen_Array([1],0);df[0]=56;interactiv.sendHighscoreWithSupplementalData(600,0,XPlayer.SCORE_TYPE_POINTS,df);this.setOnlineSubstate(aT.WAIT);break;case b8.MULTIPLE_SCORE:interactiv.initMultipleScores();interactiv.addMultipleScoreEntry(600,0,XPlayer.SCORE_TYPE_POINTS);interactiv.addMultipleScoreEntry(700,1,XPlayer.SCORE_TYPE_POINTS);interactiv.sendMultipleHighscores();this.setOnlineSubstate(aT.WAIT);break;case b8.MULTIPLE_SCORE_SUPPLEMENTAL_DATA:interactiv.initMultipleScores();var df=LowAPI.Gen_Array([1],0);df[0]=1000;interactiv.addMultipleScoreEntryWithSupplementalData(600,0,XPlayer.SCORE_TYPE_POINTS,df);df[0]=1100;interactiv.addMultipleScoreEntryWithSupplementalData(700,1,XPlayer.SCORE_TYPE_POINTS,df);interactiv.sendMultipleHighscores();this.setOnlineSubstate(aT.WAIT);break}case aT.WAIT:if(s_keyState[GLKey.k_fire]>0){interactiv.cancel();this.setState(de.TEST_ARENA)}interactiv.handleHighscore();R=interactiv.getLastError();if(R!=XPlayer.Error.ERROR_PENDING){interactiv.cleanup();this.setOnlineSubstate(aT.PROCESS)}break;case aT.PROCESS:switch(R){case XPlayer.Error.ERROR_NONE:this.setOnlineSubstate(aT.DISPLAY);break;case XPlayer.Error.ERROR_CONNECTION:this.setState(de.TEST_CONNECTION_ERROR);break;default:this.setState(de.TEST_SERVER_ERROR);break}break;case aT.DISPLAY:if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_ARENA)}break}};e.prototype.UpdateOnlineState_TEST_GETRANK=function(){switch(ab){case aT.SET:interactiv.sendRankGet(0,10,1,2);this.setOnlineSubstate(aT.WAIT);break;case aT.WAIT:if(s_keyState[GLKey.k_menuOK]>0){interactiv.cancel();this.setState(de.TEST_ARENA)}interactiv.handleRankGet();R=interactiv.getLastError();if(R!=XPlayer.Error.ERROR_PENDING){interactiv.cleanup();this.setOnlineSubstate(aT.PROCESS)}break;case aT.PROCESS:switch(R){case XPlayer.Error.ERROR_NONE:this.setOnlineSubstate(aT.DISPLAY);break;case XPlayer.Error.ERROR_CONNECTION:this.setState(de.TEST_CONNECTION_ERROR);break;default:this.setState(de.TEST_SERVER_ERROR);break}break;case aT.DISPLAY:if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_ARENA)}break}};e.prototype.UpdateOnlineState_TEST_GETRANK_AROUND_PLAYER=function(){switch(ab){case aT.SET:interactiv.sendRankGetAroundPlayer(0,3,1,2);this.setOnlineSubstate(aT.WAIT);break;case aT.WAIT:if(s_keyState[GLKey.k_menuOK]>0){interactiv.cancel();this.setState(de.TEST_ARENA)}interactiv.handleRankGetAroundPlayer();R=interactiv.getLastError();if(R!=XPlayer.Error.ERROR_PENDING){interactiv.cleanup();this.setOnlineSubstate(aT.PROCESS)}break;case aT.PROCESS:switch(R){case XPlayer.Error.ERROR_NONE:this.setOnlineSubstate(aT.DISPLAY);break;case XPlayer.Error.ERROR_CONNECTION:this.setState(de.TEST_CONNECTION_ERROR);break;default:this.setState(de.TEST_SERVER_ERROR);break}break;case aT.DISPLAY:if((s_keyState[GLKey.k_fire]>0)){this.setState(de.TEST_ARENA)}break}};e.prototype.UpdateOnlineState_TEST_DISPLAY_GAME_RATINGS=function(){if(s_keyState[GLKey.k_up]>0){if(co>0){co--}}else{if(s_keyState[GLKey.k_down]>0){if(co<a5-1){co++}}else{if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_RATEGAME)}else{if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_ARENA)}}}}};e.prototype.UpdateOnlineState_TEST_RATEGAME=function(){switch(ab){case aT.SET:interactiv.sendRateGame(a5-co);this.setOnlineSubstate(aT.WAIT);break;case aT.WAIT:if(s_keyState[GLKey.k_menuOK]>0){interactiv.cancel();this.setState(de.TEST_ARENA)}interactiv.handleRateGame();R=interactiv.getLastError();if(R!=XPlayer.Error.ERROR_PENDING){interactiv.cleanup();this.setOnlineSubstate(aT.PROCESS)}break;case aT.PROCESS:switch(R){case XPlayer.Error.ERROR_NONE:this.setOnlineSubstate(aT.DISPLAY);break;case XPlayer.Error.ERROR_CONNECTION:this.setState(de.TEST_CONNECTION_ERROR);break;default:this.setState(de.TEST_SERVER_ERROR);break}break;case aT.DISPLAY:if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_ARENA)}break}};e.prototype.UpdateOnlineState_TEST_RECOMMENDGAME=function(){switch(ab){case aT.SET:interactiv.sendRecommendGame();this.setOnlineSubstate(aT.WAIT);break;case aT.WAIT:if(s_keyState[GLKey.k_menuOK]>0){interactiv.cancel();this.setState(de.TEST_ARENA)}interactiv.handleRecommendGame();R=interactiv.getLastError();if(R!=XPlayer.Error.ERROR_PENDING){interactiv.cleanup();this.setOnlineSubstate(aT.PROCESS)}break;case aT.PROCESS:switch(R){case XPlayer.Error.ERROR_NONE:this.setOnlineSubstate(aT.DISPLAY);break;case XPlayer.Error.ERROR_CONNECTION:this.setState(de.TEST_CONNECTION_ERROR);break;default:this.setState(de.TEST_SERVER_ERROR);break}break;case aT.DISPLAY:if(s_keyState[GLKey.k_fire]>0){this.setState(de.TEST_ARENA)}break}};e.prototype.UpdateOnlineState_TEST_CONNECTION_ERROR=function(){UpdateOnlineState_TEST_SERVER_ERROR()};e.prototype.UpdateOnlineState_TEST_SERVER_ERROR=function(){if(s_keyState[GLKey.k_fire]>0){if(interactiv.isLoggedIn()){aj=de.TEST_ARENA}else{aj=de.MENU}}};e.prototype.UpdateOnlineState_ENDED=function(){bi=STATE.GAMEPLAY_UPDATE};e.prototype.gameDraw=function(){SetClip(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight);if(e._inCinematicBlackScreen){FillRect(0,0,GLLibConfig.screenWidth,GLLibConfig.screenHeight)}else{CEntity.DrawAll(-1);CEntity.DrawRender(-1);this.DrawTextBubble()}};e.TEXT_BUBBLE_OVER=0;e.TEXT_BUBBLE_OPEN=1;e.TEXT_BUBBLE_TEXT=2;e.TEXT_BUBBLE_CLOSE=3;e._textBubbleState=e.TEXT_BUBBLE_OVER;e._textBubbleTime=0;e._textBubbleCurrentLine=0;e._textBubbleX=0;e._textBubbleY=0;e._textBubbleText=0;e._textBubbleCinematicID=0;e._textBubbleBigOne=false;e._textBubbleCurrentCursor=-1;e.StartTextBubble=function(dg,df,di,dh){e._textBubbleState=e.TEXT_BUBBLE_OPEN;e._textBubbleX=df;e._textBubbleY=di;e._textBubbleText=dh;e._textBubbleCinematicID=dg;e._textBubbleTime=0;e._textBubbleCurrentLine=0;e._textBubbleCurrentCursor=0};e.TEXT_BUBBLE_TEXT_LINE_COUNT=2;e.TEXT_BUBBLE_TEXT_ENTITY_HEIGHT=60*DScreen.RATIO;e.TEXT_BUBBLE_TEXT_ENTITY_OFFSET_X=20;e.prototype.DrawTextBubble=function(){if(e._textBubbleState==e.TEXT_BUBBLE_OVER){return true}var dl=CEntity._camX;var dk=CEntity._camY;var dw=false;if(e._textBubbleCinematicID<0){dw=true}if(dw){dl=Math_IntToFixedPoint(e._miniMapCameraX);dk=Math_IntToFixedPoint(e._miniMapCameraY+e.MINI_MAP_OFFSET_Y)}var dt=DEF.VIEW_W_D2;var dr=Math_FixedPointToInt(e._textBubbleY-dk);var di=0;var dv=e.TEXT_BUBBLE_TEXT_LINE_COUNT;if(e._textBubbleBigOne){dr=DEF.VIEW_H_D2;dv+=1}else{di=e._textBubbleX<dl+DEF.VIEW_W_D2_FLOAT?0:DFlags.FLIP_X;dt+=(di&DFlags.FLIP_X)!=0?e.TEXT_BUBBLE_TEXT_ENTITY_OFFSET_X:-e.TEXT_BUBBLE_TEXT_ENTITY_OFFSET_X;if(!dw){di|=e._textBubbleY<dk+DEF.VIEW_H_D2_FLOAT?DFlags.FLIP_Y:0}dr+=(di&DFlags.FLIP_Y)!=0?e.TEXT_BUBBLE_TEXT_ENTITY_HEIGHT>>2:-e.TEXT_BUBBLE_TEXT_ENTITY_HEIGHT}var du=Text_GetString(e._textBubbleText);var dg=e.spriteArray[DSpriteID.HINT];var dj=e._textBubbleTime++;var dn=DAnimID.HINT_DIALOG_POP_OUT;var df=DAnimID.HINT_DIALOG_DISPLAY;var dq=DAnimID.HINT_DIALOG_POP_IN;if(e._textBubbleX>dl+DEF.VIEW_W_D2_FLOAT/2&&e._textBubbleX<dl+DEF.VIEW_W_D2_FLOAT+DEF.VIEW_W_D2_FLOAT/2){dn=DAnimID.HINT_DIALOG_POP_OUT_3;df=DAnimID.HINT_DIALOG_DISPLAY_3;dq=DAnimID.HINT_DIALOG_POP_IN_3;if(dw){dn=DAnimID.HINT_DIALOG_POP_OUT_2;df=DAnimID.HINT_DIALOG_DISPLAY_2;dq=DAnimID.HINT_DIALOG_POP_IN_2}}if(e._textBubbleBigOne){if(e._textBubbleState<e.TEXT_BUBBLE_TEXT){e._textBubbleState=e.TEXT_BUBBLE_TEXT}else{if(e._textBubbleState==e.TEXT_BUBBLE_CLOSE){e.CloseTextBubble();return true}}df=DAnimID.HINT_DIALOG_POP}switch(e._textBubbleState){case e.TEXT_BUBBLE_OPEN:dg.PaintAFrame(g,dn,dj,dt,dr,di);if(dg.GetAFrames(dn)==dj){e._textBubbleState=e.TEXT_BUBBLE_TEXT}break;case e.TEXT_BUBBLE_TEXT:dg.PaintAFrame(g,df,0,dt,dr,di);var dp=LowAPI.Gen_Array([4],0);dg.GetAFrameRect(df,0,0,dp,di);e.txtSetFont(aV);var ds=0;var dh=e._multiLineTextCurrentCursor;e._multiLineTextCurrentCursor=e._textBubbleCurrentCursor;var dm=e.DrawMultiLineText(g,du,dt+dp[DEF.BOX_LEFT],dr+dp[DEF.BOX_TOP],GRPH.LEFT_TOP,1,dp[2],e._textBubbleCurrentLine,dv,ds);e._textBubbleCurrentCursor=e._multiLineTextCurrentCursor;e._multiLineTextCurrentCursor=dh;e.txtSetFont(cX);bB.PaintAFrame(g,DAnimID.TOUCHINTERFACE_PRESS_5_PEN,Math.floor(s_game_currentFrameNB/3)%bB.GetAFrames(DAnimID.TOUCHINTERFACE_PRESS_5_PEN),dt+dp[DEF.BOX_LEFT]+dp[2],dr+dp[DEF.BOX_TOP]+dp[3],0);if(!e.bIsPaused&&WasKeyPressed(GLKey.k_fire)){if(e._textBubbleCurrentCursor!=-1){e._textBubbleCurrentCursor=-1}else{if(dm){e._textBubbleState=e.TEXT_BUBBLE_CLOSE;e._textBubbleTime=0}else{e._textBubbleCurrentLine+=dv;e._textBubbleCurrentCursor=0}}}break;case e.TEXT_BUBBLE_CLOSE:dg.PaintAFrame(g,dq,dj,dt,dr,di);if(dg.GetAFrames(dq)-1==dj){e.CloseTextBubble();return true}break}return false};e.CloseTextBubble=function(){if(DEF.dbgEnable){Dbg("CloseTextBubble -----------------------------")}if(e._textBubbleState==e.TEXT_BUBBLE_OVER){return}e._textBubbleState=e.TEXT_BUBBLE_OVER;e._textBubbleTime=0;e._textBubbleBigOne=false;if(e._textBubbleCinematicID>=0){e._cinematicsFrameTime[e._textBubbleCinematicID]=-e._cinematicsFrameTime[e._textBubbleCinematicID]}e._textBubbleCurrentCursor=-1;e.overSkipIntro=true};e._multiLineTextIndex=LowAPI.Gen_Array([400],0);e._multiLineTextIndexCount=0;e._multiLineCurrentStr=null;e._multiLineLineOff=null;e._multiLineWordOff=LowAPI.Gen_Array([100],0);e._multiLineTextCurrentCursor=-1;e._needSpecialProcess=false;e.DrawMultiLineText=function(dM,dz,dD,dC,dG,dJ,dr,dv,dk,du){if(dz==null||dz==""){return true}var dI=dz.charAt(0)=="\u202A"?true:false;var dm=DEF.VIEW_W/2;var dy="";if(bX()){dM.prepareDrawString();dM.setFont("bold",11,"arial");dM.textCtx.textAlign="center";dM.textCtx.fillStyle="#ffffff";if(dI){dM.textCtx.textAlign="right";dm=DEF.VIEW_W-10;var dp=dz.length;if(dp>1){dz=dz.substring(1)}}}var dh=dJ;e.InitMultiLineText(dz,dr,cn);if(e._multiLineTextIndexCount<=0){dM.textCtx.restore();return true}var ds=dv;if(ds<0){dv=0}var dw=cn.GetLineHeight()+cn.GetLineSpacing();if((dG&Graphics.VCENTER)!=0){var dL=(dw)*e._multiLineTextIndexCount/2;dC-=dL/2}else{if((dG&Graphics.BOTTOM)!=0){var dL=(dw)*e._multiLineTextIndexCount/2;dC-=dL}}var dA=e._multiLineTextIndex[dv<<1];var dF=Math.min((dv+dk-1)<<1,e._multiLineTextIndexCount-2);var dH=false;var dB=0;for(var dO=dv<<1;dO<=dF;dO+=2){var dj=e._multiLineTextIndex[dO+1];if(e._multiLineTextCurrentCursor>=0&&dj-dA>e._multiLineTextCurrentCursor){dj=dA+e._multiLineTextCurrentCursor;dH=true}var dt=e._multiLineTextIndex[dO];if(dt<=dj){var di=LowAPI.Gen_Array([2],0);var dP=LowAPI.Gen_Array([2],0);var dE=0;var dq=dz.substring(dt,dj);var dl=dq.split("");var dx=false;var dg=C[B[b5]][f.STATE];for(var dK=0;dK<dl.length;dK++){if(dl[dK]=="<"||dl[dK]=="("){di[di[0]==0?0:1]=dK+1;if(dg!=STATE.POPUP_TNB_CONFIRM&&dg!=STATE.POPUP_TNB_TC){dl[dK]="^"}if(dq.charAt(dK)=="<"){dx=true}else{cE[dB++%3]=dC-7}}else{if(dq.charAt(dK)==">"||dl[dK]==")"){dP[dP[0]==0?0:1]=dK-1;if(dg!=STATE.POPUP_TNB_CONFIRM&&dg!=STATE.POPUP_TNB_TC){dl[dK]="^"}}else{if(dl[dK]!="\n"){dE+=cn.getCharSize(dq.charAt(dK))}}}if(dE>dr&&dl[dK]==" "){dl[dK]="\n"}}var dQ=0;var dn=0;if(b4==2){dn=ci+DGUI.INTERACE_TEXT_START_OFFSET_X}else{if(dk<=3){dn=dD}else{dn=dD-DEF.VIEW_W_D2+(DEF.VIEW_W-dE)/2}}if(!bX()){for(var dK=0;dK<dl.length;dK++){if(dx){if((dK>=di[0]&&dK<=dP[0]||dK>=di[1]&&dK<=dP[1])&&dK>0){cn.SetCurrentPalette(dQ)}else{cn.SetCurrentPalette(dJ)}}else{cn.SetCurrentPalette(dJ)}if(dl[dK]=="^"){continue}cn.SetSubString(dK,dK+1);cn.DrawStringOrChars(dM,dl.join(""),dl,dn,dC,2,true);cn.SetSubString(-1,-1);dn+=cn.getCharSize(dl[dK])}}else{var df=dl.join("");df=df.replace(/\|/g,"");if(!bg){if((dg==STATE.POPUP_TNB_CONFIRM||dg==STATE.POPUP_TNB_TC)&&dI){df="\u202B"+df+"\u202C"}cn.DrawStringOrChars(dM,df,dl,dm,dC,2,true)}else{if(dy!=""){dy=dy+"<br>"+df}else{dy=df}}}}else{e.txtDraw(dJ,dz,dD,dC,dG,dt,dj)}if(dH){break}dC+=dw+du}if(!e.bIsPaused&&e._multiLineTextCurrentCursor>=0){if(dH){e._multiLineTextCurrentCursor++}else{e._multiLineTextCurrentCursor=-1}}cn.SetSubString(-1,-1);if(bX()){if(!bg){dM.endDrawString()}else{dM.textCtx.restore();var dG=dI?"right":"center";var dN=dI?"rtl":"";if(V!=null){e.updateOverlayElement(dy,dG,dN)}}}return((dv+dk)>=(e._multiLineTextIndexCount/2))||ds<0};e.prototype.StringTokenize=function(dm,dk,dj,df,dl){var dn=0;dl[0]=dk-1;var dg=df.length;for(var di=dk;di<dj;di++){for(var dh=dg-1;dh>=0;dh--){if(dm.charAt(di)==df[dh]){dl[++dn]=di;break}}}dl[++dn]=dj;return dn};e.InitMultiLineText=function(dj,dg,di){if(e._multiLineCurrentStr==dj||dj==null){return}e._multiLineCurrentStr=dj;if(!bX()){dj=dj.trim().toUpperCase()}e._multiLineLineOff=di.WraptextB(dj,dg,GLLibConfig.screenHeight);var df=e._multiLineLineOff.length;e._multiLineTextIndex[0]=0;e._multiLineTextIndex[1]=e._multiLineLineOff[1];for(var dh=3;dh<df;dh+=2){e._multiLineTextIndex[dh-1]=e._multiLineLineOff[dh-2];e._multiLineTextIndex[dh]=e._multiLineLineOff[dh]}e._multiLineTextIndexCount=e._multiLineLineOff[0]<<1};e.prototype.GetStringWidth=function(dh,dg,df){cn.SetSubString(dg,df);cn.UpdateStringOrCharsSize(dh,null);return ASprite._text_w};e.INTERFACE_DRAW_CRYSTAL=0;e.INTERFACE_DRAW_1UP=1;e.INTERFACE_DRAW_GOLDEN_COIN=2;e.INTERFACE_DRAW_STAR=3;e._drawInterface=0;e.interfaceShowTime=LowAPI.Gen_Array([8],0);e.interfaceOffset=LowAPI.Gen_Array([8],0);e.OFFSET_MAX=30;e.ShowInterfaceElement=function(df){if(df<e.interfaceShowTime.length){e.interfaceOffset[df]=0;e.interfaceShowTime[df]=GLLibConfig.FPSLimiter*2;if(df==DValueList.BONUS_TYPE_CAKE){e.interfaceShowTime[df]=e.spriteArray[DSpriteID.EFFECT].GetAFrames(DAnimID.EFFECT_RANDOM_MAGIC)}else{if(df==DValueList.BONUS_TYPE_STAR){e.interfaceShowTime[df]=GLLibConfig.FPSLimiter<<2}else{if(df==DValueList.BONUS_TYPE_GOLD_COIN){e.interfaceShowTime[df]=GLLibConfig.FPSLimiter<<2}}}}};e.prototype.DrawInterface=function(){var dg=CEntity.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT);var di=!CEntity.AI_Hero_CheckMorph(DAI.HERO_MORPH_NONE);var dh=!dg;if(di){dh=!dg;var dj=CEntity.AI_Hero_GetMorph()-DAI.HERO_MORPH_FAT;if(CEntity.AI_Hero_GetMorph()==DAI.HERO_MORPH_SWORD_FISH_ATTACK){dj--}e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_PORTRAIT_FAT+dj,DGUI.INTERFACE_MARGIN_HORIZONTAL,DGUI.INTERFACE_MARGIN_VERTICAL,0)}else{e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_PORTRAIT,DGUI.INTERFACE_MARGIN_HORIZONTAL,DGUI.INTERFACE_MARGIN_VERTICAL,0)}e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_X,DGUI.INTERFACE_LIFE_OFFSET_X,DGUI.INTERFACE_MARGIN_VERTICAL_FORK,0);e.DrawInterfaceNumber(CEntity._HeroParams[DAI.HPI_LIVES],DGUI.INTERFACE_LIFE_NUM_OFFSET_X,DGUI.INTERFACE_MARGIN_VERTICAL_NUM,1,0);if(dg){e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_FAT_FRAME,DGUI.INTERFACE_MARGIN_ENERGY_HORIZONTAL,DGUI.INTERFACE_MARGIN_ENERGY_HEIGHT,0);g.setClip(DGUI.INTERFACE_MARGIN_ENERGY_HORIZONTAL+DGUI.INTERFACE_FAT_FILL_OFFSET_X,DGUI.INTERFACE_MARGIN_ENERGY_HEIGHT,CEntity._HeroMorphEnergy*DGUI.INTERFACE_FAT_FILL_WIDTH/100,DGUI.INTERFACE_BOTTOM_HEIGHT);e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_FAT_FILL,DGUI.INTERFACE_MARGIN_ENERGY_HORIZONTAL,DGUI.INTERFACE_MARGIN_ENERGY_HEIGHT,0);g.setClip(0,0,DEF.SCR_W,DEF.SCR_H)}e._interface.PaintAFrame(g,DAnimID.INTERFACE_DIAMOND,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.INTERFACE_DIAMOND),DGUI.INTERFACE_CRYSTAL_OFFSET_X,DGUI.INTERFACE_CRYSTAL_OFFSET_Y,0);e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_X,DGUI.INTERFACE_CRYSTAL_NUM_OFFSET_X,DGUI.INTERFACE_MARGIN_VERTICAL_FORK,0);e.DrawInterfaceNumber(CEntity._hero._hp,DGUI.INTERFACE_CRYSTAL_NUM_OFFSET_X+DGUI.INTERFACE_X_WIDTH+DGUI.INTERFACE_X_WIDTH_MARGIN,DGUI.INTERFACE_MARGIN_VERTICAL_NUM,1,0);if(e.interfaceShowTime[DValueList.BONUS_TYPE_1UP]>0){e.interfaceShowTime[DValueList.BONUS_TYPE_1UP]--}if(e.interfaceShowTime[DValueList.BONUS_TYPE_GOLD_COIN]>0){e.interfaceShowTime[DValueList.BONUS_TYPE_GOLD_COIN]--;var dk=s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_GOLDEN_COIN);var df,dl;df=DGUI.INTERFACE_STAR_OFFSET_X;dl=DGUI.INTERFACE_STAR_OFFSET_Y-18*DScreen.RATIO;e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_GOLDEN_COIN,dk,df,dl,0);df+=20*DScreen.RATIO;dl+=-14*DScreen.RATIO;e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_X,df,dl,0);df+=20*DScreen.RATIO;dl+=-5*DScreen.RATIO;if(CEntity._HeroParams[DAI.HPI_GOLDCOIN_COUNT]<=0){e._interface.SetCurrentPalette(1)}e.DrawInterfaceNumber(CEntity._HeroParams[DAI.HPI_GOLDCOIN_COUNT],df,dl,1,0);e._interface.SetCurrentPalette(0)}if(e.interfaceShowTime[DValueList.BONUS_TYPE_STAR]>0){e.interfaceShowTime[DValueList.BONUS_TYPE_STAR]--;var dk=s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_STAR);var df,dl;df=DGUI.INTERFACE_STAR_OFFSET_X;dl=DGUI.INTERFACE_STAR_OFFSET_Y-18*DScreen.RATIO;e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_STAR,dk,df,dl,0);df+=20*DScreen.RATIO;dl+=-DGUI.BONUS_STAR_OFFSETY;e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_X,df,dl,0);df+=20*DScreen.RATIO;dl+=-4*DScreen.RATIO;e.DrawInterfaceNumber(DAI.MAX_STAR_NUM-e._levelStarInfo[e._tempLevelId*DAI.STAR_INFO_SIZE],df,dl,1,0)}if(e.interfaceShowTime[DValueList.BONUS_TYPE_CAKE]>0){var dk=e.spriteArray[DSpriteID.EFFECT].GetAnimFrame(DAnimID.EFFECT_RANDOM_MAGIC,e.spriteArray[DSpriteID.EFFECT].GetAFrames(DAnimID.EFFECT_RANDOM_MAGIC)-e.interfaceShowTime[DValueList.BONUS_TYPE_CAKE]);e.spriteArray[DSpriteID.EFFECT].PaintFrame(g,dk,DGUI.INTERFACE_MORPH_EFFECT_OFFSET_X,DGUI.INTERAFCE_HERO_CHANGE_EFFECT_Y,0);e.spriteArray[DSpriteID.EFFECT].PaintFrame(g,dk,DGUI.INTERFACE_MORPH_EFFECT_OFFSET_X_2,DGUI.INTERAFCE_HERO_CHANGE_EFFECT_Y,0);e.spriteArray[DSpriteID.EFFECT].PaintFrame(g,dk,DGUI.INTERFACE_MORPH_EFFECT_OFFSET_X_3,DGUI.INTERAFCE_HERO_CHANGE_EFFECT_Y,0);e.interfaceShowTime[DValueList.BONUS_TYPE_CAKE]--}};e._itoa_buffer=LowAPI.Gen_Array([16],0);e.DrawInterfaceNumber=function(di,dm,dk,dj,dg){var dp=di;var dl=-1;while(dp>0){dl++;dp=Math.floor(dp/10)}if(dl<dj){dl=dj-1}else{dj=dl+1}for(var dh=0;dh<dj;dh++){e._itoa_buffer[dh]=0}dp=di;if(di<0){dp=0}do{e._itoa_buffer[dl--]=dp%10;dp=Math.floor(dp/10)}while(dp>0&&dl>=0);if((dg&GRPH.VCENTER)!=0){dk-=e._interface.GetFrameModuleHeight(DAnimID.INTERFACE_FRAME_0,0)>>1}if((dg&GRPH.HCENTER)!=0){var dn=0;for(var dh=0;dh<dj;dh++){var df=DAnimID.INTERFACE_FRAME_0+e._itoa_buffer[dh];dn+=e._interface.GetFrameModuleWidth(df,0)}dm-=dn>>1}for(var dh=0;dh<dj;dh++){var df=DAnimID.INTERFACE_FRAME_0+e._itoa_buffer[dh];e._interface.PaintFrame(g,df,dm,dk,0);dm+=e._interface.GetFrameModuleWidth(df,0)}};e.prototype.gameUpdate=function(){if(cT!=DPauseType.NONE){if(this.PauseUpdate()){return}}CEntity.UpdateAll(-1);if(CEntity._checkDropToGound){CEntity._hero._vY=DAI.GRAVITY;CEntity.UpdateAll(-1);CEntity._checkDropToGound=false;e.SetPause(DPauseType.FADE_IN,DPauseType.FADE_EFFECT_CIRCLE);CEntity._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_GO_OUTDOOR,0)}e.UpdateCinematic();bS=WasAnyKeyReleased();if(bS>=0){if(bS==GLKey.k_menuOK||(bS==GLKey.k_menuBack&&!e.bIsPaused&&e._textBubbleState==e.TEXT_BUBBLE_OVER&&!e.overSkipIntro)||(bq&&!e.bIsPaused)){e.initIngameMenu(STATE.MENU_INGAME)}else{e.overSkipIntro=false}if(bS==GLKey.k_menuBack){if(e.InCinemitic()){e.SkipCinemitic();CEntity.CheckActive();CEntity.UpdateAll(-1)}}}};e.initIngameMenu=function(df){e.bIsPaused=true;e.bIsMiniMap=bi==STATE.MENU_MAP;bi=df;cI=LowAPI.Gen_Array([f.MAX_DEPTH],0);B=LowAPI.Gen_Array([f.MAX_DEPTH],0);b5=0;B[b5]=bs;e.redrawAll=true;if(df==STATE.MENU_INGAME){e.PauseSoundBGM()}};e.prototype.PauseUpdate=function(){var df=false;if(cT==DPauseType.FADE_OUT||cT==DPauseType.FADE_IN){switch(da){case DPauseType.FADE_EFFECT_BLACK:if(cT==DPauseType.FADE_OUT){bU+=Math_FixedPointToInt(Math_FixedPoint_Multiply(DAI.EFFECT_FADE_VELOCITY,e._velocityRate));if(bU>=255){bU=255;df=true}}else{if(cT==DPauseType.FADE_IN){bU-=Math_FixedPointToInt(Math_FixedPoint_Multiply(DAI.EFFECT_FADE_VELOCITY,e._velocityRate));if(bU<=0){bU=0;df=true}}}break;case DPauseType.FADE_EFFECT_CIRCLE:if(cT==DPauseType.FADE_OUT){if(z>-DEF.TILE_W<<1){z-=DEF.TILE_W<<1}else{df=true}}else{if(cT==DPauseType.FADE_IN){if(z<DEF.SCR_H_D2+(DEF.SCR_H_D2>>1)){z+=DEF.TILE_W<<1}else{df=true}}}break;case DPauseType.FADE_EFFECT_SCANLINE:if(cT==DPauseType.FADE_OUT){if(z>0){z-=10*DScreen.RATIO;if(z<0){z=0}}else{df=true}}else{if(cT==DPauseType.FADE_IN){if(z<DEF.SCR_W){z+=10*DScreen.RATIO;if(z>DEF.SCR_W){z=DEF.SCR_W}}else{df=true}}}}}if(df){e.SetPause(DPauseType.NONE,0);return false}return true};e.SetPause=function(df,dg){cT=df;da=dg;z=0;if(df==DPauseType.FADE_OUT){if(dg==DPauseType.FADE_EFFECT_CIRCLE){z=DEF.SCR_H_D2+(DEF.SCR_H_D2>>1)}}};e.prototype.DrawFadeEffect=function(){if(cT==DPauseType.FADE_IN||cT==DPauseType.FADE_OUT){switch(da){case DPauseType.FADE_EFFECT_BLACK:if(bU>0){e.FillArgbRect(0,0,DEF.SCR_W,DEF.SCR_H,(bU<<24)|dc)}break;case DPauseType.FADE_EFFECT_CIRCLE:var df,dh;var dg=CEntity._hero;if(dg!=null){df=Math_FixedPointToInt(dg._posX-CEntity._camX);dh=Math_FixedPointToInt(dg._posY+dg._boundingBox[DEF.BOX_TOP]-CEntity._camY)}else{df=ar;dh=aq}e.DrawFadeCircle(g,df,dh,z);break;case DPauseType.FADE_EFFECT_SCANLINE:this.DrawFadeScanLine(g,1*DScreen.RATIO,z);break}}};e.prototype.DrawWeatherEffect=function(){};e.prototype.DrawFadeScanLine=function(di,df,dh){if(df<=0){return}di.setClip(0,0,DEF.SCR_W,DEF.SCR_H);di.setColor(0);for(var dg=0;dg<Math.floor(DEF.SCR_H/df)+1;dg++){if(dg%2==0){di.fillRect(z-DEF.SCR_W,dg*df,DEF.SCR_W,df)}else{di.fillRect(DEF.SCR_W-z,dg*df,DEF.SCR_W,df)}}};e.DrawFadeCircle=function(dh,df,dj,dg){dg=Math.max(dg,0);var di=((512-362)*dg)>>8;SetColor(4278190080);dh.fillTriangle(df+dg-di,dj-dg,df+dg,dj-dg,df+dg,dj-dg+di);dh.fillTriangle(df+dg-di,dj+dg,df+dg,dj+dg,df+dg,dj+dg-di);dh.fillTriangle(df-dg+di,dj+dg,df-dg,dj+dg,df-dg,dj+dg-di);dh.fillTriangle(df-dg+di,dj-dg,df-dg,dj-dg,df-dg,dj-dg+di);if(dj-dg>0){dh.fillRect(0,0,DEF.SCR_W,dj-dg)}if(df-dg>0){dh.fillRect(0,0,df-dg,DEF.SCR_H)}if(DEF.SCR_W-df+dg>0){dh.fillRect(df+dg,0,DEF.SCR_W-df+dg,DEF.SCR_H)}if(DEF.SCR_H-dj+dg>0){dh.fillRect(0,dj+dg,DEF.SCR_W,DEF.SCR_H-dj+dg)}};e.InitLevel=function(){e._entitiesRowData=LowAPI.Gen_Array([4000],null);e._entitiesRowTable.clear();e._entityMap.clear();e._entityRowDataCount=0;e._sprites_load_mask=DSpriteID.DEFAULT_SPRITES_LOAD_MASK};e.ReleaseLevel=function(dg){CEntity._camFocus=null;CEntity._camFocusA=null;CEntity._camFocusB=null;if(!dg&&(CEntity._hero!=null)){CEntity._HeroParams[DAI.HPI_LIVES]=e._playerInfo[DAI.HPI_LIVES];CEntity._hero._hp=e._playerInfo[DAI.HPI_HP_MAX]}CEntity._hero=null;CEntity._boss=null;CEntity._camera=null;CEntity._cameraDefault=null;CEntity._camOffsetY=0;CEntity._bullet=null;CEntity._HeroIce=null;CEntity._ThiefSoundBubbleLeft=null;CEntity._ThiefSoundBubbleRight=null;CEntity._TentacleSide=-1;CEntity._HurtByTentacle=false;CEntity._HeroKickableEntity=null;CEntity._HeroRelateEntity=null;CEntity._HeroMorphEnergy=0;CEntity._arrowShakeNum=0;e._entitiesRowTable.clear();e._entityMap.clear();e._entitiesRowData=null;e._entityRowDataCount=0;CEntity.s_levelRenderCount=0;CEntity._HeroInElectric=0;CEntity._HeroBeAttackByInkbomb=false;CEntity._HeroShowInkTime=0;CEntity._BossOctopusHurt=false;CEntity._BossOctopusHurtBySit=false;CEntity._inMiniGame=false;e._textBubbleState=e.TEXT_BUBBLE_OVER;e._textBubbleTime=0;ad=null;e._firstEnterIntoThisFunction=true;e._inCinematicBlackScreen=false;CEntity._monsterchestHP=null;e._popUpEnded=false;CEntity._camCircularScroll=false;CEntity._miniGameTriger=null;for(var df=0;df<e.interfaceShowTime.length;df++){e.interfaceShowTime[df]=0}};e.prototype.UnInit=function(){};e._cinematics=null;e._cinematicsId=null;e._cinematicsFrameTime=null;e._cinematicsFrameTotal=null;e._cinematicsStatus=null;e._cinematicsSkipping=false;e.DEFAULT_SPRITES_LOAD_MASK=(1<<DSpriteID.HERO);e._sprites_load_mask=e.DEFAULT_SPRITES_LOAD_MASK;e.LoadCinematics=function(dz){var dg=0;var dh=dz[dg++];e._cinematics=LowAPI.Gen_Array([dh],null);e._cinematicsId=LowAPI.Gen_Array([dh],0);e._cinematicsFrameTotal=LowAPI.Gen_Array([dh],0);e._cinematicsFrameTime=LowAPI.Gen_Array([dh],0);e._cinematicsStatus=LowAPI.Gen_Array([dh],0);var dv=e._cinematicsFrameTime.length;for(var du=0;du<dv;++du){e._cinematicsFrameTime[du]=-1}for(var du=0;du<dh;++du){var dx=0;var dw=Mem_GetShort(dz,dg);dg+=2;e._cinematicsId[du]=dw;var dl=dz[dg++];dg+=2;e._cinematics[du]=LowAPI.Gen_Array([dl],null);for(var ds=0;ds<dl;++ds){var di=dg;var df=dz[dg++];++dg;switch(df){case DCinematic.CTRACK_OBJ_LAYER:var dn=Mem_GetShort(dz,dg);dg+=2;break;case DCinematic.CTRACK_SI:var dq=Mem_GetShort(dz,dg);dg+=2;e._sprites_load_mask|=CEntity.GetSpriteLoadMask(dq);break}var dt=Mem_GetShort(dz,dg);dg+=2;for(var dr=0;dr<dt;++dr){var dy=Mem_GetShort(dz,dg);dg+=2;if(dy>dx){dx=dy}var dm=dz[dg++];for(var dp=0;dp<dm;++dp){var dj=dz[dg++]&255;switch(dj){case DCinematic.CCMD_CAMERA_SET_POS:case DCinematic.CCMD_CAMERA_CENTER_TO:case DCinematic.CCMD_OBJ_LAYER_SET_POS:case DCinematic.CCMD_BASIC_SET_POS:case DCinematic.CCMD_SI_SET_POS:dg+=2;dg+=2;break;case DCinematic.CCMD_OBJ_LAYER_SET_ANIM:case DCinematic.CCMD_SI_SET_ANIM:++dg;break;case DCinematic.CCMD_BASIC_SET_ACTION:dg+=2;break;case DCinematic.CCMD_OBJ_LAYER_ADD_FLAGS:case DCinematic.CCMD_OBJ_LAYER_REMOVE_FLAGS:case DCinematic.CCMD_SI_ADD_FLAGS:case DCinematic.CCMD_SI_REMOVE_FLAGS:dg+=4;break;case DCinematic.CCMD_BASIC_SEND_EVENT_3:dg+=2;case DCinematic.CCMD_BASIC_SEND_EVENT_2:case DCinematic.CCMD_NEW_OBJECT_SETPOSREF:dg+=2;dg+=2;break;case DCinematic.CCMD_NEW_BASIC_ACTIVE_OBJECT:case DCinematic.CCMD_NEW_BASIC_INACTIVE_OBJECT:case DCinematic.CCMD_NEW_BASIC_PLAY_SOUND:case DCinematic.CCMD_NEW_BASIC_TEXT_BUBBLE:case DCinematic.CCMD_NEW_OBJECT_TEXT_BUBBLE:case DCinematic.CCMD_NEW_SI_SET_PALETTE:case DCinematic.CCMD_NEW_OBJECT_SET_PALETTE:case DCinematic.CCMD_NEW_BASIC_CAMERA_QUAKE:case DCinematic.CCMD_NEW_OBJECT_SET_ZORDER:case DCinematic.CCMD_NEW_OBJECT_DIE:dg+=2;break;case DCinematic.CCMD_NEW_BASIC_STOP_SOUND:case DCinematic.CCMD_NEW_OBJECT_INACTIVE:case DCinematic.CCMD_NEW_OBJECT_ACTIVE:case DCinematic.CCMD_NEW_OBJECT_KEEP_CURRENT_POS:case DCinematic.CCMD_NEW_OBJECT_ESCAPE_FROM_CINEMATIC:case DCinematic.CCMD_NEW_BASIC_LEVEL_PASSED:case DCinematic.CCMD_NEW_BASIC_OPEN_BLACK_SCREEN:case DCinematic.CCMD_NEW_BASIC_BLACK_SCREEN:break;case DCinematic.CCMD_BASIC_SEND_OBJ_EVENT_3:case DCinematic.CCMD_BASIC_SEND_OBJ_EVENT_2:case DCinematic.CCMD_BASIC_SEND_OBJ_EVENT_1:case DCinematic.CCMD_BASIC_SEND_EVENT_1:default:if(DEF.dbgErr){Dbg("not code this type in cenimatic now.")}break}}}var dk=dg-di;e._cinematics[du][ds]=LowAPI.Gen_Array([dk+2],0);System.arraycopy(dz,di,e._cinematics[du][ds],0,dk)}e._cinematicsFrameTotal[du]=dx}};e.GetCinematicIndex=function(dh){var df=e._cinematicsId.length;for(var dg=0;dg<df;++dg){if(e._cinematicsId[dg]==dh){return dg}}return -1};e.InCinemitic=function(){var df=e._cinematicsId.length;for(var dg=0;dg<df;++dg){if((e._cinematicsStatus[dg]&DCinematic.STATUS_PLAYING)!=0&&(e._cinematicsStatus[dg]&DCinematic.STATUS_CIRCLE)==0){return true}}return false};e.StartCinemitic=function(dm){if(CEntity._hero._hp<0){return}var dp=e._cinematics[dm];e._cinematicsFrameTime[dm]=0;e._cinematicsStatus[dm]|=DCinematic.STATUS_PLAYING;var dn=dp.length;for(var dh=0;dh<dn;++dh){var dj=dp[dh];var dk=dj[0];var di=null;var dl=4;switch(dk){case DCinematic.CTRACK_BASIC:break;case DCinematic.CTRACK_CAMERA:CEntity._camera.SetFlag(DFlags.CENIMATIC);break;case DCinematic.CTRACK_OBJ_LAYER:var dq=Mem_GetShort(dj,2);dl+=2;if(CEntity._hero!=null&&dq==CEntity._hero._id){CEntity._hero.SetFlag(DFlags.CENIMATIC);CEntity._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_IDLE,0)}break;case DCinematic.CTRACK_SI:var df=Mem_GetShort(dj,2);if((e._cinematicsStatus[dm]&DCinematic.STATUS_CIRCLE)==0){var dg=LowAPI.Gen_Array([DParamIndex.DECOR_PALETTE+1],0);dg[DParamIndex.DECOR_SPRITE]=Mem_GetShort(dj,2);dg[DParamIndex.DECOR_Z_ORDER]=Z.DEFAULT;di=CEntity.CreateDynamicEntity(dg,DClassID.DECOR,0,0,0,0);Mem_SetShort(dj,2,di._id);di.SetFlag(DFlags.CENIMATIC)}dl+=2;break}Mem_SetShort(dj,dj.length-2,dl)}};e.SkipCinemitic=function(){if(DEF.dbgEnable){Dbg("SkipCinemitic -------------------")}e._cinematicsSkipping=true;e.CloseTextBubble();var df=e._cinematicsId.length;while(e.InCinemitic()){e.UpdateCinematic()}e._cinematicsSkipping=false};e.EndCinemitic=function(dh){if(DEF.dbgEnable){Dbg("EndCinemitic -------------------")}if(e._cinematicsFrameTime[dh]<0){return}if(Q){e.PlaySoundBGM()}var dj=e._cinematics[dh];e._cinematicsFrameTime[dh]=-2;e._cinematicsStatus[dh]|=DCinematic.STATUS_PLAYED;e._cinematicsStatus[dh]&=~DCinematic.STATUS_PLAYING;var df=dj.length;for(var dg=0;dg<df;++dg){var dk=dj[dg];var di=dk[0];var dl=null;switch(di){case DCinematic.CTRACK_CAMERA:if(CEntity._camera!=null){CEntity._camera.ClearFlag(DFlags.CENIMATIC)}break;case DCinematic.CTRACK_OBJ_LAYER:var dm=Mem_GetShort(dk,2);dl=CEntity.GetEntityByID(dm,false);if(dl!=null){dl.ClearFlag(DFlags.CENIMATIC)}break;case DCinematic.CTRACK_SI:var dm=Mem_GetShort(dk,2);if((e._cinematicsStatus[dh]&DCinematic.STATUS_CIRCLE)==0){dl=CEntity.GetEntityByID(dm,true);if(dl!=null){Mem_SetShort(dk,2,dl._params[DParamIndex.DECOR_SPRITE]);dl.SetInactived(true)}}break}}};e.UpdateCinematic=function(){var dK=0;var dx=e._cinematicsId.length;for(var dR=0;dR<dx;++dR){if(e._cinematicsFrameTime[dR]>=0){if((e._cinematicsStatus[dR]&DCinematic.STATUS_CIRCLE)==0){++dK}var dD=true;var dE=e._cinematics[dR];var dq=e._cinematicsFrameTime[dR]++;var dV=dE.length;if((e._tempLevelId==e._finalLevelIndex)&&(e._levelFinalInfo1==1)){e._cinematicsFrameTime[dR]=-2;e._cinematicsStatus[dR]|=DCinematic.STATUS_PLAYED;e._cinematicsStatus[dR]&=~DCinematic.STATUS_PLAYING;if(CEntity._camera!=null){CEntity._camera.ClearFlag(DFlags.CENIMATIC)}if(CEntity._hero!=null&&CEntity._hero.CheckFlag(DFlags.CENIMATIC)){CEntity._hero.ClearFlag(DFlags.CENIMATIC)}break}for(var dP=0;dP<dV;++dP){var dU=dE[dP];var dI=0;var dF=dU[dI];++dI;++dI;var dg=null;var dW=-1;switch(dF){case DCinematic.CTRACK_SI:case DCinematic.CTRACK_OBJ_LAYER:dW=Mem_GetShort(dU,dI);dI+=2;dg=CEntity.GetEntityByID(dW,true);dg.SetFlag(DFlags.CENIMATIC);if(dg==null){continue}break}dI=Mem_GetShort(dU,dU.length-2);var dw=dU.length-2;var dA=0,dz=0,dh=-1;var dj;var dT;var dy=0;var dQ=0;for(;dI<dw;){var di=Mem_GetShort(dU,dI);if(dq<di){dD=false;if(dq+1==di){Mem_SetShort(dU,dU.length-2,dI)}if(dg!=null){dg.SetFlag(DFlags.CENIMATIC)}}dI+=2;var dG=dU[dI++];var dS=false;for(var dO=0;dO<dG;++dO){var dk=dU[dI++]&255;var dl=di==dq;var df=di>=dq;switch(dk){case DCinematic.CCMD_CAMERA_SET_POS:case DCinematic.CCMD_CAMERA_CENTER_TO:case DCinematic.CCMD_OBJ_LAYER_SET_POS:case DCinematic.CCMD_BASIC_SET_POS:case DCinematic.CCMD_SI_SET_POS:var dv=Mem_GetShort(dU,dI);dI+=2;var du=Mem_GetShort(dU,dI);dI+=2;if(df){dA=dv;dz=du;if(dk==DCinematic.CCMD_CAMERA_CENTER_TO){dA-=DEF.VIEW_W_D2;dz-=DEF.VIEW_H_D2}dh=di;dS=true}break;case DCinematic.CCMD_NEW_OBJECT_ESCAPE_FROM_CINEMATIC:if(df){dg.ClearFlag(DFlags.CENIMATIC);dS=true}break;case DCinematic.CCMD_NEW_OBJECT_SETPOSREF:var dp=Mem_GetShort(dU,dI);dI+=2;var dn=Mem_GetShort(dU,dI);dI+=2;if(df){dA=(dg._posX>>DEF.SHIFT)+dp;dz=(dg._posY>>DEF.SHIFT)+dn;dh=di;dS=true}break;case DCinematic.CCMD_OBJ_LAYER_SET_ANIM:case DCinematic.CCMD_SI_SET_ANIM:var dH=dU[dI++]&255;if(dl){if(dg!=null){dg.SetAnim(dH,CEntity.SETANIM_FORCE)}}break;case DCinematic.CCMD_BASIC_SET_ACTION:dI+=2;break;case DCinematic.CCMD_BASIC_SEND_EVENT_2:var dN=Mem_GetShort(dU,dI);dI+=2;var dM=Mem_GetShort(dU,dI);dI+=2;break;case DCinematic.CCMD_BASIC_SEND_EVENT_3:var dN=Mem_GetShort(dU,dI);dI+=2;var dM=Mem_GetShort(dU,dI);dI+=2;var dL=Mem_GetShort(dU,dI);dI+=2;break;case DCinematic.CCMD_OBJ_LAYER_ADD_FLAGS:case DCinematic.CCMD_SI_ADD_FLAGS:dj=Mem_GetInt(dU,dI);dI+=4;if(dl){if((dj&8388608)!=0){dj&=~8388608;dj|=DFlags.INVISIBLE}if(dg!=null){dg._flags|=dj}}break;case DCinematic.CCMD_OBJ_LAYER_REMOVE_FLAGS:case DCinematic.CCMD_SI_REMOVE_FLAGS:dj=Mem_GetInt(dU,dI);dI+=4;if(dl){if((dj&8388608)!=0){dj&=~8388608;dj|=DFlags.INVISIBLE}dg._flags&=~dj}break;case DCinematic.CCMD_NEW_BASIC_CAMERA_QUAKE:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){CEntity.AI_CameraQuake(Math_IntToFixedPoint(dT))}if(dq>di){CEntity.AI_CameraQuakeUpdate()}break;case DCinematic.CCMD_NEW_BASIC_BLACK_SCREEN:if(dl){e._inCinematicBlackScreen=true}break;case DCinematic.CCMD_NEW_BASIC_OPEN_BLACK_SCREEN:if(dl){e._inCinematicBlackScreen=false}break;case DCinematic.CCMD_NEW_BASIC_INACTIVE_OBJECT:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){InactiveEntityOrCinematic(dT,true)}break;case DCinematic.CCMD_NEW_OBJECT_INACTIVE:if(dl){if(dg!=null){dg._params[DParamIndex.FLAGS]|=DFlags.CENIMATIC;dg.SetInactived(true)}}break;case DCinematic.CCMD_NEW_OBJECT_NOTIFY:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){dg.NotifyEvent(null,DEvent.BE_TRIGGERED_BY_CINEMATIC,dT,0,0)}break;case DCinematic.CCMD_NEW_OBJECT_KEEP_CURRENT_POS:if(df){if(dF==DCinematic.CTRACK_CAMERA){dA=Math_FixedPointToInt(CEntity._camX);dz=Math_FixedPointToInt(CEntity._camY)}else{dA=Math_FixedPointToInt(dg._posX);dz=Math_FixedPointToInt(dg._posY)}dh=di;dS=true}break;case DCinematic.CCMD_NEW_BASIC_TEXT_BUBBLE:dT=Mem_GetShort(dU,dI);dI+=2;if(dl&&!e._cinematicsSkipping){e._textBubbleBigOne=true;e.StartTextBubble(dR,-1,-1,dT);e._cinematicsFrameTime[dR]=-e._cinematicsFrameTime[dR]}break;case DCinematic.CCMD_NEW_OBJECT_TEXT_BUBBLE:dT=Mem_GetShort(dU,dI);dI+=2;if(dl&&!e._cinematicsSkipping){e.StartTextBubble(dR,dg._posX,dg._posY,dT);e._cinematicsFrameTime[dR]=-e._cinematicsFrameTime[dR]}break;case DCinematic.CCMD_NEW_BASIC_PLAY_SOUND:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){e.PlaySound(DSound_Channel.SFX,dT)}break;case DCinematic.CCMD_NEW_BASIC_STOP_SOUND:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){e.StopSound(dT)}break;case DCinematic.CCMD_NEW_OBJECT_SET_PALETTE:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){dg._tempParams[DTempParamIndex.CINEMATIC_PALETTE]=dT}break;case DCinematic.CCMD_NEW_OBJECT_SET_ZORDER:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){dg._zOrder=dT;CEntity.UpdateDrawList(dg)}break;case DCinematic.CCMD_NEW_SI_SET_PALETTE:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){if(dg!=null&&dg._classID==DClassID.DECOR){dg._params[DParamIndex.DECOR_PALETTE]=dT}}break;case DCinematic.CCMD_NEW_OBJECT_DIE:dT=Mem_GetShort(dU,dI);dI+=2;if(dl){if(dg!=null){dg._tempParams[DTempParamIndex.BOSS_DEAD_EFFECT_FADE_DIRECTION]=dT;dg.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}}break;case DCinematic.CCMD_NEW_BASIC_LEVEL_PASSED:if(dl){e.GotoNextLevel(true)}break}}if(dS){if(dq==di&&dI<dw){dD=false;di=Mem_GetShort(dU,dI);if(dq+1==di){Mem_SetShort(dU,dU.length-2,dI)}dI+=2}break}}var dJ=null;if(dF!=DCinematic.CTRACK_CAMERA&&dg==null){dJ=CEntity.GetRowDataByID(dW)}if(dh<0){continue}if(dF!=DCinematic.CTRACK_CAMERA&&dg==null&&dJ==null){continue}var dC=0;var dB=0;if(dF==DCinematic.CTRACK_CAMERA){CEntity._camera.SetFlag(DFlags.CENIMATIC);dC=CEntity._camera._posX;dB=CEntity._camera._posY}else{if(dg!=null){dC=dg._posX;dB=dg._posY}else{dC=Math_IntToFixedPoint(dJ[DParamIndex.POSX]);dB=Math_IntToFixedPoint(dJ[DParamIndex.POSY])}}if(dh>=0){var ds;var dr;dA<<=DEF.SHIFT;dz<<=DEF.SHIFT;if(dh==dq){ds=dA-dC;dr=dz-dB;dC=dA;dB=dz}else{var dm=dh-dq+1;dm*=DEF.ANIMATION_FRAME_TICK;ds=(dA-dC)*1000/(dm);dr=(dz-dB)*1000/(dm);ds=Math_FixedPoint_Multiply(ds,e._velocityRate);dr=Math_FixedPoint_Multiply(dr,e._velocityRate);dC+=ds;dB+=dr}if(dF==DCinematic.CTRACK_CAMERA){CEntity._camera._posX=dC;CEntity._camera._posY=dB;CEntity.SetCameraPos(dC+CEntity._camOffsetX,dB+CEntity._camOffsetY)}else{if(dg!=null){dg._posX=dC;dg._posY=dB}else{if(dJ!=null){dJ[DParamIndex.POSX]=Math_FixedPointToInt(dC);dJ[DParamIndex.POSY]=Math_FixedPointToInt(dB)}}}}}if(dD){e.EndCinemitic(dR);if((e._cinematicsStatus[dR]&DCinematic.STATUS_CIRCLE)!=0){e.StartCinemitic(dR)}if((e._tempLevelId==e._finalLevelIndex)&&(e._levelFinalInfo1!=1)){e._levelFinalInfo1=1;e.RMS_Save()}}}}return dK};e.ActiveEntityOrCinematic=function(di){if(di>0){var dg=CEntity.GetRowDataByID(di);if(dg!=null){var df=CEntity.GetEntityByID(di,true);if(df!=null&&!df.CheckFlag(DFlags.DYNAMIC_CREATE)){return df}}else{var dh=e.GetCinematicIndex(di);if(dh>=0){if(e._cinematicsFrameTime[dh]<0){e.StartCinemitic(dh)}else{e._cinematicsStatus[dh]|=DCinematic.STATUS_CIRCLE}}else{if(DEF.dbgErr){Dbg("Could not find object: id = "+di)}}}}return null};e.InactiveEntityOrCinematic=function(dj,df){if(dj>0){var dh=CEntity.GetRowDataByID(dj);if(dh!=null){var dg=CEntity.GetEntityByID(dj,false);if(dg!=null&&!dg.CheckFlag(DFlags.DYNAMIC_CREATE)){dg.SetInactived(true);return dg}}else{var di=e.GetCinematicIndex(dj);if(di>=0){e._cinematicsStatus[di]&=~DCinematic.STATUS_CIRCLE}else{if(DEF.dbgErr){System.out.print("error id: "+dj)}}}}return null};e._checkPointData=null;e.CHECK_POINT_MAX_SIZE=20;e.SaveCheckPoint=function(dg,dh,df,dk){if(e._checkPointData==null){e._checkPointData=LowAPI.Gen_Array([e.CHECK_POINT_MAX_SIZE],0)}var di=0;if(dg==e._checkPointData[0]){return}e._checkPointData[di++]=dg;if(CEntity._hero==null){e._checkPointData[di++]=-1}else{e._checkPointData[di++]=CEntity._hero._id;if(CEntity._hero.CheckFlag(DFlags.FLIP_Y)){e._checkPointData[di++]=Math_FixedPointToInt(CEntity._hero._posX);e._checkPointData[di++]=Math_FixedPointToInt(dk+CEntity._hero._boundingBox[DEF.BOX_BOTTOM])}else{e._checkPointData[di++]=Math_FixedPointToInt(CEntity._hero._posX);e._checkPointData[di++]=Math_FixedPointToInt(dk)}e._checkPointData[di++]=CEntity._HeroInElectric}if(CEntity._camera==null){e._checkPointData[di++]=-1}else{e._checkPointData[di++]=CEntity._camera._id;e._checkPointData[di++]=CEntity._camera._curTrace;if(CEntity._camera._curTrace>0){e._checkPointData[di++]=Math_FixedPointToInt(CEntity._hero._posX-DEF.VIEW_W_D2_FLOAT)}else{e._checkPointData[di++]=Math_FixedPointToInt(CEntity._camera._posX)}e._checkPointData[di++]=Math_FixedPointToInt(CEntity._camera._posY)}if(CEntity._boss==null){e._checkPointData[di++]=-1}else{e._checkPointData[di++]=CEntity._boss._id;e._checkPointData[di++]=-1;e._checkPointData[di++]=0}var dj=CEntity.GetEntityByID(dh,false);if(dj==null){e._checkPointData[di++]=-1}else{e._checkPointData[di++]=dh;e._checkPointData[di++]=dj._curTrace;e._checkPointData[di++]=Math_FixedPointToInt(dj._posX);e._checkPointData[di++]=Math_FixedPointToInt(dj._posY)}};e.LoadCheckPoint=function(){if(e._checkPointData!=null){var dm=0;var dn=e._checkPointData[dm++];var dl=CEntity.GetRowDataByID(e._checkPointData[dm++]);if(dl!=null){dl[DParamIndex.POSX]=e._checkPointData[dm++];dl[DParamIndex.POSY]=e._checkPointData[dm++];CEntity._HeroInElectric=e._checkPointData[dm++];CEntity._hero=CEntity.GetEntityByID(dl[DParamIndex.ID],true);if(CEntity._hero!=null){CEntity._hero.SetPos(Math_IntToFixedPoint(dl[DParamIndex.POSX]),Math_IntToFixedPoint(dl[DParamIndex.POSY]));CEntity.SetCameraFocus(CEntity._hero,true)}}var dg=e._checkPointData[dm++];var di=CEntity.GetRowDataByID(dg);if(dg!=-1){var ds=e._checkPointData[dm++];var dh=Math_IntToFixedPoint(e._checkPointData[dm++]);var df=Math_IntToFixedPoint(e._checkPointData[dm++]);if(CEntity._camera==null){CEntity._camera=CEntity.GetDefaultCamera()}if(CEntity._camera!=null){if(ds!=-1){di[DParamIndex.CAMERA_TRACE]=ds;di[DParamIndex.POSX]=Math_FixedPointToInt(dh);di[DParamIndex.POSY]=Math_FixedPointToInt(df);CEntity._camera=CEntity.GetEntityByID(di[DParamIndex.ID],true)}CEntity._camera._curTrace=ds;CEntity.SetCameraFocus(CEntity._hero,true);CEntity._camera.SetPos(dh,df);CEntity._camera.AI_CameraDest()}}var dq=e._checkPointData[dm++];var dk=CEntity.GetRowDataByID(dq);if(dq!=-1){var dr=e._checkPointData[dm++]}var dt=e._checkPointData[dm++];var dj=CEntity.GetRowDataByID(dt);if(dt!=-1){var ds=e._checkPointData[dm++];var dh=Math_IntToFixedPoint(e._checkPointData[dm++]);var df=Math_IntToFixedPoint(e._checkPointData[dm++]);var dp=CEntity.GetEntityByID(dt,true);if(dp!=null){dp._curTrace=ds;dp.SetPos(dh,df)}}}};e.DrawLine_FixedPoint=function(dg,di,df,dh){DrawLine(Math_FixedPointToInt(dg-CEntity._camX),Math_FixedPointToInt(di-CEntity._camY),Math_FixedPointToInt(df-CEntity._camX),Math_FixedPointToInt(dh-CEntity._camY))};e.DrawRect_FixedPoint=function(df,di,dg,dh){DrawRect(Math_FixedPointToInt(df-CEntity._camX),Math_FixedPointToInt(di-CEntity._camY),Math_FixedPointToInt(dg),Math_FixedPointToInt(dh))};e.DrawString_FixedPoint=function(dh,df,di,dg){DrawString(dh,Math_FixedPointToInt(df-CEntity._camX),Math_FixedPointToInt(di-CEntity._camY),dg)};e.DrawAFrame_FixedPoint=function(di,dh,dj,df,dk,dg){e.spriteArray[di].PaintAFrame(g,dh,dj,Math_FixedPointToInt(df-CEntity._camX),Math_FixedPointToInt(dk-CEntity._camY),dg&DFlags.SPRITE_FLAG_MASK)};e.DrawAnimation=function(dk,di,df,dl,dg){var dj=e.spriteArray[dk].GetAFrameTime(di,0);var dh=Math.floor(s_game_currentFrameNB/dj)%e.spriteArray[dk].GetAFrames(di);e.spriteArray[dk].PaintAFrame(g,di,dh,df,dl,dg&DFlags.SPRITE_FLAG_MASK)};e.prototype.BuildCacheImages=function(dg,df){if(dg._module_image_imageAA==null){dg._module_image_imageAA=LowAPI.Gen_Array([dg._palettes],null)}if(dg._module_image_imageAA[df]==null){dg._module_image_imageAA[df]=LowAPI.Gen_Array([dg._nModules],null)}for(var dh=0;dh<dg._nModules;dh++){if(dg._module_types[dh]==ASprite.MD_IMAGE){var di=0;if(GLLibConfig.sprite_useModuleDataOffAsShort){di=dg._modules_data_off_short[dh]&65535}else{di=dg._modules_data_off_int[dh]}dg._module_image_imageAA[df][dh]=createRGBImageCache(dg,dg._modules_data,df,di,dg.GetModuleWidth(dh),dg.GetModuleHeight(dh))}}};e.prototype.createRGBImageCache=function(dg,dm,dv,dq,dk,dj){var dt=0;var dl=dk*dj;var dh=0;var dr=false;var df=dg._pal_short[0][dv];var dp=LowAPI.Gen_Array([dk*dj],0);if(dg._data_format==ASprite.ENCODE_FORMAT_I256){while(dt<dl){dh=df[dm[dq++]&255];if((dh&61440)!=61440){dr=true}dp[dt++]=converColorShortToInt(dh)}}else{if(dg._data_format==ASprite.ENCODE_FORMAT_I127RLE){while(dt<dl){var du=dm[dq++]&255;if(du>127){var dn=dm[dq++]&255;dh=df[dn];du-=128;while(du-->0){dp[dt++]=converColorShortToInt(dh)}}else{dp[dt++]=converColorShortToInt(df[du])}}}}return Image.createRGBImage(dp,dk,dj,true)};e.prototype.converColorShortToInt=function(df){return(((df&61440)<<16)|((df&61440)<<12)|((df&3840)<<12)|((df&3840)<<8)|((df&240)<<8)|((df&240)<<4)|((df&15)<<4)|((df&15)))};e.s_rewindEffectFrame=0;e.k_gradientYellow=0;e.k_gradientRed=1;e.k_gradientWhite=2;e.k_gradientLBlur=3;e.k_gradientRBlur=4;e.k_gradientLRewind=5;e.k_gradientRRewind=6;e.paintVideoRewindEffect=function(df){e.s_rewindEffectFrame++;var dg=(e.s_rewindEffectFrame&1)==0;paintVerticalGradientEffect(df,0,60,DEF.VIEW_W,24,dg?60:110,e.k_gradientLRewind);paintVerticalGradientEffect(df,0,80,DEF.VIEW_W,15,dg?110:80,e.k_gradientLRewind);paintVerticalGradientEffect(df,0,120,DEF.VIEW_W,20,dg?60:110,e.k_gradientRRewind);paintVerticalGradientEffect(df,0,125,DEF.VIEW_W,27,dg?110:80,e.k_gradientLRewind);paintVerticalGradientEffect(df,0,210,DEF.VIEW_W,15,dg?60:110,e.k_gradientRRewind);paintVerticalGradientEffect(df,0,245,DEF.VIEW_W,18,dg?80:120,e.k_gradientLRewind);paintVerticalGradientEffect(df,0,260,DEF.VIEW_W,10,dg?60:90,e.k_gradientRRewind);paintVerticalGradientEffect(df,0,263,DEF.VIEW_W,15,dg?110:80,e.k_gradientLRewind)};e.desaturateBlock=function(ds,dg,dh){for(var dk=0;dk<ds;dk++){var dn=dg[dk];var dl=(dn)&16711680;var dp=(dn)&65280;var dm=(dn)&255;var df=((dl>>16)+(dp>>8)+dm+16)>>2;var di=(df<<16);var dq=(df<<8);var dr=(df);di=dl+((di-dl)*dh>>7);dq=dp+((dq-dp)*dh>>7);dr=dm+((dr-dm)*dh>>7);var dj=(di&16711680)|(dq&65280)|dr;dg[dk]=dj}};e.paintDesaturatedEffect=function(dl,dq,dp,dg,dr,di){try{var dh=ASprite.transform_int;var df=GLLibConfig.TMP_BUFFER_SIZE/dg;var dj=80;var dn=0;var dk=false;while(!dk){dj=dr-dn;if(dj>df){dj=df-1}else{dk=true}var ds=dg*dj;desaturateBlock(ds,dh,di);dl.drawRGB(dh,0,dg,dq,dp+dn,dg,dj,false);dn+=dj}}catch(dm){if(DEF.dbgEnable){Dbg("-------------------- error : "+dm.message)}}};e.blurDesaturateBlock=function(dp,dw,dv,dk){var du=0;var dj=0;var dm=0;var df=0;for(var dr=dp-1;dr>=0;dr--){var dq=dw[dr];var dx=(dq)&16711935;var dy=(dq)&65280;dm=(dx+((dm-dx)*dv>>7))&16711935;df=(dy+((df-dy)*dv>>7))&65280;var ds=dm|df;dw[dr]=ds}for(var dr=0;dr<dp;dr++){var dq=dw[dr];var dt=(dq)&16711680;var dy=(dq)&65280;var di=(dq)&255;du=dt+((du-dt)*dv>>7);df=dy+((df-dy)*dv>>7);dj=di+((dj-di)*dv>>7);var dh=((du>>16)+(df>>8)+dj+16)>>2;var dg=(dh<<16);var dl=(dh<<8);var dn=(dh);dg=du+((dg-du)*dk>>7);dl=df+((dl-df)*dk>>7);dn=dj+((dn-dj)*dk>>7);var ds=(dg&16711680)|(dl&65280)|dn;dw[dr]=ds}};e.paintIGMBlurEffect=function(dl,ds,dr,dg,dt,dm,di){try{var dh=ASprite.transform_int;var dq=dm%128;var df=GLLibConfig.TMP_BUFFER_SIZE/dg;var dj=80;var dp=0;var dk=false;while(!dk){dj=dt-dp;if(dj>df){dj=df-1}else{dk=true}var du=dg*dj;blurDesaturateBlock(du,dh,dq,di);dl.drawRGB(dh,0,dg,ds,dr+dp,dg,dj,false);dp+=dj}}catch(dn){if(DEF.dbgEnable){Dbg("-------------------- error : "+dn.message)}}};e.blurRBlock=function(dp,dg,dk){var dl=0;var df=0;for(var di=dp-1;di>=0;di--){var dj=dg[di];var dm=(dj)&16711935;var dn=(dj)&65280;dl=(dm+((dl-dm)*(dk)>>7))&16711935;df=(dn+((df-dn)*(dk)>>7))&65280;var dh=dl|df;dg[di]=dh}};e.blurLBlock=function(dp,dg,dk){var dl=0;var df=0;for(var di=0;di<dp;di++){var dj=dg[di];var dm=(dj)&16711935;var dn=(dj)&65280;dl=(dm+((dl-dm)*(dk)>>7))&16711935;df=(dn+((df-dn)*(dk)>>7))&65280;var dh=dl|df;dg[di]=dh}};e.paintBlurEffect=function(dl,ds,dr,dg,dt,dq,dk){try{var dh=ASprite.transform_int;var dp=dk%128;var df=GLLibConfig.TMP_BUFFER_SIZE/dg;var di=80;var dn=0;var dj=false;while(!dj){di=dt-dn;if(di>df){di=df-1}else{dj=true}var du=dg*di;if(dq==0){blurRBlock(du,dh,dp)}else{blurLBlock(du,dh,dp)}dl.drawRGB(dh,0,dg,ds,dr+dn,dg,di,false);dn+=di}}catch(dm){if(DEF.dbgEnable){Dbg("-------------------- error : "+dm.message)}}};e.paintBlurEffectCurved=function(dB,dq,dp,dy,du,dj,dl){try{if(dq+dy>DEF.SCR_W){dy=DEF.SCR_W-dq}if(dp+du>DEF.SCR_H){du=DEF.SCR_H-dp}if(dq<0){dy+=dq;dq=0}if(dp<0){du+=dp;dp=0}if(dy<=0||du<=0){return}var dE=ASprite.transform_int;var dD=dl;if(dD>127){dD=127}if(dD<0){dD=0}var ds=GLLibConfig.TMP_BUFFER_SIZE/dy;var dm=80;var dn=0;var df=0;var dr=0;var dh=0;var dw=0;var dv=false;var dk=0;var di=0;var dg=0;while(!dv){dm=du-dw;if(dm>ds){dm=ds-1}else{dv=true}var dt=dy*dm;if(dj==0){for(var dA=dt-1;dA>=0;dA--){var dx=dE[dA];var dF=(dx)&16711935;var dG=(dx)&65280;dn=(dF+((dn-dF)*(dD)>>7))&16711935;df=(dG+((df-dG)*(dD)>>7))&65280;var dz=dn|df;dE[dA]=dz}}else{if(dj==1){for(var dA=0;dA<dt;dA++){var dx=dE[dA];var dF=(dx)&16711935;var dG=(dx)&65280;di++;if(di>dy){di=1;if(dg==0){dk++;if(dk>du>>1){dg=1}}else{dk--}dn=dF;df=dG;dr=(dD*dk)/(du>>1);if(dr>100){dr=100}}dn=(dF+((dn-dF)*(dr)>>7))&16711935;df=(dG+((df-dG)*(dr)>>7))&65280;var dz=dn|df;dE[dA]=dz}}else{if(dj==2){for(var dA=dt-1;dA>=0;dA--){var dx=dE[dA];var dF=(dx)&16711935;var dG=(dx)&65280;di++;if(di>dy){di=1;if(dg==0){dk++;if(dk>du>>1){dg=1}}else{dk--}dn=dF;df=dG;dr=(dD*dk)/(du>>1);if(dr>100){dr=100}}dn=(dF+((dn-dF)*(dr)>>7))&16711935;df=(dG+((df-dG)*(dr)>>7))&65280;var dz=dn|df;dE[dA]=dz}}}}dB.drawRGB(dE,0,dy,dq,dp+dw,dy,dm,false);dw+=dm}}catch(dC){Dbg("ERROR: ----------------- "+dC.message)}};e.CLAMP_R=function(df){return(((df<<7)>>31)|df)&16711680};e.CLAMP_G=function(df){return(((df<<15)>>31)|df)&65280};e.CLAMP_B=function(df){return(((df<<23)>>31)|df)&255};e.gradientRedLine=function(df,dr,dg,dm){var ds=dm<<16;dm+=128;for(var dl=df-1;dl>=0;dl--){var dk=dg[dr];var dh=(dk)&16711680;var dt=(dk)&65280;var dq=(dk)&255;var dj=dh+ds;dj=CLAMP_R(dj);var dp=dt*dm>>7;dp=CLAMP_G(dp);var dn=dq*dm>>7;dn=CLAMP_B(dn);var di=dj|dp|dn;dg[dr]=di;dr++}return dr};e.gradientYellowLine=function(df,dr,dh,dm){var ds=dm<<16;var du=dm<<8;dm+=128;for(var dl=df-1;dl>=0;dl--){var dk=dh[dr];var dg=(dk)&16711680;var dt=(dk)&65280;var dq=(dk)&255;var dj=dg+ds;dj=CLAMP_R(dj);var dp=dt+du;dp=CLAMP_G(dp);var dn=(dq*dm)>>7;dn=CLAMP_B(dn);var di=dj|dp|dn;dh[dr]=di;dr++}return dr};e.gradientWhiteLine=function(df,dr,dg,dm){dm+=128;for(var dl=df-1;dl>=0;dl--){var dk=dg[dr];var dh=(dk)&16711680;var ds=(dk)&65280;var dq=(dk)&255;var dj=dh*dm>>7;dj=CLAMP_R(dj);var dp=ds*dm>>7;dp=CLAMP_G(dp);var dn=dq*dm>>7;dn=CLAMP_B(dn);var di=dj|dp|dn;dg[dr]=di;dr++}return dr};e.gradientRBlurLine=function(dg,dn,dh,dl){var dm=0;var df=0;for(var dk=dg-1;dk>=0;dk--){var dj=dh[dn];var dp=(dj)&16711935;var dq=(dj)&65280;dm=(dp+((dm-dp)*(dl)>>7))&16711935;df=(dq+((df-dq)*(dl)>>7))&65280;var di=dm|df;dh[dn]=di;dn++}return dn};e.gradientLBlurLine=function(dg,dn,dh,dl){var dm=0;var df=0;dn+=dg-1;for(var dk=dg-1;dk>=0;dk--){var dj=dh[dn];var dp=(dj)&16711935;var dq=(dj)&65280;dm=(dp+((dm-dp)*(dl)>>7))&16711935;df=(dq+((df-dq)*(dl)>>7))&65280;var di=dm|df;dh[dn]=di;dn--}dn+=dg;return dn};e.gradientRRewindLine=function(dg,dr,di,dm){var dp=0;var df=0;var dn=dm+128;for(var dl=dg-1;dl>=0;dl--){var dk=di[dr];var dh=(dk)&16711680;var dt=(dk)&65280;var dq=(dk)&255;dh=dh*dn>>7;dh=CLAMP_R(dh);dt=dt*dn>>7;dt=CLAMP_G(dt);dq=dq*dn>>7;dq=CLAMP_B(dq);var ds=dh|dq;dp=(ds+((dp-ds)*(dm)>>7))&16711935;df=(dt+((df-dt)*(dm)>>7))&65280;var dj=dp|df;di[dr]=dj;dr++}return dr};e.gradientLRewindLine=function(dg,dr,di,dm){var dp=0;var df=0;var dn=dm+128;dr+=dg-1;for(var dl=dg-1;dl>=0;dl--){var dk=di[dr];var dh=(dk)&16711680;var dt=(dk)&65280;var dq=(dk)&255;dh=dh*dn>>7;dh=CLAMP_R(dh);dt=dt*dn>>7;dt=CLAMP_G(dt);dq=dq*dn>>7;dq=CLAMP_B(dq);var ds=dh|dq;dp=(ds+((dp-ds)*(dm)>>7))&16711935;df=(dt+((df-dt)*(dm)>>7))&65280;var dj=dp|df;di[dr]=dj;dr--}dr+=dg;return dr};e.paintVerticalGradientEffect=function(dk,dg,dl,dj,df,dh,di){this.paintVerticalGradientEffect(dk,dg,dl,dj,df,dh,di,0,df)};e.paintVerticalGradientEffect=function(dz,dp,dn,dw,du,dk,dg,dr,dB){try{var dD=ASprite.transform_int;var dq=((GLLibConfig.TMP_BUFFER_SIZE/dw)&(~1));var dm=80;var dy=0;var df=0;var dj=0;var dh=2;if(dg==e.k_gradientLBlur||dg==e.k_gradientRBlur){dh=1}var dv=0;var dt=false;while(!dt){dm=du-dv;if(dm>dq){dm=dq}else{dt=true}var di=0;var dl=-1;var ds=0;for(var dx=0;dx<dm;dx+=dh){var dC=Math_FixedPoint_Multiply(dk,Math_Sin((dv+dx+dr)*Math_Angle180/dB));dC=Math.abs(dC);dC=dC&(~7);if((dC>>4)==0){di+=dw*dh;continue}else{if(dl<0){dl=dx}ds=dx}if(dg==e.k_gradientRed){di=gradientRedLine(dw,di,dD,dC)}else{if(dg==e.k_gradientYellow){di=gradientYellowLine(dw,di,dD,dC)}else{if(dg==e.k_gradientWhite){di=gradientWhiteLine(dw,di,dD,dC)}else{if(dg==e.k_gradientRBlur){di=gradientRBlurLine(dw,di,dD,dC)}else{if(dg==e.k_gradientLBlur){di=gradientLBlurLine(dw,di,dD,dC)}else{if(dg==e.k_gradientRRewind){di=gradientRRewindLine(dw,di,dD,dC)}else{if(dg==e.k_gradientLRewind){di=gradientLRewindLine(dw,di,dD,dC)}}}}}}}if(dh>1){di+=dw}}if(dl>=0){dz.drawRGB(dD,dl*dw,dw,dp,dn+dv+dl,dw,ds-dl+1,false)}dv+=dm}}catch(dA){if(DEF.dbgEnable){Dbg("-------------------- error : "+dA.message)}}};e.s_swarmSprite=null;e.s_splashSprite=null;e.s_bloodSprite=null;e.s_rainSprite=null;e.s_swarmFrame=0;e.s_swarmDir=0;e.s_swarmStrength=0;e.s_swarmBoxer=0;e.s_useBlood=false;e.s_bloodAnim=0;e.s_bloodScreenX=0;e.s_bloodScreenY=0;e.s_dustFrame=0;e.s_dustDummyId=0;e.s_dustSprite=null;e.s_dustBoxer=0;e.k_dust1=0;e.s_flashType=0;e.s_flashFrame=0;e.s_flashDummyId=0;e.s_flashBoxer=0;e.s_flashInForeground=false;e.k_effectShockwave=0;e.k_effectColorShockwave=1;e.s_effectSprite=null;e.s_effectAnim=0;e.s_effectType=0;e.s_effectFrame=0;e.s_effectDummyId=0;e.s_effectBoxer=0;e.s_effectInForeground=false;e.s_hitMarks=null;e.s_hitMarkPalette=0;e.s_hitMarkX=0;e.s_hitMarkY=0;e.s_hitMarkZ=0;e.s_hitMarkAnim=0;e.s_hitMarkFrame=0;e.k_fadeIn=0;e.k_fadeOut=1;e.s_fadeType=0;e.s_fadeDuration=0;e.s_fadeTime=0;e.k_cinematicBarsHeight=45;e.initDustEffect=function(dg,df){s_dustFrame=0;s_dustDummyId=df;s_dustBoxer=dg};e.initSwarmEffect=function(df,dh,dg){s_swarmFrame=0;s_swarmDir=df;s_swarmStrength=dh;s_swarmBoxer=dg;e.s_useBlood=false;if(false){s_swarmSprite.SetCurrentPalette(1);e.s_useBlood=true}else{s_swarmSprite.SetCurrentPalette(0)}s_bloodAnim=Math_Rand(0,s_bloodSprite._anims_naf.length);s_bloodScreenX=Math_Rand(0,0+DEF.VIEW_W);s_bloodScreenY=Math_Rand(0,DEF.VIEW_H)};e.initFlashEffect=function(dh,di,dg,df){s_flashFrame=0;s_flashType=dh;s_flashBoxer=dg;s_flashDummyId=df;e.s_flashInForeground=di};e.initEffect=function(dh,dj,di,dg,df){s_effectFrame=0;s_effectAnim=dj;s_effectType=dh;s_effectBoxer=dg;s_effectDummyId=df;e.s_effectInForeground=di};e.updateEffects=function(){};e.s_cinematicFrame=0;e.k_directionLeft=0;e.k_directionRight=1;e.k_directionFwd=2;e.k_strengthStrong=3;e.paintSwarmEffect=function(di,dk,df,dm){var dj=0;var dh=0;if(s_swarmFrame>=0&&s_swarmFrame<100&&dk==true){di.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);if(s_swarmDir==e.k_directionLeft){dj=0}else{if(s_swarmDir==e.k_directionRight){dj=1}else{if(s_swarmDir==e.k_directionFwd){dj=2}}}if(s_swarmStrength==e.k_strengthStrong){dj+=3}var dg=s_swarmSprite.GetAFrames(dj);if(s_swarmFrame<dg){s_swarmSprite.PaintAFrame(di,dj,s_swarmFrame,df,dm,0)}else{if(true){if(e.s_useBlood){var dl=s_swarmFrame-dg;if(dl>=0&&dl<s_bloodSprite.GetAFrames(s_bloodAnim)){s_bloodSprite.PaintAFrame(di,s_bloodAnim,dl,s_bloodScreenX,s_bloodScreenY,0)}else{s_swarmFrame=100}}else{var dl=s_swarmFrame-dg;if(dl>=0&&dl<s_splashSprite.GetAFrames(0)){s_splashSprite.PaintAFrame(di,0,dl,0,0,0)}else{s_swarmFrame=100}}}else{s_swarmFrame=100}}s_swarmFrame++;resetClip(di)}};e.paintDustEffect=function(dh,di,df,dj){if(s_dustFrame>=0&&s_dustFrame<100&&di==true){dh.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);var dg=s_dustSprite.GetAFrames(e.k_dust1);if(s_dustFrame<dg){s_dustSprite.PaintAFrame(dh,e.k_dust1,s_dustFrame,df,dj,0)}else{s_dustFrame=100}resetClip(dh);s_dustFrame++}};e.paintFlashEffect=function(dh,di,dg,dk){if(false){s_flashFrame=100;return}if(e.s_flashInForeground==di){if(s_flashFrame>=0&&s_flashFrame<7){dh.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);var df=DEF.SCR_H/3;var dj=dk-df/2;paintVerticalGradientEffect(dh,0,dj,DEF.VIEW_W,df,(15-s_flashFrame*2)<<3,s_flashType);s_flashFrame++;resetClip(dh)}}};e.paintShockwaveEffect=function(di,dj,df,dk){var dh=0;if(e.s_effectInForeground==dj){if(s_effectType==e.k_effectShockwave){dh=CBlendSprite.BLEND_DISPLACEMENT}else{if(s_effectType==e.k_effectColorShockwave){dh=CBlendSprite.BLEND_COLOR_DISPLACEMENT}}var dg=s_effectSprite.GetAFrames(s_effectAnim);if(s_effectFrame>=0&&s_effectFrame<dg){di.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);s_effectSprite._blend=dh;s_effectSprite.PaintAFrame(di,s_effectAnim,s_effectFrame,df,dk,0);s_effectFrame++;resetClip(di)}else{s_effectFrame=100}}};e.paintHitMarkEffect=function(dg,dh,df,di){if(dh==true&&e.s_hitMarkAnim>=0){dg.setClip(0,0,DEF.VIEW_W,DEF.VIEW_H);s_hitMarks.SetCurrentPalette(e.s_hitMarkPalette);s_hitMarks.PaintAFrame(dg,e.s_hitMarkAnim,e.s_hitMarkFrame,df,di,0);e.s_hitMarkFrame+=2;if(e.s_hitMarkFrame>=s_hitMarks.GetAFrames(e.s_hitMarkAnim)){e.s_hitMarkAnim=-1}resetClip(dg)}};e.paintCinematicEffects=function(df,dg){if(dg==true){if(false){e.s_cinematicFrame+=5}else{e.s_cinematicFrame-=5}if(e.s_cinematicFrame>e.k_cinematicBarsHeight){e.s_cinematicFrame=e.k_cinematicBarsHeight}if(e.s_cinematicFrame<0){e.s_cinematicFrame=0}if(e.s_cinematicFrame>0){resetClip(df);df.setColor(0);df.fillRect(0,0,DEF.VIEW_W,e.s_cinematicFrame);df.fillRect(0,DEF.SCR_H-e.s_cinematicFrame,DEF.VIEW_W,e.s_cinematicFrame)}}};e.paintEffects=function(df,dg){if((s_game_currentFrameNB%60)==0){initDustEffect(0,0)}if((s_game_currentFrameNB%20)==0){initFlashEffect(1,true,0,0)}if((s_game_currentFrameNB%80)==0){initEffect(e.k_effectShockwave,0,true,0,0)}if((s_game_currentFrameNB%20)==0){e.s_hitMarkAnim=Math_Rand(0,4);e.s_hitMarkFrame=0}paintCinematicEffects(df,dg)};e.speed1=1;e.s1=24;e.speed2=3;e.s2=42;e.speed3=1;e.s3=90;e.speed4=4;e.s4=50;e._shine_pos=[[e.s1+0*e.speed1,e.s1+1*e.speed1,-1,e.s1+3*e.speed1,e.s1+4*e.speed1,e.s1+5*e.speed1,-1,e.s1+7*e.speed1,-1,e.s1+7*e.speed1,e.s1+6*e.speed1,e.s1+5*e.speed1,-1,e.s1+3*e.speed1,e.s1+2*e.speed1,-1],[e.s2-0*e.speed2,e.s2-1*e.speed2,e.s2-2*e.speed2,e.s2-3*e.speed2,e.s2-4*e.speed2,e.s2-5*e.speed2,e.s2-6*e.speed2,e.s2-7*e.speed2,e.s2-8*e.speed2,e.s2-7*e.speed2,e.s2-6*e.speed2,e.s2-5*e.speed2,e.s2-4*e.speed2,e.s2-3*e.speed2,e.s2-2*e.speed2,e.s2-1*e.speed2,e.s2-0*e.speed2,e.s2+1*e.speed2,e.s2+2*e.speed2,e.s2+1*e.speed2],[e.s3-0*e.speed3,e.s3-1*e.speed3,e.s3-2*e.speed3,e.s3-3*e.speed3,e.s3-4*e.speed3,e.s3-5*e.speed3,e.s3-6*e.speed3,e.s3-7*e.speed3,e.s3-8*e.speed3,e.s3-7*e.speed3,e.s3-6*e.speed3,e.s3-5*e.speed3,e.s3-4*e.speed3,e.s3-3*e.speed3,e.s3-2*e.speed3,e.s3-1*e.speed3,e.s3-0*e.speed3,e.s3+1*e.speed3],[e.s4+0*e.speed4,e.s4+1*e.speed4,e.s4+2*e.speed4,e.s4+3*e.speed4,e.s4+4*e.speed4,e.s4+5*e.speed4,e.s4+4*e.speed4,e.s4+3*e.speed4,e.s4+3*e.speed4,e.s4+1*e.speed4,e.s4+0*e.speed4,e.s4-1*e.speed4,e.s4-2*e.speed4,e.s4-3*e.speed4,e.s4-4*e.speed4,e.s4-5*e.speed4,e.s4-6*e.speed4,e.s4-7*e.speed4,e.s4-8*e.speed4,e.s4-7*e.speed4,e.s4-6*e.speed4,e.s4-5*e.speed4,e.s4-4*e.speed4,e.s4-3*e.speed4,e.s4-2*e.speed4,e.s4-1*e.speed4]];e._shineImgs=null;e.USE_EFFECT_IMAGE=true;e._shine_4444=null;e._shine_area=[[44,107,68,107,26],[34,93,52,93,26]];e.DrawShine=function(dg,df){for(var di=0;di<_shine_pos.length;++di){var dh=s_game_currentFrameNB%(_shine_pos[di].length);var dj=_shine_pos[di][dh];if(dj>=0){if(e.USE_EFFECT_IMAGE){g.drawImage(_shineImgs[di],dg,dj+df,0)}else{}}}_shine_pos[3][0]+=1;if(_shine_pos[3][0]>90){_shine_pos[3][0]=-50}};e.InitShineEffect=function(){_shine_4444=LowAPI.Gen_Array([4],null);if(e.USE_EFFECT_IMAGE){_shineImgs=new Image[6];var df;df=LowAPI.Gen_Array([44*34],0);Bresenham_Line_8888(0,0,44,24,180,0,10,df,44);_shineImgs[0]=Image.createRGBImage(df,44,34,true);df=LowAPI.Gen_Array([107*93],0);Bresenham_Line_8888(0,0,107,53,85,0,40,df,107);_shineImgs[1]=Image.createRGBImage(df,107,93,true);df=LowAPI.Gen_Array([68*52],0);Bresenham_Line_8888(0,0,68,32,120,0,20,df,68);_shineImgs[2]=Image.createRGBImage(df,68,52,true);_shineImgs[3]=_shineImgs[1];df=LowAPI.Gen_Array([26*26],0);Bresenham_Line_8888(0,0,26,26,0,250,1,df,26);_shineImgs[4]=Image.createRGBImage(df,26,26,true);df=LowAPI.Gen_Array([24*72],0);Bresenham_Line_8888(0,0,0,71,0,250,24,df,24);_shineImgs[5]=Image.createRGBImage(df,24,72,true);df=null}else{_shine_4444[0]=LowAPI.Gen_Array([44*34],0);Bresenham_Line_4444(0,0,44,24,180,0,10,_shine_4444[0],44);_shine_4444[1]=LowAPI.Gen_Array([107*93],0);Bresenham_Line_4444(0,0,107,53,85,0,40,_shine_4444[1],107);_shine_4444[2]=LowAPI.Gen_Array([68*52],0);Bresenham_Line_4444(0,0,68,32,120,0,20,_shine_4444[2],68);_shine_4444[3]=_shine_4444[1]}};e.Bresenham_Line_4444=function(dz,dh,dw,dg,dt,dr,ds,dm,df){var dq=dw-dz;var dp=dg-dh;var dA=dq>0?-dq:dq;var dj=dq>0?1:-1;var dn=dz;var dl=dh;var dk=dh*df+dz;dt<<=8;dr<<=8;var dC=(dr-dt)/dq;for(var dv=0;dv<dq;dv++){var di=dk;var dB=((dt)|4090);var du=0;for(;du<ds;++du){dm[di]=dB;di+=df}dt+=dC;dn+=dj;dk+=dj;dA+=dp<<1;if(dA>=0){dl++;dk+=df;dA-=dq<<1}}};e.Bresenham_Line_8888=function(dz,dh,dw,dg,dt,dr,ds,dn,df){var dq=dw-dz;var dp=dg-dh;if(dq==0){var dk=dh*df+dz;dt<<=8;dr<<=8;var dC=(dr-dt)/dp;for(var dv=0;dv<dp;dv++){var dj=dk;var du=0;var dB;for(;du<4;++du){dB=((((dt/5*(du+1))&65280)<<16)|16776268);dn[dj]=dB;++dj}dB=(((dt&65280)<<16)|16776268);for(;du<ds-4;++du){dn[dj]=dB;++dj}for(;du<ds;++du){dB=(((((dt/5*(ds-du)))&65280)<<16)|16776268);dn[dj]=dB;++dj}dt+=dC;dk+=df}}else{var dA=dq>0?-dq:dq;var di=dq>0?1:-1;var dm=dz;var dl=dh;var dk=dh*df+dz;dt<<=8;dr<<=8;var dC=(dr-dt)/dq;for(var dv=0;dv<dq;dv++){var dj=dk;var dB=((dt<<16)|14408370);var du=0;for(;du<ds;++du){dn[dj]=dB;dj+=df}dt+=dC;dm+=di;dk+=di;dA+=dp<<1;if(dA>=0){dl++;dk+=df;dA-=dq<<1}}}};e.resetClip=function(df){df.setClip(0,0,DEF.SCR_W,DEF.SCR_H)};e._rbg_buffer_data=null;e._rgb_buffer_last_color=0;e.RGB_BUFFER_SIZE=64;e._rgb_buffer_img=null;e.FillArgbRect=function(dg,dj,di,df,dh){FillArgbRect(dg,dj,di,df,dh)};e.DrawArgbLine=function(dh,dk,dg,di,df){var dj=LowAPI.Gen_Array([4],0);dj[0]=g.getClipX();dj[1]=g.getClipY();dj[2]=g.getClipWidth();dj[3]=g.getClipHeight();g.setColor(df);g.drawLine(dh,dk,dg,di);SetClip(dj[0],dj[1],dj[2],dj[3])};e.DrawBresenhamLine=function(dl,dr,dq,dw,dg,dv,df,dt){var dp=dv-dw;var dn=df-dg;var dz=-Math.abs(dp);var di=dp>0?1:-1;var dm=dw;var dk=dg;var dj=dg*dr+dw;for(var du=0;du<dp;du++){var dh=dj;var ds=0;for(;ds<dr;++ds){dl[dh]=dt;dh+=dr}dm+=di;dj+=di;dz+=dn<<1;if(dz>=0){dk++;dj+=dr;dz-=dp<<1}}};e.RotateImage=function(dA,df,dw,dm,dk,dh,dL){var dl=df+dw;var dC=dl;var dF=dl/2;var dJ=LowAPI.Gen_Array([dl*dC],0);var ds,dM;ds=Math_Sin(dh);dM=Math_Cos(dh);var dg=dM<<8;var dn=ds<<8;var dG=-ds<<8;var dI=dM<<8;var dK=dm;var dp=dk;var dj=dw/2;var dB=dF;var dt=((-(dK+dj)*dM+(dp+dB)*ds)<<8)+(dK<<16);var dz=((-(dK+dj)*ds-(dp+dB)*dM)<<8)+(dp<<16);var dN=(dt);var dD=(dz);var di=0;for(var dx=0;dx<dC;++dx){var dE=dN;var dH=dD;for(var dy=0;dy<dl;++dy){var dv=(dE>>16);var du=(dH>>16);var dq=(dv>=0)&&(dv<df)&&(du>=0)&&(du<dw);if(dq){dJ[di]=dA[du*df+dv]}di++;dE+=dg;dH+=dn}dN+=dG;dD+=dI}dL[0]=dm-dF;dL[1]=dk-dF;dL[2]=dl;dL[3]=dC;return dJ};e.MINI_MAP_STATE_OUT_LEVEL=0;e.MINI_MAP_STATE_NEW_LEVEL_OPEN=1;e.MINI_MAP_STATE_NEW_GAME=2;e.MINI_MAP_STATE_NEW_WORLD=3;e.MINI_MAP_STATE_CURSOR_MOVE_AUTO=4;e.MINI_MAP_STATE_IDLE=5;e.MINI_MAP_STATE_HERO_MOVE_TO=6;e.MINI_MAP_STATE_SWITCH_TO_LEVEL_ROOM=7;e.MINI_MAP_STATE_SWITCH_TO_WORLD_ROOM=8;e.MINI_MAP_STATE_ARE_YOU_SURE=9;e.MINI_MAP_STATE_ENTER_LEVEL=10;e.MINI_MAP_STATE_OVER=11;e.MINI_MAP_ALPHA_PAL=7;e.MINI_MAP_BOSS_ENABLE_PAL=6;e._miniMapState=e.MINI_MAP_STATE_IDLE;e._miniMapTick=0;e._miniMapLimit=null;e._miniMapLimitWorldRoom=[0,0,20*DEF.TILE_W,DEF.SCR_H];e._miniMapLimitLevelRoom=[22*DEF.TILE_W,0,38*DEF.TILE_W,DEF.SCR_H];e._miniMapRoomPoint=[DEF.TILE_W*5,DEF.TILE_H*12,DEF.TILE_W*3,DEF.TILE_H*9,DEF.TILE_W*17,DEF.TILE_H*9,DEF.TILE_W*15,DEF.TILE_H*12,DEF.TILE_W*10,DEF.TILE_H*7+DEF.TILE_H_D2,DEF.TILE_W*30,DEF.TILE_H*13,DEF.TILE_W*30,DEF.TILE_H*7+DEF.TILE_H_D2,DEF.TILE_W*25,DEF.TILE_H*9,DEF.TILE_W*35,DEF.TILE_H*9,DEF.TILE_W*30,DEF.TILE_H*10+DEF.TILE_H_D2,];e.MINI_MAP_WORLD_ROOM_POINTS_INDEX=0;e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX=10;e.MINI_MAP_BOSS_LEVEL_ROOM_INDEX=18;e.MINI_MAP_BOSS_WORLD_ROOM_INDEX=8;e._miniMapCameraX=0;e._miniMapCameraY=0;e._miniMapHeroX=0;e._miniMapHeroY=0;e._miniMapHeroAnim=0;e._miniMapHeroFlags=0;e._miniMapHeroAtPoint=-1;e._miniMapCursorX=0;e._miniMapCursorY=0;e._miniMapCursorAtPoint=-1;e._miniMapNewLevelOpened=1;e._miniMapWorldIconAlpha=255;e._miniMapWorldIconAlphaStep=8;e._previousLevelID=-1;e.MINI_MAP_OFFSET_Y=2*DEF.TILE_H;e.MINI_MAP_CURSOR_VELOCITY=8*DScreen.RATIO;e.MINI_MAP_HERO_MOVE_VELOCITY=8*DScreen.RATIO;e.MINI_MAP_WATCH_SPEAK_TICK=15;e.MINI_MAP_WATCH_DISAPPEAR_TICK=20;e.MINI_MAP_WATCH_OVER_TICK=25;e.MINI_MAP_DOOR_LOCKED=0;e.MINI_MAP_DOOR_OPENED=1;e.MINI_MAP_DOOR_UNLOCKED=2;e.CheckMiniMapLimit=function(){e._miniMapCameraX=Math.max(e._miniMapCameraX,e._miniMapLimit[DEF.BOX_LEFT]);e._miniMapCameraY=Math.max(e._miniMapCameraY,e._miniMapLimit[DEF.BOX_TOP]);e._miniMapCameraX=Math.min(e._miniMapCameraX,e._miniMapLimit[DEF.BOX_RIGHT]-DEF.VIEW_W);e._miniMapCameraY=Math.min(e._miniMapCameraY,e._miniMapLimit[DEF.BOX_BOTTOM]-DEF.VIEW_H);e._miniMapCursorX=Math.max(e._miniMapCursorX,e._miniMapLimit[DEF.BOX_LEFT]);e._miniMapCursorY=Math.max(e._miniMapCursorY,e._miniMapLimit[DEF.BOX_TOP]);e._miniMapCursorX=Math.min(e._miniMapCursorX,e._miniMapLimit[DEF.BOX_RIGHT]);e._miniMapCursorY=Math.min(e._miniMapCursorY,e._miniMapLimit[DEF.BOX_BOTTOM]-e.MINI_MAP_OFFSET_Y)};e.LevelId2PointId=function(dg){var df=(dg)%DAI.LEVELS_NUM_PRE_WORLD;df=df*2+e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX+2;return df};e.IsUnlockedWorld=function(df){if(df>=DAI.WORLD_ID_CASTLE*DAI.LEVELS_NUM_PRE_WORLD){return true}if(e._gameProgress==bl){return true}if(df>=DAI.WORLD_ID_CASTLE*DAI.LEVELS_NUM_PRE_WORLD){return true}if(df<0){return true}if(df==0){return false}return df%DAI.LEVELS_NUM_PRE_WORLD==0};e.GetLevelUnlocked=function(){for(var df=0;df<e._levelInfo.length;df++){if(e._levelInfo[df]==0){return df-1}}return -1};e._miniMapLoadStep=0;e.MINI_MAP_LOADING_STEP=10;e.GotoMiniMap=function(){e.StopSound(DSound_Channel.BGM);Q=false;if(e._miniMapLoadStep<e.MINI_MAP_LOADING_STEP){e.DrawSpecialEffect_Load_Unload_MiniMap(e._miniMapLoadStep);e.LoadMiniMap();e._miniMapLoadStep++;return}e._miniMapLoadStep=0;GLLibPlayer.Tileset_SetCamera(0,e._miniMapCameraX,e._miniMapCameraY);e._levelUnlocked=e.GetLevelUnlocked();e._worldId=Math.floor((e._levelUnlocked-1)/DAI.LEVELS_NUM_PRE_WORLD);e._worldId=e._worldId<0?0:e._worldId;if(e._gameProgress==bl){e._worldId=-1}if(e.IsUnlockedWorld(e._levelUnlocked)){e._miniMapLimit=e._miniMapLimitWorldRoom;var df=e._worldId<<1;df=Math.min(df,e.MINI_MAP_BOSS_WORLD_ROOM_INDEX);var dg=0;if(e._gameProgress==bl){df=DAI.WORLD_ID_SPACE<<1;dg=-2*DEF.TILE_W}e._miniMapHeroX=e._miniMapRoomPoint[df]+dg;e._miniMapHeroY=e._miniMapRoomPoint[df+1];e._miniMapHeroAtPoint=df}else{e._miniMapLimit=e._miniMapLimitLevelRoom;var df=e.LevelId2PointId(e._tempLevelId);e._miniMapHeroX=e._miniMapRoomPoint[df];e._miniMapHeroY=e._miniMapRoomPoint[df+1];e._miniMapHeroAtPoint=df}e._miniMapCursorX=e._miniMapHeroX;e._miniMapCursorY=e._miniMapHeroY-DEF.TILE_H;e._miniMapCameraX=e._miniMapCursorX-DEF.VIEW_W_D2;e._miniMapCameraY=e._miniMapCursorY-DEF.VIEW_H_D2;e._miniMapCursorAtPoint=-1;e._miniMapState=e.MINI_MAP_STATE_OUT_LEVEL;e._miniMapTick=0;e.SetPause(DPauseType.FADE_IN,DPauseType.FADE_EFFECT_CIRCLE);bi=STATE.MENU_MAP;e.loadingPhase=0;e._miniMapHeroAnim=0;e._miniMapHeroFlags=0;e.PlaySoundBGM();e.bIsPaused=false};e.prototype.SetVelocityByDest=function(dh,dg,df){var di=Math_Atan(dg,df);CEntity._TempIntArray[DParamIndex.POSX]=Math_FixedPoint_Multiply(dh,Math_Cos(di));CEntity._TempIntArray[DParamIndex.POSY]=Math_FixedPoint_Multiply(dh,Math_Sin(di));if(!Math_SameSign(CEntity._TempIntArray[DParamIndex.POSX],dg)||Math.abs(CEntity._TempIntArray[DParamIndex.POSX])>Math.abs(dg)){CEntity._TempIntArray[DParamIndex.POSX]=dg}if(!Math_SameSign(CEntity._TempIntArray[DParamIndex.POSY],df)||Math.abs(CEntity._TempIntArray[DParamIndex.POSY])>Math.abs(df)){CEntity._TempIntArray[DParamIndex.POSY]=df}};e.prototype.UpdateMiniMap=function(){if(bq){e.initIngameMenu(STATE.MENU_INGAME);return}switch(e._miniMapState){case e.MINI_MAP_STATE_OUT_LEVEL:ar=e._miniMapHeroX-e._miniMapCameraX;aq=e._miniMapHeroY-e._miniMapCameraY;this.PauseUpdate();if(cT==DPauseType.NONE){if(e._gameProgress==bl){e._miniMapState=e.MINI_MAP_STATE_NEW_GAME}else{if(e._levelUnlocked>=0){e._miniMapState=e.MINI_MAP_STATE_NEW_LEVEL_OPEN}else{e._miniMapState=e.MINI_MAP_STATE_IDLE}}}break;case e.MINI_MAP_STATE_NEW_LEVEL_OPEN:var du=e.spriteArray[DSpriteID.EFFECT].GetAFrames(DAnimID.EFFECT_RANDOM_MAGIC);if(e._miniMapTick<du&&e._levelUnlocked>=0){e._miniMapTick++}else{e._miniMapState=e.MINI_MAP_STATE_CURSOR_MOVE_AUTO;e._miniMapTick=0}break;case e.MINI_MAP_STATE_NEW_GAME:switch(e._miniMapTick){case 0:e.StartTextBubble(-1,Math_IntToFixedPoint(e._miniMapHeroX),Math_IntToFixedPoint(e._miniMapHeroY+DEF.TILE_H*2),TEXT.MENU_MINI_BOY_1);e._miniMapTick++;break;case 1:if(e._textBubbleState==e.TEXT_BUBBLE_OVER){e._miniMapTick=0;e._miniMapState=e.MINI_MAP_STATE_CURSOR_MOVE_AUTO}break}if(WasKeyReleased(GLKey.k_menuBack)){e.CloseTextBubble();e._miniMapTick=0;e._miniMapState=e.MINI_MAP_STATE_CURSOR_MOVE_AUTO}break;case e.MINI_MAP_STATE_NEW_WORLD:if(e._miniMapTick==e.MINI_MAP_WATCH_SPEAK_TICK){e.StartTextBubble(-1,Math_IntToFixedPoint(e._miniMapRoomPoint[(e._worldId+1)<<1]),Math_IntToFixedPoint(e._miniMapRoomPoint[((e._worldId+1)<<1)+1]+DEF.TILE_H*2),this.GetLevelWizardTextByWorldId(e._worldId));e._miniMapTick++}else{if(e._miniMapTick>e.MINI_MAP_WATCH_OVER_TICK){e._miniMapState=e.MINI_MAP_STATE_HERO_MOVE_TO;e._miniMapTick=0}else{if(e._miniMapTick>e.MINI_MAP_WATCH_SPEAK_TICK){if(e._textBubbleState==e.TEXT_BUBBLE_OVER){e._miniMapTick++}}else{e._miniMapTick++}}}if(WasKeyReleased(GLKey.k_menuBack)){e.CloseTextBubble();e._miniMapTick=0;e._miniMapState=e.MINI_MAP_STATE_HERO_MOVE_TO}break;case e.MINI_MAP_STATE_CURSOR_MOVE_AUTO:var dr;var dq;var dt;if(e._miniMapLimit==e._miniMapLimitLevelRoom&&e._gameProgress==bl){dt=e.LevelId2PointId(0)}else{if(e.IsUnlockedWorld(e._levelUnlocked)){dt=(e._worldId+1)*2;dt=Math.min(dt,e.MINI_MAP_BOSS_WORLD_ROOM_INDEX)}else{dt=e.LevelId2PointId(e._levelUnlocked)}}dr=e._miniMapRoomPoint[dt];dq=e._miniMapRoomPoint[dt+1]-DEF.TILE_H;if(e._miniMapHeroAtPoint==dt){e._miniMapCursorX=dr;e._miniMapCursorY=dq;e._miniMapCursorAtPoint=dt;e._miniMapState=e.MINI_MAP_STATE_IDLE}else{this.SetVelocityByDest(e.MINI_MAP_CURSOR_VELOCITY,dr-e._miniMapCursorX,dq-e._miniMapCursorY);e._miniMapCursorX+=CEntity._TempIntArray[DParamIndex.POSX];e._miniMapCursorY+=CEntity._TempIntArray[DParamIndex.POSY];if(e._miniMapCursorX==dr&&e._miniMapCursorY==dq){e._miniMapCursorX=dr;e._miniMapCursorY=dq;e._miniMapState=e.MINI_MAP_STATE_HERO_MOVE_TO;e._miniMapCursorAtPoint=dt;if(e._miniMapLimit==e._miniMapLimitWorldRoom&&e.IsUnlockedWorld(e._levelUnlocked)){e._miniMapState=e.MINI_MAP_STATE_NEW_WORLD}}}break;case e.MINI_MAP_STATE_IDLE:var di=0;var dh=0;if(IsKeyDown(GLKey.k_left)||IsKeyDown(GLKey.k_num1)||IsKeyDown(GLKey.k_num7)){di-=e.MINI_MAP_CURSOR_VELOCITY}if(IsKeyDown(GLKey.k_right)||IsKeyDown(GLKey.k_num3)||IsKeyDown(GLKey.k_num9)){di+=e.MINI_MAP_CURSOR_VELOCITY}if(IsKeyDown(GLKey.k_up)||IsKeyDown(GLKey.k_num1)||IsKeyDown(GLKey.k_num3)){dh-=e.MINI_MAP_CURSOR_VELOCITY}if(IsKeyDown(GLKey.k_down)||IsKeyDown(GLKey.k_num7)||IsKeyDown(GLKey.k_num9)){dh+=e.MINI_MAP_CURSOR_VELOCITY}e._miniMapCursorX+=di;e._miniMapCursorY+=dh;e._miniMapCursorAtPoint=-1;var dm=e._miniMapRoomPoint.length;for(var dk=0;dk<dm;dk+=2){CEntity._tempBox[DEF.BOX_LEFT]=e._miniMapRoomPoint[dk]-DEF.TILE_W*2;CEntity._tempBox[DEF.BOX_RIGHT]=e._miniMapRoomPoint[dk]+DEF.TILE_W*2;CEntity._tempBox[DEF.BOX_TOP]=e._miniMapRoomPoint[dk+1]-(DEF.TILE_H*3);CEntity._tempBox[DEF.BOX_BOTTOM]=e._miniMapRoomPoint[dk+1]+DEF.TILE_H;if(dk==e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX){CEntity._tempBox[DEF.BOX_BOTTOM]+=DEF.TILE_H*2}if(CEntity.InBox(e._miniMapCursorX,e._miniMapCursorY,CEntity._tempBox)){e._miniMapCursorAtPoint=dk}}var df=this.MiniMapGetDoorState(e._miniMapCursorAtPoint)==e.MINI_MAP_DOOR_LOCKED;if(e._miniMapCursorAtPoint>=0&&!df&&WasKeyPressed(GLKey.k_fire)){if(e._miniMapHeroAtPoint==e._miniMapCursorAtPoint){if(e._miniMapHeroAtPoint==e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX){e._miniMapState=e.MINI_MAP_STATE_SWITCH_TO_WORLD_ROOM;e.SetPause(DPauseType.FADE_OUT,DPauseType.FADE_EFFECT_BLACK)}else{if(e._miniMapCursorAtPoint<e.MINI_MAP_BOSS_WORLD_ROOM_INDEX){e._miniMapState=e.MINI_MAP_STATE_SWITCH_TO_LEVEL_ROOM;e.SetPause(DPauseType.FADE_OUT,DPauseType.FADE_EFFECT_BLACK)}else{e._miniMapState=e.MINI_MAP_STATE_ENTER_LEVEL;e.SetPause(DPauseType.FADE_OUT,DPauseType.FADE_EFFECT_CIRCLE)}}}else{e._miniMapState=e.MINI_MAP_STATE_HERO_MOVE_TO}}break;case e.MINI_MAP_STATE_HERO_MOVE_TO:dr=e._miniMapRoomPoint[e._miniMapCursorAtPoint];dq=e._miniMapRoomPoint[e._miniMapCursorAtPoint+1];this.SetVelocityByDest(e.MINI_MAP_HERO_MOVE_VELOCITY,dr-e._miniMapHeroX,dq-e._miniMapHeroY);var dp=CEntity._TempIntArray[DParamIndex.POSX];var dn=CEntity._TempIntArray[DParamIndex.POSY];e._miniMapHeroX+=dp;e._miniMapHeroY+=dn;if(e._miniMapHeroX==dr&&e._miniMapHeroY==dq){e._miniMapHeroX=dr;e._miniMapHeroY=dq;e._miniMapHeroAnim=DAnimID.HERO_WAIT;e._miniMapHeroAtPoint=e._miniMapCursorAtPoint;e._miniMapState=e.MINI_MAP_STATE_IDLE}else{e._miniMapHeroAnim=DAnimID.HERO_WAIT;if(dp!=0||dn!=0){if(dp!=0){e._miniMapHeroAnim=DAnimID.HERO_WALK;if(dp>0){e._miniMapHeroFlags=0}else{if(dp<0){e._miniMapHeroFlags=DFlags.FLIP_X}}}else{if(dn<0){e._miniMapHeroAnim=DAnimID.HERO_IN_DOOR}else{e._miniMapHeroAnim=DAnimID.HERO_OUT_DOOR}}}}break;case e.MINI_MAP_STATE_SWITCH_TO_LEVEL_ROOM:var dl=e._miniMapCursorAtPoint>>1;var dj=dl;if(dj==0){dj=4}else{if(dj==4){dj=0}}switch(dj){case 0:e._miniMapHeroAnim=DAnimID.HERO_IN_DOOR;break;case 1:e._miniMapHeroAnim=DAnimID.HERO_WALK;e._miniMapHeroFlags|=DFlags.FLIP_X;break;case 2:e._miniMapHeroAnim=DAnimID.HERO_WALK;e._miniMapHeroFlags&=~DFlags.FLIP_X;break;case 3:case 4:e._miniMapHeroAnim=DAnimID.HERO_OUT_DOOR;break}this.PauseUpdate();if(e._miniMapLimit!=e._miniMapLimitLevelRoom){if(cT==DPauseType.NONE){e._miniMapHeroAnim=DAnimID.HERO_IN_DOOR;e._worldId=dl;e._miniMapLimit=e._miniMapLimitLevelRoom;e._miniMapHeroAtPoint=e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX;e._miniMapCursorAtPoint=e._miniMapHeroAtPoint;e._miniMapHeroX=e._miniMapRoomPoint[e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX];e._miniMapHeroY=e._miniMapRoomPoint[e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX+1]+16*DScreen.RATIO;e._miniMapCursorX=e._miniMapHeroX;e._miniMapCursorY=e._miniMapHeroY-DEF.TILE_H;e.SetPause(DPauseType.FADE_IN,DPauseType.FADE_EFFECT_BLACK)}}else{e._miniMapHeroY-=1;if(cT==DPauseType.NONE){if(e._gameProgress==bl){e._miniMapState=e.MINI_MAP_STATE_CURSOR_MOVE_AUTO}else{e._miniMapState=e.MINI_MAP_STATE_IDLE}e._miniMapHeroAnim=DAnimID.HERO_WAIT}}break;case e.MINI_MAP_STATE_SWITCH_TO_WORLD_ROOM:e._miniMapHeroAnim=DAnimID.HERO_OUT_DOOR;this.PauseUpdate();if(e._miniMapLimit!=e._miniMapLimitWorldRoom){e._miniMapHeroY+=1;if(cT==DPauseType.NONE){e._miniMapHeroAtPoint=e._worldId<<1;e._miniMapCursorAtPoint=e._miniMapHeroAtPoint;e._miniMapLimit=e._miniMapLimitWorldRoom;e._miniMapHeroX=e._miniMapRoomPoint[e._miniMapHeroAtPoint];e._miniMapHeroY=e._miniMapRoomPoint[e._miniMapHeroAtPoint+1];e._miniMapCursorX=e._miniMapHeroX;e._miniMapCursorY=e._miniMapHeroY-DEF.TILE_H;e.SetPause(DPauseType.FADE_IN,DPauseType.FADE_EFFECT_BLACK)}}else{e._miniMapHeroAnim=DAnimID.HERO_WAIT;if(cT==DPauseType.NONE){e._miniMapState=e.MINI_MAP_STATE_IDLE}}break;case e.MINI_MAP_STATE_ENTER_LEVEL:var ds=(e._miniMapCursorAtPoint-e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX)>>1;switch(ds){case 1:e._miniMapHeroAnim=DAnimID.HERO_IN_DOOR;break;case 2:e._miniMapHeroAnim=DAnimID.HERO_WALK;e._miniMapHeroFlags|=DFlags.FLIP_X;break;case 3:e._miniMapHeroAnim=DAnimID.HERO_WALK;e._miniMapHeroFlags&=~DFlags.FLIP_X;break}ar=e._miniMapHeroX-e._miniMapCameraX;aq=e._miniMapHeroY-e._miniMapCameraY;this.PauseUpdate();if(cT==DPauseType.NONE){e._miniMapState=e.MINI_MAP_STATE_OVER;e._gameProgress++;var dg=e.MiniMapGetLevelByPoint(e._miniMapCursorAtPoint);this.UnloadMiniMap();e.initMenus();e._tempLevelId=dg;e._worldId=Math.floor(dg/DAI.LEVELS_NUM_PRE_WORLD);bi=STATE.LOAD_UNLOAD;e.bIsPaused=false;e.RMS_Save()}break}e._miniMapCameraX=e._miniMapCursorX-DEF.VIEW_W_D2;e._miniMapCameraY=e._miniMapCursorY-DEF.VIEW_H_D2;e.CheckMiniMapLimit();e._miniMapWorldIconAlpha+=e._miniMapWorldIconAlphaStep;if(e._miniMapWorldIconAlpha<63){e._miniMapWorldIconAlphaStep=-e._miniMapWorldIconAlphaStep;e._miniMapWorldIconAlpha=63}else{if(e._miniMapWorldIconAlpha>255){e._miniMapWorldIconAlphaStep=-e._miniMapWorldIconAlphaStep;e._miniMapWorldIconAlpha=255}}if(e.spriteArray[DSpriteID.MAP_ACTOR]!=null){e.spriteArray[DSpriteID.MAP_ACTOR].ModifyPaletteAlpha(e.MINI_MAP_ALPHA_PAL,e._miniMapWorldIconAlpha)}};e.prototype.DrawMiniMapScene=function(dg,dv,du){for(var dn=0;dn<e._entityRowDataCount;dn++){var dl=e._entitiesRowData[dn];if(dl[DParamIndex.CLASS_ID]==DClassID.MINI_MAP_ACTOR){var ds=dl[DParamIndex.MINI_MAP_ACTOR_Z_ORDER]==DValueList.MINI_MAP_ACTOR_ORDER_BACKGROUND;var dw=dl[DParamIndex.MINI_MAP_ACTOR_Z_ORDER]==DValueList.MINI_MAP_ACTOR_ORDER_FOREGROUND;var dp=dg?ds:dw;if(dp){var df=this.MiniMapGetDoorState(dl[DParamIndex.MINI_MAP_ACTOR_POINTID]<<1);var dr=dl[DParamIndex.MINI_MAP_ACTOR_POINTID]<0||df==dl[DParamIndex.MINI_MAP_ACTOR_TYPE]||dl[DParamIndex.ANIMID]>=DAnimID.MAP_ACTOR_BOSS_1;var di=false;if(e._levelUnlocked>=0&&df==e.MINI_MAP_DOOR_UNLOCKED){if(e._miniMapState<e.MINI_MAP_STATE_NEW_LEVEL_OPEN&&e._gameProgress!=bl){dr=dl[DParamIndex.MINI_MAP_ACTOR_TYPE]==DValueList.MINI_MAP_ACTOR_TYPE_CLOSED}else{if(dl[DParamIndex.MINI_MAP_ACTOR_POINTID]<e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX>>1){dr=dl[DParamIndex.MINI_MAP_ACTOR_TYPE]==DValueList.MINI_MAP_ACTOR_TYPE_OPENED}else{if(dl[DParamIndex.MINI_MAP_ACTOR_POINTID]==e.MINI_MAP_BOSS_LEVEL_ROOM_INDEX>>1){dr=true}else{if(dl[DParamIndex.MINI_MAP_ACTOR_TYPE]==DValueList.MINI_MAP_ACTOR_TYPE_CLOSED){di=true}}}}}if(dr){if(dl[DParamIndex.ANIMID]>=DAnimID.MAP_ACTOR_ICON_LABYRINTH&&dl[DParamIndex.ANIMID]<=DAnimID.MAP_ACTOR_ICON_SPACE){e.spriteArray[DSpriteID.MAP_ACTOR].SetCurrentPalette(e.MINI_MAP_ALPHA_PAL)}else{if(dl[DParamIndex.ANIMID]>=DAnimID.MAP_ACTOR_DOOR_LEFT_UP_PASS&&dl[DParamIndex.ANIMID]<=DAnimID.MAP_ACTOR_DOOR_RIGHT_UP_PASS){e.spriteArray[DSpriteID.MAP_ACTOR].SetCurrentPalette(this.GetLevelPaletteIdByWorldId(e._worldId))}else{e.spriteArray[DSpriteID.MAP_ACTOR].SetCurrentPalette(0)}}var dk=dl[DParamIndex.ANIMID];if(dl[DParamIndex.ANIMID]>=DAnimID.MAP_ACTOR_BOSS_1){dk=Math.min(this.GetLevelMapActorBossByWorldId(e._worldId),DAnimID.MAP_ACTOR_BOSS_5);e.spriteArray[DSpriteID.MAP_ACTOR].SetCurrentPalette(this.GetLevelPaletteIdByWorldId(e._worldId));if(df!=e.MINI_MAP_DOOR_LOCKED){e.spriteArray[DSpriteID.MAP_ACTOR].SetCurrentPalette(e.MINI_MAP_BOSS_ENABLE_PAL)}}var dj=true;var dh=true;if(dj){e.DrawAnimation(DSpriteID.MAP_ACTOR,dk,dv+dl[DParamIndex.POSX]-e._miniMapCameraX,du+dl[DParamIndex.POSY]-e._miniMapCameraY,dl[DParamIndex.FLAGS])}if(dl[DParamIndex.ANIMID]==DAnimID.MAP_ACTOR_DOOR_LEFT_UP_PASS||dl[DParamIndex.ANIMID]==DAnimID.MAP_ACTOR_DOOR_RIGHT_UP_PASS||dl[DParamIndex.ANIMID]==DAnimID.MAP_ACTOR_DOOR_UP_PASS){e.DrawAnimation(DSpriteID.EFFECT,DAnimID.EFFECT_EFFECT_FEATHER,dv+dl[DParamIndex.POSX]-e._miniMapCameraX,du+dl[DParamIndex.POSY]-e._miniMapCameraY,dl[DParamIndex.FLAGS])}var dq=dl[DParamIndex.MINI_MAP_ACTOR_POINTID]==(e.MINI_MAP_BOSS_LEVEL_ROOM_INDEX>>1)||dl[DParamIndex.MINI_MAP_ACTOR_POINTID]==(e.MINI_MAP_BOSS_WORLD_ROOM_INDEX>>1);if(df!=e.MINI_MAP_DOOR_LOCKED){if(dh&&dq&&dl[DParamIndex.ANIMID]!=DAnimID.MAP_ACTOR_WORLD_DOT){di=true}}}if(di&&GLLibConfig.useSoftwareDoubleBuffer){var dt=s_game_currentFrameNB%e.blendSpriteArray[DATA.EFFECT_SPAWN].GetAFrames(DEffectAnimID.SPAWN_OBJ_SPAWN);var dk;var dm=10+DEF.TILE_H*2;dm+=e.spriteArray[DSpriteID.MAP_ACTOR].GetFrameHeight(e.spriteArray[DSpriteID.MAP_ACTOR].GetAnimFrame(dl[DParamIndex.ANIMID],0))/2;if(dl[DParamIndex.MINI_MAP_ACTOR_POINTID]==e.MINI_MAP_BOSS_LEVEL_ROOM_INDEX>>1){dm+=-10;dk=DEffectAnimID.SPAWN_HOLE_CLOCKWISE}else{if(dl[DParamIndex.MINI_MAP_ACTOR_POINTID]==e.MINI_MAP_BOSS_WORLD_ROOM_INDEX>>1){dm-=-12;dk=DEffectAnimID.SPAWN_HOLE_CLOCKWISE}else{dm-=35;dk=DEffectAnimID.SPAWN_OBJ_SPAWN}}dm-=e.MINI_MAP_OFFSET_Y;e.blendSpriteArray[DATA.EFFECT_SPAWN].PaintAFrame(g,dk,dt,dv+dl[DParamIndex.POSX]-e._miniMapCameraX,du+dl[DParamIndex.POSY]-e._miniMapCameraY+dm,0)}}}}e.spriteArray[DSpriteID.MAP_ACTOR].SetCurrentPalette(0)};e.prototype.DrawMiniMap=function(){g.setColor(0);g.setClip(0,0,DEF.SCR_W,DEF.SCR_H);g.fillRect(0,0,DEF.SCR_W,DEF.SCR_H);var dz=0;var du=e._miniMapLimit[DEF.BOX_RIGHT]-e._miniMapLimit[DEF.BOX_LEFT];if(DEF.SCR_W>du){dz=-Math.floor((DEF.SCR_W-du)/2)}if(e._miniMapState==e.MINI_MAP_STATE_OVER){return}if(e._miniMapLimit==e._miniMapLimitLevelRoom){e.spriteArray[DSpriteID.TILESET_BASE+DATA.MINI_MAP_TILESET].SetCurrentPalette(this.GetLevelPaletteIdByWorldId(e._worldId))}else{e.spriteArray[DSpriteID.TILESET_BASE+DATA.MINI_MAP_TILESET].SetCurrentPalette(0)}GLLibPlayer.Tileset_SetCamera(0,e._miniMapCameraX,e._miniMapCameraY);e._miniMapCameraY-=2*DEF.TILE_H;if(e._miniMapCameraX<0){GLLibPlayer.Tileset_Draw(g,-dz,2*DEF.TILE_H,0)}else{GLLibPlayer.Tileset_Draw(g,dz,2*DEF.TILE_H,0)}g.setColor(0);g.setClip(0,0,DEF.SCR_W,DEF.SCR_H);g.fillRect(0,0,DEF.SCR_W,2*DEF.TILE_H+1);var dm=!e.bIsPaused;if(e._miniMapState==e.MINI_MAP_STATE_NEW_WORLD&&e._miniMapTick<e.MINI_MAP_WATCH_OVER_TICK){var dD;var dB;dD=e._miniMapRoomPoint[(e._worldId+1)*2];dB=e._miniMapRoomPoint[(e._worldId+1)*2+1];var dw=dB>e._miniMapHeroY;var dr=Math.min(e._miniMapHeroY,dB);var dv=Math.max(e._miniMapHeroY,dB);this.DrawMiniMapScene(true,dz,0);if(dw){e.DrawAnimation(DSpriteID.HERO,e._miniMapHeroAnim,dz+e._miniMapHeroX-e._miniMapCameraX,e._miniMapHeroY-e._miniMapCameraY,e._miniMapHeroFlags)}else{this.DrawMiniMapWitch(dD,dB)}if(!dw){e.DrawAnimation(DSpriteID.HERO,e._miniMapHeroAnim,dz+e._miniMapHeroX-e._miniMapCameraX,e._miniMapHeroY-e._miniMapCameraY,e._miniMapHeroFlags)}else{this.DrawMiniMapWitch(dD,dB)}this.DrawMiniMapScene(false,dz,0)}else{this.DrawMiniMapScene(true,dz,0);e.DrawAnimation(DSpriteID.HERO,e._miniMapHeroAnim,dz+e._miniMapHeroX-e._miniMapCameraX,e._miniMapHeroY-e._miniMapCameraY,e._miniMapHeroFlags);this.DrawMiniMapScene(false,dz,0)}if(dz<0){g.setColor(0);g.fillRect(0,0,-dz,DEF.SCR_H);g.fillRect(-dz+du,0,Math.floor((DEF.SCR_W-du)/2),DEF.SCR_H)}if(e._textBubbleState!=e.TEXT_BUBBLE_OVER){dm=false;this.DrawTextBubble()}if(e._miniMapState==e.MINI_MAP_STATE_NEW_LEVEL_OPEN){var dp=e.spriteArray[DSpriteID.EFFECT].GetAFrames(DAnimID.EFFECT_RANDOM_MAGIC);var dk;var dj;if(e.IsUnlockedWorld(e._levelUnlocked)){dk=e._miniMapRoomPoint[(e._worldId+1)*2];dj=e._miniMapRoomPoint[(e._worldId+1)*2+1]}else{var dq=e.LevelId2PointId(e._levelUnlocked);dk=e._miniMapRoomPoint[dq];dj=e._miniMapRoomPoint[dq+1]}if(e._miniMapTick<dp&&e._levelUnlocked>=0){e.spriteArray[DSpriteID.EFFECT].PaintAFrame(g,DAnimID.EFFECT_RANDOM_MAGIC,e._miniMapTick,dz+dk-e._miniMapCameraX,dj-e._miniMapCameraY,0)}var dy=e._levelUnlocked==0&&e._levelInfo[1]==0;if(dy){e.txtDrawSpecialEffectPopUp(0,Text_GetString(TEXT.MENU_STAGE_UNLOCKED),dz+dk-e._miniMapCameraX,dj-e._miniMapCameraY-50*DScreen.RATIO,10,1,26,GRPH.HCENTER_TOP)}}var df=DAnimID.MAP_ACTOR_HAND;var dC=e.MiniMapGetLevelByPoint(e._miniMapCursorAtPoint);if(e._miniMapCursorAtPoint>=0){df=DAnimID.MAP_ACTOR_HAND_SELECTED;var dl=TEXT.MENU_LOCKED;if(dm){if(this.MiniMapGetDoorState(e._miniMapCursorAtPoint)!=e.MINI_MAP_DOOR_LOCKED){if(e._miniMapCursorAtPoint==e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX){dl=TEXT.MENU_SELECT_WORLD}else{dC=e.MiniMapGetLevelByPoint(e._miniMapCursorAtPoint);if(e._miniMapCursorAtPoint>e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX){dl=this.GetLevelTextByLevelId(dC);var di=DGUI.INTERFACE_STAR_POS_X_MINIMAP;var dh=DGUI.INTERFACE_STAR_BOTTOM_OFFSET_Y_MINIMAP;this.DrawLevelStars(dC,di,dh)}else{dl=TEXT.MENU_LABYRINTH_WORLD+(e._miniMapCursorAtPoint>=6?(e._miniMapCursorAtPoint>>1)+1:(e._miniMapCursorAtPoint>>1))}}}if(e._previousLevelID!=dC){e._actionSpeed=0;e._stopAdd=false;e._stopMove=false;e._moveSpeed=0;e._currentPosY=0;e._firstEnterIntoThisFunction=true;e._previousLevelID=dC}var dA=0;if(dl>TEXT.MENU_GHOST_TOWN&&dl!=TEXT.MENU_LOCKED||dl>=TEXT.MENU_LEVEL1&&dl<=TEXT.MENU_LEVEL24){e.txtDraw(0,Text_GetString(this.GetLevelMenuTextByLevelId(dC)),DEF.VIEW_W_D2,DGUI.CURLEVELID_Y,1);dA=25*DScreen.RATIO}else{dA=14*DScreen.RATIO}var dx=DEF.VIEW_W-20;var dt=1;var ds=0;var dn=10;var dg=5;e.DrawMultiLineText(g,Text_GetString(dl),DEF.SCR_W_D2,dA,dt,2,dx,ds,dn,dg)}}if(dm){e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_PORTRAIT_MINIMAP,DGUI.INTERFACE_HEADICON_POS_MINIMAP_X,DEF.VIEW_H-DGUI.INTERFACE_BOTTOM_HEIGHT_MINIMAP_HEAD+e.MINI_MAP_OFFSET_Y,0);e._interface.PaintFrame(g,DAnimID.INTERFACE_FRAME_X,DGUI.INTERFACE_FORK_POS_MINIMAP_X+0,DEF.VIEW_H-DGUI.INTERFACE_BOTTOM_HEIGHT_FORK_OFFSET_Y_MINIMAP+e.MINI_MAP_OFFSET_Y,0);e.DrawInterfaceNumber(e._playerInfo[DAI.HPI_LIVES],DGUI.INTERFACE_FORK_POS_MINIMAP_X+DGUI.INTERFACE_NUM_MARGIN_BEHINDFORK_MINIMAP_X,DEF.VIEW_H-DGUI.INTERFACE_BOTTOM_HEIGHT_MINIMAP_NUM+e.MINI_MAP_OFFSET_Y,2,0);if((e._miniMapCursorAtPoint>e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX)&&(e._miniMapCursorAtPoint!=e.MINI_MAP_BOSS_LEVEL_ROOM_INDEX)){e.txtDraw(0,Text_GetString(TEXT.MENU_SCORE),DEF.VIEW_W-5*DScreen.RATIO,DEF.VIEW_H-DGUI.INTERFACE_SCORE_OFFSET_Y_MINIMAP+e.MINI_MAP_OFFSET_Y,TOP|RIGHT);if(dC>=0){e.txtDraw(0,String(e._levelTotalScore[dC]),DEF.VIEW_W-5*DScreen.RATIO,DEF.VIEW_H-DGUI.INTERFACE_SCORE_NUM_OFFSET_Y_MINIMAP+e.MINI_MAP_OFFSET_Y,TOP|RIGHT)}}}if(e._miniMapState>=e.MINI_MAP_STATE_CURSOR_MOVE_AUTO){e.DrawAnimation(DSpriteID.MAP_ACTOR,df,dz+e._miniMapCursorX-e._miniMapCameraX,e._miniMapCursorY-e._miniMapCameraY,0)}if(e._textBubbleState!=e.TEXT_BUBBLE_OVER){if(!e.bIsPaused){cX.SetCurrentPalette(0);cX.DrawString(g,Text_GetString(TEXT.MENU_SK_SKIP),DEF.VIEW_W,DEF.VIEW_H,GRPH.RIGHT_BOTTOM)}}if(!e.bIsPaused){e._interface.PaintAFrame(g,DAnimID.INTERFACE_IGM,s_game_currentFrameNB%e.spriteArray[DSpriteID.INTERFACE].GetAFrames(DAnimID.INTERFACE_IGM),DGUI.INTERFACE_IGM_OFFSET_X,DEF.VIEW_H-DGUI.INTERFACE_LEFTSOFTKEY_OFFSET_Y,0)}ar+=dz;this.DrawFadeEffect();ar-=dz;e._miniMapCameraY+=e.MINI_MAP_OFFSET_Y};e.prototype.DrawMiniMapWitch=function(dr,dq){var dg=DAnimID.BOSS_WATCH_IDLE_GROUND;var dt=0;var dm=e.spriteArray[DSpriteID.BOSS_WATCH].GetAFrames(DAnimID.BOSS_WATCH_IDLE_GROUND);var dl=e.spriteArray[DSpriteID.BOSS_WATCH].GetAFrameTime(DAnimID.BOSS_WATCH_IDLE_GROUND,0);var di=e.spriteArray[DSpriteID.BOSS_WATCH].GetAFrames(DAnimID.BOSS_WATCH_IDLE_GROUND);var dh=e.spriteArray[DSpriteID.BOSS_WATCH].GetAFrameTime(DAnimID.BOSS_WATCH_IDLE_GROUND,0);var ds=e.spriteArray[DSpriteID.BOSS_WATCH].GetAFrames(DAnimID.BOSS_WATCH_IDLE_GROUND);var dn=e.spriteArray[DSpriteID.BOSS_WATCH].GetAFrameTime(DAnimID.BOSS_WATCH_IDLE_GROUND,0);var dk=e._miniMapTick;if(e._miniMapTick<di*dh){dg=DAnimID.BOSS_WATCH_APPEAR;dt=e._miniMapTick/dh%di}else{dk-=di*dh;dg=DAnimID.BOSS_WATCH_IDLE_GROUND;dt=dk/dl%dm}if(e._miniMapTick>=e.MINI_MAP_WATCH_DISAPPEAR_TICK){dk=e._miniMapTick-e.MINI_MAP_WATCH_DISAPPEAR_TICK;dg=DAnimID.BOSS_WATCH_DISAPPEAR;dt=dk/dn%ds}var df=0;if(dr-e._miniMapHeroX>0){df|=DFlags.FLIP_X}if(e._miniMapHeroX-dr>0){e._miniMapHeroFlags|=DFlags.FLIP_X}var dj=dr-e._miniMapCameraX;if(e._gameProgress==bl){dj=dr-e._miniMapCameraX+DEF.TILE_H*2}if(e._gameProgress==bl){var dp=DAnimID.GIRL_IMPRISON_MAGIC;if(dg==DAnimID.BOSS_WATCH_APPEAR){dp=DAnimID.GIRL_APPEAR}else{if(dg==DAnimID.BOSS_WATCH_DISAPPEAR){dp=DAnimID.GIRL_DISAPPEAR}}e.spriteArray[DSpriteID.GIRL].PaintAFrame(g,dp,dt,dj+DEF.TILE_H*2,dq-e._miniMapCameraY,df)}e.spriteArray[DSpriteID.BOSS_WATCH].PaintAFrame(g,dg,dt,dj,dq-e._miniMapCameraY,df)};e.MiniMapGetLevelByPoint=function(dh){if(dh<0){return -1}if(dh<e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX){var dg=(dh>>1)*DAI.LEVELS_NUM_PRE_WORLD;return dg}var df=((dh-(e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX+1))>>1);var dg=df+e._worldId*DAI.LEVELS_NUM_PRE_WORLD;return dg};e.prototype.MiniMapGetDoorState=function(dg){if(dg==e.MINI_MAP_LEVEL_ROOM_POINTS_INDEX){return e.MINI_MAP_DOOR_OPENED}else{var df=e.MiniMapGetLevelByPoint(dg);if(df<0){return e.MINI_MAP_DOOR_LOCKED}if(e._levelInfo[df]==1){if(e._levelInfo[df+1]==0){return e.MINI_MAP_DOOR_UNLOCKED}else{return e.MINI_MAP_DOOR_OPENED}}}return e.MINI_MAP_DOOR_LOCKED};e._starsCurrentPos_X=0;e._moveSpeed=0;e._stopMove=false;e.prototype.DrawLevelStars=function(dk,dl,di){var dh=[-200*DScreen.RATIO,-90*DScreen.RATIO,-10*DScreen.RATIO];if(dk<0||(dk+1)%4==0||dk==DAI.LEVEL_ID_CASTLE||dk>=DAI.LEVEL_ID_CASTLE_FINAL_BOSS){return}var df=dk*DAI.STAR_INFO_SIZE;var dj,dg;for(dj=e._levelStarInfo[df],dg=0;dj<DAI.MAX_STAR_NUM;dj++,dg++){e._starsCurrentPos_X=dh[dj]+e._moveSpeed;if(e._starsCurrentPos_X>=dl+45*dg*DScreen.RATIO){e._starsCurrentPos_X=dl+45*dg*DScreen.RATIO}e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_STAR,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_STAR),e._starsCurrentPos_X,DEF.VIEW_H-di,0)}e.spriteArray[DSpriteID.BONUS].SetCurrentPalette(1);for(dj=0;dj<e._levelStarInfo[df];dj++,dg++){e._starsCurrentPos_X=dh[dj]+e._moveSpeed;if(e._starsCurrentPos_X>=dl+45*dg*DScreen.RATIO){e._starsCurrentPos_X=dl+45*dg*DScreen.RATIO;if(dj==0){e._stopMove=true}}e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_STAR_1,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_STAR_1),e._starsCurrentPos_X,DEF.VIEW_H-di,0)}if(!e._stopMove){e._moveSpeed+=32}e.spriteArray[DSpriteID.BONUS].SetCurrentPalette(0)};e.DrawLevelStars=function(df,dn,dg){if(df==-1){df=e._tempLevelId}if(dn){var dl=DGUI.INTERFACE_STAR_POS_X_MINIMAP;var dk=DGUI.INTERFACE_STAR_BOTTOM_OFFSET_Y_MINIMAP;var dj=[-200,-90,-10];var dm=df*DAI.STAR_INFO_SIZE;var di,dh;for(di=e._levelStarInfo[dm],dh=0;di<DAI.MAX_STAR_NUM;di++,dh++){e._starsCurrentPos_X=dj[di]+e._moveSpeed;if(e._starsCurrentPos_X>=dl+45*dh){e._starsCurrentPos_X=dl+45*dh}e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_STAR,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_STAR),e._starsCurrentPos_X,DEF.VIEW_H-dk,0)}e.spriteArray[DSpriteID.BONUS].SetCurrentPalette(1);for(di=0;di<e._levelStarInfo[dm];di++,dh++){e._starsCurrentPos_X=dj[di]+e._moveSpeed;if(e._starsCurrentPos_X>=dl+45*dh){e._starsCurrentPos_X=dl+45*dh;if(di==0){e._stopMove=true}}e.spriteArray[DSpriteID.BONUS].PaintAFrame(g,DAnimID.BONUS_STAR_1,s_game_currentFrameNB%e.spriteArray[DSpriteID.BONUS].GetAFrames(DAnimID.BONUS_STAR_1),e._starsCurrentPos_X,DEF.VIEW_H-dk,0)}if(!e._stopMove){e._moveSpeed+=32}e.spriteArray[DSpriteID.BONUS].SetCurrentPalette(0)}if(dg){e.txtDraw(0,Text_GetString(TEXT.MENU_SCORE),DGUI.INTERFACE_GOLDCOIN_POS_X_MINIMAP+6,DEF.VIEW_H-DGUI.INTERFACE_SCORE_OFFSET_Y_MINIMAP+e.MINI_MAP_OFFSET_Y,GRPH.HCENTER_TOP);if(e._tempLevelId>=0){e.txtDraw(0,String(e._levelTotalScore[df]),DGUI.INTERFACE_GOLDCOIN_POS_X_MINIMAP+6,DEF.VIEW_H-DGUI.INTERFACE_SCORE_NUM_OFFSET_Y_MINIMAP+e.MINI_MAP_OFFSET_Y,GRPH.HCENTER_TOP)}}};e._fireworks_timer=0;e._timer=0;e._fireworks=null;e.RenderFireworks=function(dh){var dg;if(e._fireworks==null){e._fireworks=LowAPI.Gen_Array([FIREWORKS.MAX_NO_FIREWORKS],null);for(dg=0;dg<FIREWORKS.MAX_NO_FIREWORKS;dg++){e._fireworks[dg]=new CFirework(dg%4)}}var di=(CFirework.Rnd(FIREWORKS.MAX_ENERGY*3)>>2)+(FIREWORKS.MAX_ENERGY>>2)+1;var df=(CFirework.Rnd(FIREWORKS.PATCH_LENGHT)>>1)+(FIREWORKS.PATCH_LENGHT>>1)+1;e._fireworks_timer++;for(dg=0;dg<FIREWORKS.MAX_NO_FIREWORKS;dg++){if(e._fireworks[dg]._sleep&&e._fireworks_timer>8){e._fireworks[dg].Init(di,df,CFirework.Rnd(3)==0);e._fireworks_timer=0}e._fireworks[dg].Update()}for(dg=0;dg<FIREWORKS.MAX_NO_FIREWORKS;dg++){e._fireworks[dg].Paint(dh)}};e.PaintFireworkSprite=function(df){y.PaintAFrame(df,DAnimID.FIRE_WORK_1+CFirework.Rnd(6),s_game_currentFrameNB%y.GetAFrames(DAnimID.FIRE_WORK_1),CFirework._posX,CFirework._posY,0)};e.prototype.UnloadMiniMap=function(){e.LoadUnload(DLoadState.UNLOAD_SPRITE);CEntity.RemoveAll();e.ReleaseLevel(false)};e.LoadMiniMap=function(){if(e._miniMapLoadStep==1){e._entitiesRowData=LowAPI.Gen_Array([4000],null);e._entityRowDataCount=0;e._sprites_load_mask=DSpriteID.DEFAULT_SPRITES_LOAD_MASK|(1<<DSpriteID.BOSS_WATCH)|(1<<DSpriteID.GIRL);Pack_Open(DATA.PACK_MINI_MAP);if(DEF.dbgEnable){Dbg("loading MINI_MAP_TILESET ------------------------------")}e.spriteLoad(DATA.MINI_MAP_TILESET+DSpriteID.TILESET_BASE,DATA.MINI_MAP_TILESET,true,true);GLLibPlayer.Tileset_Init(GLLibConfig.screenWidth,GLLibConfig.screenHeight,DEF.TILE_W,DEF.TILE_H)}else{if(e._miniMapLoadStep==2){var dk;var dg=null;var dh=null;var dj=GLLibPlayer.WRAP_CLAMP;var df=DATA.MINI_MAP_MAP_SIZE;dk=Pack_ReadData(df++);dg=Pack_ReadData(df++);dh=Pack_ReadData(df++);GLLibPlayer.Tileset_LoadLayer(0,dk,dg,dh,e.spriteArray[DATA.MINI_MAP_TILESET+DSpriteID.TILESET_BASE],false,TOP,dj,dj);GLLibPlayer.Tileset_SetCamera(0,0,0);e._mapTileCountWidth=Mem_GetShort(dk,0);e._mapTileCountHeight=Mem_GetShort(dk,2)}else{if(e._miniMapLoadStep==4){e.LoadLevelData(DATA.MINI_MAP_DESIGN);Pack_Close()}else{if(e._miniMapLoadStep==5){e.LoadUnload(DLoadState.LOAD_SPRITE)}else{if(e._miniMapLoadStep==6){e.blendSpriteArray=LowAPI.Gen_Array([DATA.EFFECT_MAX],null);Pack_Open(DATA.PACK_EFFECT);if(DEF.dbgEnable){Dbg("loading effect ------------------------------- LoadMiniMap")}e.blendSpriteArray[DATA.EFFECT_SPAWN]=e.LoadSprite4(DATA.EFFECT_SPAWN,-1,true,false);e.blendSpriteArray[DATA.EFFECT_SPAWN]._blend=CBlendSprite.BLEND_DISPLACEMENT;e.blendSpriteArray[DATA.EFFECT_SPAWN].ModifyPalette(1,5904216);e.blendSpriteArray[DATA.EFFECT_SPAWN].ModifyPalette(2,525720);e.ApplyModifyPalette(e.blendSpriteArray[DATA.EFFECT_SPAWN],[1,2]);for(var di=0;di<e.spriteArray.length;di++){if(e.spriteArray[di]!=null){e.spriteArray[di].SetPool(1)}}}else{if(e._miniMapLoadStep==7){}else{if(e._miniMapLoadStep==8){}}}}}}}};e.prototype.sizeChanged=function(df,dg){};function bX(){return cP}LowAPI.extendObject(aH,{CGame:e,IsUseSystemFont:bX,},true)})(window);DLoadState={};DLoadState.LOAD_TEXT=1;DLoadState.UNLOAD_TEXT=-DLoadState.LOAD_TEXT;DLoadState.LOAD_TILESET=DLoadState.LOAD_TEXT+1;DLoadState.UNLOAD_TILESET=-DLoadState.LOAD_TILESET;DLoadState.LOAD_ENTITY=DLoadState.LOAD_TILESET+1;DLoadState.UNLOAD_ENTITY=-DLoadState.LOAD_ENTITY;DLoadState.LOAD_SEGMENT=DLoadState.LOAD_ENTITY+1;DLoadState.UNLOAD_SEGMENT=-DLoadState.LOAD_SEGMENT;DLoadState.LOAD_SPRITE=DLoadState.LOAD_SEGMENT+1;DLoadState.UNLOAD_SPRITE=-DLoadState.LOAD_SPRITE;DLoadState.LOAD_EFFECT=DLoadState.LOAD_SPRITE+1;DLoadState.UNLOAD_EFFECT=-DLoadState.LOAD_EFFECT;DLoadState.LOAD_TEXTURE=DLoadState.LOAD_EFFECT+1;DLoadState.UNLOAD_TEXTURE=-DLoadState.LOAD_TEXTURE;DLoadState.LOAD_MESH=DLoadState.LOAD_TEXTURE+1;DLoadState.UNLOAD_MESH=-DLoadState.LOAD_MESH;DLoadState.LOAD_3D_ANIMATION=DLoadState.LOAD_MESH+1;DLoadState.UNLOAD_3D_ANIMATION=-DLoadState.LOAD_3D_ANIMATION;DLoadState.LOAD_OVER=DLoadState.LOAD_3D_ANIMATION+1;DLoadState.UNLOAD_OVER=0;DLoadState.LOAD_SOUND=DLoadState.LOAD_OVER+1;DLoadState.UNLOAD_SOUND=-DLoadState.LOAD_SOUND;DLoadState.LOAD_STARTSOUND=DLoadState.LOAD_SOUND+1;DLoadState.UNLOAD_STARTSOUND=-DLoadState.LOAD_STARTSOUND;DPauseType={};DPauseType.NONE=0;DPauseType.FADE_IN=1;DPauseType.FADE_OUT=2;DPauseType.FADE_EFFECT_BLACK=0;DPauseType.FADE_EFFECT_CIRCLE=1;DPauseType.FADE_EFFECT_SCANLINE=2;DSound_Channel={};DSound_Channel.BGM=0;DSound_Channel.SFX=DSound_Channel.BGM+1;DSound_Channel.TOTAL=DSound_Channel.SFX+1;